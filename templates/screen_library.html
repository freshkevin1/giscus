{% extends "base.html" %}
{% block title %}Screen Library - Dashboard{% endblock %}
{% block mobile_title %}Screen Library{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-collection-play"></i> Screen Library</h2>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addScreenModal">
        <i class="bi bi-plus-lg"></i> Add
    </button>
</div>

<!-- Search -->
<div class="input-group mb-3">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" id="search-input" class="form-control" placeholder="Search by title...">
</div>

{% if screens %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="screen-table">
        <thead class="table-light">
            <tr>
                <th class="sortable" data-col="0" data-type="string" style="width: 40%; cursor: pointer;">
                    Title <i class="bi bi-chevron-expand text-muted sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th style="width: 8%;">Type</th>
                <th class="sortable" data-col="2" data-type="number" style="width: 13%; cursor: pointer;">
                    My Rating <i class="bi bi-chevron-expand text-muted sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th class="sortable" data-col="3" data-type="date" style="width: 12%; cursor: pointer;">
                    Date Watched <i class="bi bi-chevron-down sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th style="width: 7%;"></th>
            </tr>
        </thead>
        <tbody>
            {% for s in screens %}
            <tr class="screen-row" data-title="{{ s.title|lower }}">
                <td data-sort="{{ s.title|lower }}">
                    <div class="d-flex align-items-center gap-2">
                        {% if s.poster_url %}
                        <img src="{{ s.poster_url }}" alt="" style="height: 48px; width: 32px; object-fit: cover; border-radius: 3px; flex-shrink: 0;">
                        {% endif %}
                        <div>
                            <strong>{{ s.title }}</strong>
                            {% if s.year %}<br><small class="text-muted">{{ s.year }}</small>{% endif %}
                        </div>
                    </div>
                </td>
                <td>
                    {% if s.media_type == 'movie' %}
                    <span class="badge bg-primary">영화</span>
                    {% else %}
                    <span class="badge bg-success">드라마</span>
                    {% endif %}
                </td>
                <td data-sort="{{ s.my_rating }}">
                    <div class="star-rating" data-screen-id="{{ s.id }}" data-rating="{{ s.my_rating }}">
                        {% for i in range(1, 6) %}
                        <i class="bi bi-star{% if i <= s.my_rating %}-fill{% endif %} star-icon"
                           data-value="{{ i }}" style="cursor: pointer; color: #ffc107; font-size: 1.1rem;"></i>
                        {% endfor %}
                    </div>
                </td>
                <td data-sort="{{ s.date_watched or '' }}">
                    {% if s.date_watched and '/' in s.date_watched %}
                        {{ s.date_watched.split('/')[1] }}/{{ s.date_watched.split('/')[0] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-hall-of-fame {% if s.hall_of_fame %}btn-warning{% else %}btn-outline-secondary{% endif %}"
                            data-screen-id="{{ s.id }}" data-hof="{{ s.hall_of_fame|int }}" title="Hall of Fame">
                        <i class="bi bi-trophy{% if s.hall_of_fame %}-fill{% endif %}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete" data-screen-id="{{ s.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-collection-play" style="font-size: 3rem;"></i>
    <p class="mt-2">아직 시청 완료한 작품이 없습니다.</p>
</div>
{% endif %}

<!-- Add Screen Modal -->
<div class="modal fade" id="addScreenModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex flex-column">
                    <h5 class="modal-title">Add Movie / Drama</h5>
                    <div class="d-flex gap-1 mt-1" id="wizard-steps">
                        <span class="wizard-step active" data-step="1">1 검색</span>
                        <span class="wizard-step-sep">›</span>
                        <span class="wizard-step" data-step="2">2 선택</span>
                        <span class="wizard-step-sep">›</span>
                        <span class="wizard-step" data-step="3">3 저장</span>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Phase 1: Search -->
                <div id="phase-search">
                    <div class="input-group mb-2">
                        <input type="text" id="screen-search-input" class="form-control"
                               placeholder="영화 또는 드라마 제목 검색..." autofocus>
                        <button class="btn btn-primary" type="button" id="screen-search-btn">
                            <i class="bi bi-search"></i> 검색
                        </button>
                    </div>
                    <div class="d-flex gap-2 mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="search-type" id="type-all" value="all" checked>
                            <label class="form-check-label" for="type-all">전체</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="search-type" id="type-movie" value="movie">
                            <label class="form-check-label" for="type-movie">영화</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="search-type" id="type-tv" value="tv">
                            <label class="form-check-label" for="type-tv">드라마/TV</label>
                        </div>
                    </div>
                    <div class="text-center">
                        <a href="#" id="manual-entry-link" class="text-muted small">직접 입력하기</a>
                    </div>
                </div>

                <!-- Phase 2: Results -->
                <div id="phase-results" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-search">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted" id="results-query"></span>
                    </div>
                    <div id="search-results" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="no-results" style="display:none;" class="text-center py-4">
                        <p class="text-muted">검색 결과가 없습니다.</p>
                        <button class="btn btn-outline-primary btn-sm" id="manual-entry-btn">직접 입력하기</button>
                    </div>
                </div>

                <!-- Phase 3: Confirm & Save -->
                <div id="phase-confirm" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-results">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted">작품 정보 확인</span>
                    </div>
                    <form action="{{ url_for('screen_add') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Title</label>
                                    <input type="text" name="title" id="confirm-title" class="form-control" required>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Type</label>
                                        <select name="media_type" id="confirm-media-type" class="form-select">
                                            <option value="movie">영화</option>
                                            <option value="tv">드라마/TV</option>
                                        </select>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Year</label>
                                        <input type="number" name="year" id="confirm-year" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <img id="confirm-poster" src="" alt="" class="img-fluid rounded shadow-sm" style="max-height: 180px; display:none;">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date Watched</label>
                                <input type="date" name="date_watched" id="confirm-date" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">My Rating</label>
                                <div class="add-star-rating mt-1" id="confirm-rating-stars">
                                    {% for i in range(1, 6) %}
                                    <i class="bi bi-star star-add-icon" data-value="{{ i }}"
                                       style="cursor: pointer; color: #ffc107; font-size: 1.4rem;"></i>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="my_rating" id="confirm-rating" value="0">
                            </div>
                        </div>
                        <input type="hidden" name="tmdb_id" id="confirm-tmdb-id">
                        <input type="hidden" name="original_title" id="confirm-original-title">
                        <input type="hidden" name="poster_url" id="confirm-poster-url">
                        <input type="hidden" name="overview" id="confirm-overview">
                        <input type="hidden" name="tmdb_rating" id="confirm-tmdb-rating">
                        <input type="hidden" name="genres" id="confirm-genres">
                        <input type="hidden" name="shelf" value="watched">
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i> 저장</button>
                        </div>
                    </form>
                </div>

                <!-- Loading spinner -->
                <div id="search-loading" style="display:none;" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">검색 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Column sorting
(function() {
    const table = document.getElementById('screen-table');
    if (!table) return;
    const headers = table.querySelectorAll('th.sortable');
    let currentCol = 3;
    let ascending = false;

    headers.forEach(th => {
        th.addEventListener('click', function() {
            const col = parseInt(this.dataset.col);
            const type = this.dataset.type;
            if (currentCol === col) { ascending = !ascending; } else { ascending = true; currentCol = col; }
            headers.forEach(h => { h.querySelector('.sort-icon').className = 'bi bi-chevron-expand text-muted sort-icon'; });
            this.querySelector('.sort-icon').className = `bi bi-chevron-${ascending ? 'up' : 'down'} sort-icon`;
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const aVal = a.children[col].dataset.sort;
                const bVal = b.children[col].dataset.sort;
                let cmp = 0;
                if (type === 'number') { cmp = (parseFloat(aVal) || 0) - (parseFloat(bVal) || 0); }
                else if (type === 'date') { const aD = aVal || (ascending ? '\uffff' : ''); const bD = bVal || (ascending ? '\uffff' : ''); cmp = aD.localeCompare(bD); }
                else { cmp = aVal.localeCompare(bVal); }
                return ascending ? cmp : -cmp;
            });
            rows.forEach(row => tbody.appendChild(row));
        });
    });
})();

// Star rating
document.querySelectorAll('.star-rating').forEach(container => {
    container.querySelectorAll('.star-icon').forEach(star => {
        star.addEventListener('click', async function() {
            const screenId = this.parentElement.dataset.screenId;
            const value = parseInt(this.dataset.value);
            const current = parseInt(this.parentElement.dataset.rating);
            const newRating = (value === current) ? 0 : value;
            const resp = await fetch(`/api/screens/${screenId}/rate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating: newRating})
            });
            if (resp.ok) {
                this.parentElement.dataset.rating = newRating;
                this.closest('td').dataset.sort = newRating;
                this.parentElement.querySelectorAll('.star-icon').forEach((s, idx) => {
                    s.className = `bi bi-star${idx < newRating ? '-fill' : ''} star-icon`;
                });
            }
        });
    });
});

// Hall of Fame toggle
document.querySelectorAll('.btn-hall-of-fame').forEach(btn => {
    btn.addEventListener('click', async function() {
        const screenId = this.dataset.screenId;
        const current = this.dataset.hof === '1';
        const resp = await fetch(`/api/screens/${screenId}/hall-of-fame`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hall_of_fame: !current})
        });
        if (resp.ok) {
            const data = await resp.json();
            this.dataset.hof = data.hall_of_fame ? '1' : '0';
            const icon = this.querySelector('i');
            if (data.hall_of_fame) { icon.className = 'bi bi-trophy-fill'; this.className = 'btn btn-sm btn-hall-of-fame btn-warning'; }
            else { icon.className = 'bi bi-trophy'; this.className = 'btn btn-sm btn-hall-of-fame btn-outline-secondary'; }
        }
    });
});

// Delete
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Delete this entry?')) return;
        const screenId = this.dataset.screenId;
        const resp = await fetch(`/api/screens/${screenId}/delete`, {method: 'POST'});
        if (resp.ok) { this.closest('tr').remove(); }
    });
});

// Search filter
document.getElementById('search-input').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll('.screen-row').forEach(row => {
        row.style.display = row.dataset.title.includes(q) ? '' : 'none';
    });
});

// === Add Screen Wizard ===
(function() {
    const phaseSearch = document.getElementById('phase-search');
    const phaseResults = document.getElementById('phase-results');
    const phaseConfirm = document.getElementById('phase-confirm');
    const loading = document.getElementById('search-loading');

    const phaseStep = {search: 1, loading: 1, results: 2, confirm: 3};
    function showPhase(phase) {
        phaseSearch.style.display = phase === 'search' ? '' : 'none';
        phaseResults.style.display = phase === 'results' ? '' : 'none';
        phaseConfirm.style.display = phase === 'confirm' ? '' : 'none';
        loading.style.display = phase === 'loading' ? '' : 'none';
        const step = phaseStep[phase] || 1;
        document.querySelectorAll('.wizard-step').forEach(el => {
            el.classList.toggle('active', parseInt(el.dataset.step) === step);
        });
    }

    document.getElementById('addScreenModal').addEventListener('show.bs.modal', function() {
        showPhase('search');
        document.getElementById('screen-search-input').value = '';
        resetConfirmForm();
    });

    document.getElementById('screen-search-btn').addEventListener('click', doSearch);
    document.getElementById('screen-search-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
    });

    async function doSearch() {
        const q = document.getElementById('screen-search-input').value.trim();
        if (!q) return;
        const type = document.querySelector('input[name="search-type"]:checked').value;
        showPhase('loading');
        try {
            const resp = await fetch(`/api/screens/search?q=${encodeURIComponent(q)}&type=${type}`);
            const data = await resp.json();
            renderResults(q, data.results || []);
        } catch { renderResults(q, []); }
    }

    function renderResults(query, results) {
        document.getElementById('results-query').textContent = `"${query}" 검색 결과 (${results.length}건)`;
        const container = document.getElementById('search-results');
        const noResults = document.getElementById('no-results');
        container.innerHTML = '';
        if (results.length === 0) { container.style.display = 'none'; noResults.style.display = ''; showPhase('results'); return; }
        container.style.display = ''; noResults.style.display = 'none';
        results.forEach(item => {
            const typeLabel = item.media_type === 'movie' ? '영화' : '드라마';
            const typeColor = item.media_type === 'movie' ? 'bg-primary' : 'bg-success';
            const div = document.createElement('div');
            div.className = 'card mb-2';
            div.style.cursor = 'pointer';
            div.innerHTML = `
                <div class="card-body p-2 d-flex align-items-center">
                    <div style="width: 45px; min-width: 45px; height: 65px; margin-right: 12px;" class="d-flex align-items-center justify-content-center">
                        ${item.poster_url
                            ? `<img src="${item.poster_url}" style="max-height: 65px; max-width: 45px; border-radius: 3px;" alt="">`
                            : `<i class="bi bi-film text-muted" style="font-size: 1.5rem;"></i>`}
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="fw-bold text-truncate">${escapeHtml(item.title)}</div>
                        <div><span class="badge ${typeColor} me-1">${typeLabel}</span>${item.year ? `<small class="text-muted">${item.year}</small>` : ''}</div>
                        ${item.tmdb_rating ? `<small class="text-muted">TMDB: ${item.tmdb_rating.toFixed(1)}</small>` : ''}
                    </div>
                </div>`;
            div.addEventListener('click', () => selectScreen(item));
            container.appendChild(div);
        });
        showPhase('results');
    }

    function selectScreen(item) {
        document.getElementById('confirm-title').value = item.title || '';
        document.getElementById('confirm-title').readOnly = true;
        document.getElementById('confirm-media-type').value = item.media_type || 'movie';
        document.getElementById('confirm-year').value = item.year || '';
        document.getElementById('confirm-year').readOnly = true;
        document.getElementById('confirm-tmdb-id').value = item.tmdb_id || '';
        document.getElementById('confirm-original-title').value = item.original_title || '';
        document.getElementById('confirm-poster-url').value = item.poster_url || '';
        document.getElementById('confirm-overview').value = item.overview || '';
        document.getElementById('confirm-tmdb-rating').value = item.tmdb_rating || 0;

        const poster = document.getElementById('confirm-poster');
        if (item.poster_url) { poster.src = item.poster_url; poster.style.display = ''; }
        else { poster.style.display = 'none'; }

        document.getElementById('confirm-date').value = '';
        setAddRating(0);
        showPhase('confirm');
    }

    function openManualEntry() {
        resetConfirmForm();
        document.getElementById('confirm-title').readOnly = false;
        document.getElementById('confirm-year').readOnly = false;
        showPhase('confirm');
    }

    document.getElementById('manual-entry-link').addEventListener('click', function(e) { e.preventDefault(); openManualEntry(); });
    document.getElementById('manual-entry-btn').addEventListener('click', openManualEntry);
    document.getElementById('back-to-search').addEventListener('click', () => showPhase('search'));
    document.getElementById('back-to-results').addEventListener('click', () => showPhase('results'));

    const ratingStars = document.querySelectorAll('.star-add-icon');
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const val = parseInt(this.dataset.value);
            const current = parseInt(document.getElementById('confirm-rating').value);
            setAddRating(val === current ? 0 : val);
        });
    });

    function setAddRating(val) {
        document.getElementById('confirm-rating').value = val;
        ratingStars.forEach((s, idx) => { s.className = `bi bi-star${idx < val ? '-fill' : ''} star-add-icon`; });
    }

    function resetConfirmForm() {
        document.getElementById('confirm-title').value = '';
        document.getElementById('confirm-year').value = '';
        document.getElementById('confirm-tmdb-id').value = '';
        document.getElementById('confirm-original-title').value = '';
        document.getElementById('confirm-poster-url').value = '';
        document.getElementById('confirm-overview').value = '';
        document.getElementById('confirm-tmdb-rating').value = '0';
        document.getElementById('confirm-poster').style.display = 'none';
        setAddRating(0);
    }

    function escapeHtml(text) {
        const div = document.createElement('div'); div.textContent = text; return div.innerHTML;
    }
})();
</script>
{% endblock %}
