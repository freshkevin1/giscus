{% extends "base.html" %}
{% block title %}AI Book Recommendations - Dashboard{% endblock %}
{% block mobile_title %}AI Book Advisor{% endblock %}

{% block content %}
<div class="d-flex flex-column book-chat-container">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-1"><i class="bi bi-chat-dots"></i> AI Book Advisor</h2>
            <p class="text-muted mb-0" style="font-size: 0.85rem;">
                읽은 책을 기반으로 맞춤 추천을 받아보세요. 자유롭게 질문하세요!
            </p>
        </div>
        <button id="btn-new-chat" class="btn btn-outline-secondary btn-sm" onclick="clearChat()">
            <i class="bi bi-arrow-counterclockwise"></i> 새 대화
        </button>
    </div>

    <!-- Chat Messages Area -->
    <div id="chat-messages" class="flex-grow-1 overflow-auto mb-3 p-3 bg-white rounded shadow-sm">
        <div id="welcome-msg" class="text-center text-muted py-5">
            <i class="bi bi-robot" style="font-size: 3rem;"></i>
            <p class="mt-2 mb-1">안녕하세요! AI 북 어드바이저입니다.</p>
            <p style="font-size: 0.9rem;">
                "경영 관련 책 추천해줘", "최근 읽은 책과 비슷한 소설 추천" 등<br>
                자유롭게 질문해 보세요.
            </p>
        </div>
    </div>

    <!-- Input Area -->
    <div class="bg-white rounded shadow-sm p-3">
        <form id="chat-form" class="d-flex gap-2">
            <input type="text" id="chat-input" class="form-control"
                   placeholder="책 추천을 요청하세요..." autocomplete="off">
            <button type="submit" id="btn-send" class="btn btn-primary px-4" style="white-space: nowrap;">
                <i class="bi bi-send"></i> 전송
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .chat-bubble {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        line-height: 1.5;
        word-wrap: break-word;
        white-space: pre-wrap;
    }
    .chat-bubble-user {
        background-color: #0d6efd;
        color: #fff;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }
    .chat-bubble-ai {
        background-color: #f0f2f5;
        color: #212529;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }
    .rec-card {
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
    }
    .rec-card .badge {
        font-size: 0.75rem;
    }
    .btn-save {
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
    }
    .btn-save.saved {
        background-color: #198754;
        border-color: #198754;
        color: #fff;
        pointer-events: none;
    }
    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 0.75rem 1rem;
        background-color: #f0f2f5;
        border-radius: 12px;
        border-bottom-left-radius: 4px;
        width: fit-content;
        margin-bottom: 0.75rem;
    }
    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #8b929a;
        border-radius: 50%;
        animation: typing 1.2s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-6px); }
    }
</style>

<script>
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const chatInput = document.getElementById('chat-input');
const btnSend = document.getElementById('btn-send');

function scrollToBottom() {
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeWelcome() {
    const w = document.getElementById('welcome-msg');
    if (w) w.remove();
}

function addUserBubble(text) {
    removeWelcome();
    const div = document.createElement('div');
    div.className = 'd-flex';
    div.innerHTML = `<div class="chat-bubble chat-bubble-user">${escapeHtml(text)}</div>`;
    chatMessages.appendChild(div);
    scrollToBottom();
}

function addTypingIndicator() {
    const div = document.createElement('div');
    div.id = 'typing';
    div.className = 'd-flex';
    div.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`;
    chatMessages.appendChild(div);
    scrollToBottom();
}

function removeTypingIndicator() {
    const el = document.getElementById('typing');
    if (el) el.remove();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addAIBubble(message, recommendations) {
    removeWelcome();
    const wrapper = document.createElement('div');
    wrapper.className = 'd-flex flex-column';

    // Text message
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble chat-bubble-ai';
    bubble.textContent = message;
    wrapper.appendChild(bubble);

    // Recommendation cards
    if (recommendations && recommendations.length > 0) {
        const recsContainer = document.createElement('div');
        recsContainer.style.maxWidth = '80%';
        recsContainer.style.marginBottom = '0.75rem';

        recommendations.forEach((rec, idx) => {
            const card = document.createElement('div');
            card.className = 'rec-card';
            card.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>${escapeHtml(rec.title)}</strong>
                        ${rec.category ? `<span class="badge bg-info text-dark ms-2">${escapeHtml(rec.category)}</span>` : ''}
                    </div>
                    <button class="btn btn-outline-primary btn-save btn-sm ms-2"
                            onclick="saveBook(this)"
                            data-title="${escapeHtml(rec.title).replace(/"/g, '&quot;')}"
                            data-author="${escapeHtml(rec.author).replace(/"/g, '&quot;')}"
                            data-reason="${escapeHtml(rec.reason).replace(/"/g, '&quot;')}"
                            data-category="${escapeHtml(rec.category).replace(/"/g, '&quot;')}">
                        <i class="bi bi-bookmark"></i> 찜하기
                    </button>
                </div>
                <div class="text-muted" style="font-size: 0.85rem;">${escapeHtml(rec.author)}</div>
                <div style="font-size: 0.85rem; margin-top: 0.25rem;">${escapeHtml(rec.reason)}</div>
            `;
            recsContainer.appendChild(card);
        });

        wrapper.appendChild(recsContainer);
    }

    chatMessages.appendChild(wrapper);
    scrollToBottom();
}

async function saveBook(btn) {
    const title = btn.dataset.title;
    const author = btn.dataset.author;
    const reason = btn.dataset.reason;
    const category = btn.dataset.category;

    try {
        const resp = await fetch('/api/books/saved', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({title, author, reason, category}),
        });
        if (resp.ok) {
            btn.innerHTML = '<i class="bi bi-bookmark-fill"></i> 찜 완료';
            btn.classList.add('saved');
            btn.classList.remove('btn-outline-primary');
        }
    } catch (err) {
        console.error('Save failed:', err);
    }
}

async function loadChatHistory() {
    try {
        const resp = await fetch('/api/books/chat/history');
        if (!resp.ok) return;
        const data = await resp.json();
        if (data.messages && data.messages.length > 0) {
            removeWelcome();
            data.messages.forEach(msg => {
                if (msg.role === 'user') {
                    addUserBubble(msg.content);
                } else {
                    addAIBubble(msg.content, msg.recommendations || []);
                }
            });
        }
    } catch (err) {
        console.error('Failed to load chat history:', err);
    }
}

async function clearChat() {
    if (!confirm('대화 기록을 모두 삭제하고 새 대화를 시작하시겠습니까?')) return;
    try {
        const resp = await fetch('/api/books/chat/clear', {method: 'POST'});
        if (resp.ok) {
            // Reset UI
            chatMessages.innerHTML = `
                <div id="welcome-msg" class="text-center text-muted py-5">
                    <i class="bi bi-robot" style="font-size: 3rem;"></i>
                    <p class="mt-2 mb-1">안녕하세요! AI 북 어드바이저입니다.</p>
                    <p style="font-size: 0.9rem;">
                        "경영 관련 책 추천해줘", "최근 읽은 책과 비슷한 소설 추천" 등<br>
                        자유롭게 질문해 보세요.
                    </p>
                </div>`;
        }
    } catch (err) {
        console.error('Clear chat failed:', err);
    }
}

chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    const message = chatInput.value.trim();
    if (!message) return;

    chatInput.value = '';
    btnSend.disabled = true;

    addUserBubble(message);
    addTypingIndicator();

    try {
        const resp = await fetch('/api/books/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: message }),
        });

        removeTypingIndicator();

        if (resp.ok) {
            const data = await resp.json();
            addAIBubble(data.message, data.recommendations);
        } else {
            const err = await resp.json();
            addAIBubble('오류가 발생했습니다: ' + (err.message || 'Unknown error'), []);
        }
    } catch (err) {
        removeTypingIndicator();
        addAIBubble('네트워크 오류가 발생했습니다. 다시 시도해 주세요.', []);
    }

    btnSend.disabled = false;
    chatInput.focus();
});

// Load persisted chat history on page load
loadChatHistory();
</script>
{% endblock %}
