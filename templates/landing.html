{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block mobile_title %}Dashboard{% endblock %}

{% block content %}
<!-- ===== HABIT LOG ===== -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-lightning-charge-fill text-warning"></i>
        <span class="fw-semibold">Habit Log</span>
        <small class="text-muted ms-auto">{{ today_str }}</small>
      </div>
      <div class="card-body">
        {% for habit in habits_data %}
        <div class="habit-item" data-habit="{{ habit.name | e }}">
          <!-- ìƒë‹¨: ì´ë¦„ + ë°°ì§€ + ë²„íŠ¼ -->
          <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
            <span class="fw-semibold flex-grow-1" style="font-size:0.95rem">{{ habit.name }}</span>
            <span class="badge bg-warning text-dark streak-badge">ğŸ”¥ {{ habit.streak }}ì¼ ì—°ì†</span>
            <span class="badge bg-secondary total-badge">ì´ {{ habit.total }}ì¼</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">1ë…„ í‰ê·  {{ habit.yearly_avg }}ê±´</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ habit.monthly_avg }}ê±´</span>
            <span class="badge bg-primary" style="font-size:0.72rem">ì´ë²ˆì£¼ {{ habit.weekly_count }}ê±´</span>
            <button class="btn btn-sm habit-toggle-btn
              {% if habit.today_done %}btn-success{% else %}btn-outline-primary{% endif %}"
              onclick="toggleHabit(this)">
              {% if habit.today_done %}<i class="bi bi-check-lg"></i> ì™„ë£Œ{% else %}ê¸°ë¡í•˜ê¸°{% endif %}
            </button>
          </div>
          <!-- í•˜ë‹¨: 7ì¼ ë°” ì°¨íŠ¸ -->
          <div class="d-flex gap-1 align-items-end" style="height:48px">
            {% for day in habit.days %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
              <div class="rounded-top habit-bar
                {% if day.done %}bg-primary{% else %}bg-secondary bg-opacity-25{% endif %}
                {% if day.is_today %}habit-bar-today{% endif %}"
                style="width:100%;height:{% if day.done %}28px{% else %}8px{% endif %}"
                title="{{ day.date }} ({{ day.weekday }}){% if day.done %} âœ“{% endif %}">
              </div>
              <small class="text-muted mt-1" style="font-size:9px">{{ day.weekday }}</small>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- ì—°ë½ ì£¼ê°„ í™œë™ í†µê³„ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-bar-chart-line"></i>
        <span class="fw-semibold">ì—°ë½ í™œë™ Â· ìµœê·¼ 7ì¼</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ë…„ í‰ê·  {{ contact_yearly_avg }}ê±´</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ contact_monthly_avg }}ê±´</span>
        <span class="badge bg-primary">ì´ë²ˆ ì£¼ {{ weekly_total }}ê±´</span>
    </div>
    <div class="card-body">
        <!-- ìš”ì•½ ì§€í‘œ -->
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary fs-6">ì „ì²´ ì—°ë½ì²˜ {{ total_contacts }}ëª…</span>
            <span class="badge bg-danger fs-6">FU0 ê¸´ê¸‰ {{ fu0_count }}ëª…</span>
            <span class="badge bg-warning text-dark fs-6">ê¸°í•œ ì´ˆê³¼ {{ overdue_count }}ëª…</span>
        </div>
        <!-- CSS ë§‰ëŒ€ ì°¨íŠ¸ (Habit Log ìŠ¤íƒ€ì¼) -->
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in weekly_stats %}
            {% set bar_px = (s.count / max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}ê±´">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Article ì£¼ê°„ ì½ê¸° í†µê³„ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-journal-text"></i>
        <span class="fw-semibold">Article í†µê³„ Â· ìµœê·¼ 7ì¼</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ë…„ í‰ê·  {{ article_yearly_avg }}ê±´</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ article_monthly_avg }}ê±´</span>
        <span class="badge bg-primary">ì´ë²ˆ ì£¼ {{ article_weekly_total }}ê±´</span>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary fs-6">ì˜¤ëŠ˜ ì½ìŒ {{ article_today_count }}ê°œ</span>
        </div>
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in article_weekly_stats %}
            {% set bar_px = (s.count / article_max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}ê°œ">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('daily_news') }}" class="btn btn-sm btn-outline-primary">
            ê¸°ì‚¬ ë³´ê¸° <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0 fw-semibold">Executive Dashboard</h4>
    <a href="/?fresh=1" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </a>
</div>

<div class="row g-4 mb-4">
    <!-- ì—°ë½ Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-clipboard-check"></i>
                <span class="fw-semibold">ì—°ë½ Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ top5|length }}ëª…</span>
            </div>
            <div class="card-body p-0">
                {% if top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì†Œì†</th>
                                <th>Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in top5 %}
                            <tr{% if c.days_overdue is defined %} class="table-danger"{% endif %}>
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or 'â€”' }}</td>
                                <td>
                                    <span class="badge
                                        {% if c.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif c.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif c.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ c.follow_up_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ c.follow_up_date or 'â€”' }}
                                    {% if c.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ c.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ c.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-4 d-block mb-1"></i>
                    Follow-up ëŒ€ê¸° ì¤‘ì¸ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ì—°ë½ì²˜ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-briefcase"></i>
                <span class="fw-semibold">ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ entity_top5|length }}ê±´</span>
            </div>
            <div class="card-body p-0">
                {% if entity_top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>BP</th>
                                <th>FU Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in entity_top5 %}
                            <tr{% if e.days_overdue is defined %} class="table-danger"{% endif %}>
                                <td class="fw-medium">{{ e.name }}</td>
                                <td>
                                    <span class="badge
                                        {% if e.business_priority == '0-Critical' %}bg-danger
                                        {% elif e.business_priority == '1-High' %}bg-warning text-dark
                                        {% elif e.business_priority == '2-Medium' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.business_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if e.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif e.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif e.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.follow_up_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ e.follow_up_date or 'â€”' }}
                                    {% if e.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ e.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ e.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-briefcase fs-4 d-block mb-1"></i>
                    Follow-up ëŒ€ìƒ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('business_opportunities_page') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ì…ì‚¬ í›„ë³´ì -->
<div class="row g-4 mb-4">
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-person-badge"></i>
                <span class="fw-semibold">ì…ì‚¬ í›„ë³´ì</span>
                <span class="badge bg-primary ms-auto">{{ incoming|length }}ëª…</span>
            </div>
            <div class="card-body p-0">
                {% if incoming %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì†Œì†</th>
                                <th>ì…ì‚¬ ì˜ˆì •ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in incoming %}
                            <tr>
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or 'â€”' }}</td>
                                <td class="small">{{ c.follow_up_date or 'â€”' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-person-x fs-4 d-block mb-1"></i>
                    ì…ì‚¬ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ì—°ë½ì²˜ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Books I am reading -->
<div class="card">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-book-half"></i>
        <span class="fw-semibold">Books I am reading</span>
        <span class="badge bg-success ms-auto">{{ reading_books|length }}ê¶Œ</span>
    </div>
    <div class="card-body">
        {% if reading_books %}
        <div class="row g-3">
            {% for book in reading_books %}
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="d-flex align-items-start gap-2 p-2 border rounded">
                    <i class="bi bi-bookmark-fill text-success mt-1 flex-shrink-0"></i>
                    <div class="min-w-0">
                        <div class="fw-medium text-truncate">{{ book.title }}</div>
                        <div class="text-muted small">{{ book.author }}</div>
                        {% if book.added_at %}
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ì¶”ê°€: {{ book.added_at.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3">
            <i class="bi bi-book fs-4 d-block mb-1"></i>
            í˜„ì¬ ì½ê³  ìˆëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        {% endif %}
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('book_reading') }}" class="btn btn-sm btn-outline-success">
            Reading ëª©ë¡ <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleHabit(btn) {
    const item = btn.closest('.habit-item');
    const habitName = item.dataset.habit;
    btn.disabled = true;

    fetch('/api/habits/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({habit_name: habitName})
    })
    .then(r => r.json())
    .then(data => {
        const done = data.action === 'done';
        btn.className = 'btn btn-sm habit-toggle-btn ' + (done ? 'btn-success' : 'btn-outline-primary');
        btn.innerHTML = done ? '<i class="bi bi-check-lg"></i> ì™„ë£Œ' : 'ê¸°ë¡í•˜ê¸°';
        item.querySelector('.streak-badge').textContent = 'ğŸ”¥ ' + data.streak + 'ì¼ ì—°ì†';
        item.querySelector('.total-badge').textContent = 'ì´ ' + data.total + 'ì¼';
        const bars = item.querySelectorAll('.habit-bar');
        data.days.forEach((day, i) => {
            bars[i].className = 'rounded-top habit-bar ' +
                (day.done ? 'bg-primary' : 'bg-secondary bg-opacity-25') +
                (day.is_today ? ' habit-bar-today' : '');
            bars[i].style.height = day.done ? '28px' : '8px';
        });
        btn.disabled = false;
    })
    .catch(() => { btn.disabled = false; });
}
</script>
{% endblock %}
