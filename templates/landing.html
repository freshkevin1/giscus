{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block mobile_title %}Dashboard{% endblock %}

{% block content %}
<!-- ===== ANKI DUE WIDGET ===== -->
<style>
@keyframes ankiSlideIn {
    from { opacity: 0; transform: translateY(-8px); }
    to   { opacity: 1; transform: translateY(0); }
}
.anki-strip {
    display: flex;
    align-items: center;
    gap: 1.25rem;
    padding: 0.85rem 1.25rem;
    margin-bottom: 1.5rem;
    border-radius: 10px;
    border-left: 3px solid var(--color-accent);
    background: rgba(232, 168, 56, 0.07);
    box-shadow: var(--shadow-sm);
    animation: ankiSlideIn 0.3s ease-out both;
    text-decoration: none;
}
.anki-strip--done {
    border-left-color: #22c55e;
    background: rgba(34, 197, 94, 0.06);
}
[data-bs-theme="dark"] .anki-strip {
    background: rgba(232, 168, 56, 0.08);
}
[data-bs-theme="dark"] .anki-strip--done {
    background: rgba(34, 197, 94, 0.07);
}
.anki-count {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-accent);
    line-height: 1;
    flex-shrink: 0;
}
.anki-count-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-top: 2px;
}
.anki-divider {
    width: 1px;
    align-self: stretch;
    background: var(--color-accent);
    opacity: 0.25;
    flex-shrink: 0;
}
.anki-preview {
    flex: 1;
    min-width: 0;
}
.anki-preview-source {
    font-size: 0.72rem;
    color: var(--text-muted);
    letter-spacing: 0.03em;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.anki-preview-text {
    font-family: 'Fraunces', Georgia, serif;
    font-size: 0.95rem;
    font-style: italic;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    opacity: 0.85;
}
.anki-cta {
    flex-shrink: 0;
    padding: 7px 16px;
    border: none;
    border-radius: 7px;
    background: var(--color-accent);
    color: #1a1d23;
    font-size: 0.82rem;
    font-weight: 600;
    text-decoration: none;
    transition: opacity 0.15s;
    white-space: nowrap;
    cursor: pointer;
}
.anki-cta:hover { opacity: 0.85; color: #1a1d23; }
.anki-done-text {
    font-size: 0.9rem;
    color: #22c55e;
    font-weight: 600;
}
.anki-done-sub {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 2px;
}
.anki-modal-card {
    min-height: 160px;
    padding: 1.75rem 2rem;
    border-radius: 12px;
    border: 2px solid rgba(0,0,0,0.08);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
}
.anki-modal-card:hover { background: var(--surface-overlay, #f0ece6); }
[data-bs-theme="dark"] .anki-modal-card { border-color: rgba(255,255,255,0.1); }
[data-bs-theme="dark"] .anki-modal-card:hover { background: rgba(255,255,255,0.05); }
.anki-modal-face {
    font-family: 'Fraunces', Georgia, serif;
    font-size: 1.05rem;
    line-height: 1.65;
    text-align: center;
    white-space: pre-wrap;
    word-break: break-word;
}
.anki-rate-btn {
    flex: 1;
    max-width: 110px;
    padding: 8px 4px;
    border: none;
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    color: #fff;
    cursor: pointer;
    line-height: 1.3;
    transition: opacity 0.15s;
}
.anki-rate-btn:hover { opacity: 0.85; }
.anki-rate-btn:disabled { opacity: 0.5; cursor: default; }
.anki-rate-again { background: #ef4444; }
.anki-rate-hard  { background: #f97316; }
.anki-rate-good  { background: #22c55e; }
.anki-rate-easy  { background: #3b82f6; }
.anki-highlight-header {
    width: 100%;
    margin-bottom: 0.75rem;
    text-align: center;
}
.anki-highlight-badge {
    display: inline-block;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--color-accent, #e8a838);
    margin-bottom: 4px;
}
.anki-highlight-source {
    font-size: 0.78rem;
    color: var(--text-muted);
    font-style: italic;
}
.anki-rate-delete {
    background: #6b7280;
    max-width: 44px;
    padding: 8px 6px;
}
.anki-rate-delete:hover { background: #ef4444; opacity: 1; }
</style>

{% if anki_due_count > 0 %}
<div class="anki-strip">
    <div class="text-center">
        <div class="anki-count">{{ anki_due_count }}</div>
        <div class="anki-count-label">cards due</div>
    </div>
    <div class="anki-divider"></div>
    {% if anki_first_card %}
    <div class="anki-preview">
        <div class="anki-preview-source">{{ anki_first_card.front.split('|')[0] | trim }}</div>
        <div class="anki-preview-text">
            {{ anki_first_card.back[:90] }}{% if anki_first_card.back|length > 90 %}â€¦{% endif %}
        </div>
    </div>
    {% endif %}
    <button type="button" class="anki-cta" data-bs-toggle="modal" data-bs-target="#ankiReviewModal">
        âš¡ Review Now
    </button>
</div>
{% else %}
<div class="anki-strip anki-strip--done">
    <div>
        <div class="anki-done-text"><i class="bi bi-check-circle-fill"></i> All caught up for today</div>
        <div class="anki-done-sub">ë‹¤ìŒ ë³µìŠµì€ ë‚´ì¼ â€” <a href="{{ url_for('anki_hub') }}" class="text-muted">ë± ë³´ê¸°</a></div>
    </div>
</div>
{% endif %}

<!-- ===== HABIT LOG ===== -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-lightning-charge-fill text-warning"></i>
        <span class="fw-semibold">Habit Log</span>
        <small class="text-muted ms-auto">{{ today_str }}</small>
      </div>
      <div class="card-body">
        {% for habit in habits_data %}
        <div class="habit-item" data-habit="{{ habit.name | e }}">
          <!-- ìƒë‹¨: ì´ë¦„ + ë°°ì§€ + ë²„íŠ¼ -->
          <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
            <span class="fw-semibold flex-grow-1" style="font-size:0.95rem">{{ habit.name }}</span>
            <span class="badge bg-warning text-dark streak-badge">ğŸ”¥ {{ habit.streak }}ì¼ ì—°ì†</span>
            <span class="badge bg-secondary total-badge">ì´ {{ habit.total }}ì¼</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">1ë…„ í‰ê·  {{ habit.yearly_avg }}ê±´</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ habit.monthly_avg }}ê±´</span>
            <span class="badge bg-primary" style="font-size:0.72rem">ì´ë²ˆì£¼ {{ habit.weekly_count }}ê±´</span>
            <button class="btn btn-sm habit-toggle-btn
              {% if habit.today_done %}btn-success{% else %}btn-outline-primary{% endif %}"
              onclick="toggleHabit(this)">
              {% if habit.today_done %}<i class="bi bi-check-lg"></i> ì™„ë£Œ{% else %}ê¸°ë¡í•˜ê¸°{% endif %}
            </button>
          </div>
          <!-- í•˜ë‹¨: 7ì¼ ë°” ì°¨íŠ¸ -->
          <div class="d-flex gap-1 align-items-end" style="height:48px">
            {% for day in habit.days %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
              <div class="rounded-top habit-bar
                {% if day.done %}bg-primary{% else %}bg-secondary bg-opacity-25{% endif %}
                {% if day.is_today %}habit-bar-today{% endif %}"
                style="width:100%;height:{% if day.done %}28px{% else %}8px{% endif %}"
                title="{{ day.date }} ({{ day.weekday }}){% if day.done %} âœ“{% endif %}">
              </div>
              <small class="text-muted mt-1" style="font-size:9px">{{ day.weekday }}</small>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- ì—°ë½ ì£¼ê°„ í™œë™ í†µê³„ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-bar-chart-line"></i>
        <span class="fw-semibold">ì—°ë½ í™œë™ Â· ìµœê·¼ 7ì¼</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ë…„ í‰ê·  {{ contact_yearly_avg }}ê±´</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ contact_monthly_avg }}ê±´</span>
        <span class="badge bg-primary">ì´ë²ˆ ì£¼ {{ weekly_total }}ê±´</span>
    </div>
    <div class="card-body">
        <!-- KPI ì§€í‘œ ì¹´ë“œ -->
        <div class="row g-2 mb-3">
            <div class="col-4">
                <div class="kpi-stat">
                    <div class="kpi-value">{{ total_contacts }}</div>
                    <div class="kpi-label">ì „ì²´ ì—°ë½ì²˜</div>
                </div>
            </div>
            <div class="col-4">
                <div class="kpi-stat kpi-stat--danger">
                    <div class="kpi-value">{{ fu0_count }}</div>
                    <div class="kpi-label">FU0 ê¸´ê¸‰</div>
                </div>
            </div>
            <div class="col-4">
                <div class="kpi-stat kpi-stat--warning">
                    <div class="kpi-value">{{ overdue_count }}</div>
                    <div class="kpi-label">ê¸°í•œ ì´ˆê³¼</div>
                </div>
            </div>
        </div>
        <!-- CSS ë§‰ëŒ€ ì°¨íŠ¸ (Habit Log ìŠ¤íƒ€ì¼) -->
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in weekly_stats %}
            {% set bar_px = (s.count / max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}ê±´">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Article ì£¼ê°„ ì½ê¸° í†µê³„ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-journal-text"></i>
        <span class="fw-semibold">Article í†µê³„ Â· ìµœê·¼ 7ì¼</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ë…„ í‰ê·  {{ article_yearly_avg }}ê±´</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ article_monthly_avg }}ê±´</span>
        <span class="badge bg-primary">ì´ë²ˆ ì£¼ {{ article_weekly_total }}ê±´</span>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary fs-6">ì˜¤ëŠ˜ ì½ìŒ {{ article_today_count }}ê°œ</span>
        </div>
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in article_weekly_stats %}
            {% set bar_px = (s.count / article_max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}ê°œ">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('daily_news') }}" class="btn btn-sm btn-outline-primary">
            ê¸°ì‚¬ ë³´ê¸° <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<!-- ì¹­ì°¬ ê¸°ë¡ ì¹´ë“œ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-chat-heart"></i>
        <span class="fw-semibold">ì¹­ì°¬ ê¸°ë¡ Â· ìµœê·¼ 7ì¼</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ë…„ í‰ê·  {{ compliment_yearly_avg }}ê±´</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">í•œë‹¬ í‰ê·  {{ compliment_monthly_avg }}ê±´</span>
        <span class="badge bg-primary">ì´ë²ˆ ì£¼ {{ compliment_weekly_total }}ê±´</span>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
            <span class="badge bg-secondary fs-6">ì˜¤ëŠ˜ {{ compliment_today_count }}ê±´</span>
            <span class="text-muted" style="font-size:0.85rem">
                {% for i in range(3) %}
                    {% if i < compliment_today_count %}â—{% else %}â—‹{% endif %}
                {% endfor %}
                ëª©í‘œ 3ê±´
            </span>
            <span class="badge bg-light text-dark border ms-auto">ëˆ„ì  {{ total_compliments }}ê±´</span>
        </div>
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in compliment_weekly_stats %}
            {% set bar_px = (s.count / compliment_max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-success
                    {% else %}bg-success bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}ê±´">
                </div>
                <small class="{% if s.is_today %}fw-bold text-success{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-footer text-end">
        <button class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addComplimentModal">
            <i class="bi bi-plus-lg"></i> ì¹­ì°¬ ì¶”ê°€
        </button>
    </div>
</div>

<!-- ì¹­ì°¬ ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addComplimentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-chat-heart"></i> ì¹­ì°¬ ê¸°ë¡í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ì¹­ì°¬ë°›ì€ ì‚¬ëŒ</label>
                    <input type="text" class="form-control" id="complimentRecipient" placeholder="ì´ë¦„ (ì˜ˆ: ì—„ë§ˆ, ë™ë£Œ ê¹€ì”¨)">
                </div>
                <div class="mb-3">
                    <label class="form-label">ì¹­ì°¬ ë‚´ìš©</label>
                    <textarea class="form-control" id="complimentContent" rows="3" placeholder="ì–´ë–¤ ì¹­ì°¬ì„ í–ˆë‚˜ìš”?"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">ë‚ ì§œ</label>
                    <input type="date" class="form-control" id="complimentDate" value="{{ today_str_iso }}">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" id="saveComplimentBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0 fw-semibold">Executive Dashboard</h4>
    <a href="/?fresh=1" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </a>
</div>

<div class="row g-4 mb-4">
    <!-- ì—°ë½ Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-clipboard-check"></i>
                <span class="fw-semibold">ì—°ë½ Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ top5|length }}ëª…</span>
            </div>
            <div class="card-body p-0">
                {% if top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì†Œì†</th>
                                <th>Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in top5 %}
                            <tr
                                class="{% if c.days_overdue is defined %}table-danger {% endif %}{% if c.name_hmac %}quickview-row quickview-contact-row{% endif %}"
                                {% if c.name_hmac %}
                                data-contact-id="{{ c.name_hmac }}"
                                role="button"
                                tabindex="0"
                                title="í´ë¦­í•´ì„œ í¸ì§‘"
                                aria-label="{{ c.name }} ì—°ë½ì²˜ í¸ì§‘"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or 'â€”' }}</td>
                                <td>
                                    <span class="badge
                                        {% if c.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif c.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif c.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ c.follow_up_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ c.follow_up_date or 'â€”' }}
                                    {% if c.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ c.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ c.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-4 d-block mb-1"></i>
                    Follow-up ëŒ€ê¸° ì¤‘ì¸ ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ì—°ë½ì²˜ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-briefcase"></i>
                <span class="fw-semibold">ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ entity_top5|length }}ê±´</span>
            </div>
            <div class="card-body p-0">
                {% if entity_top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>BP</th>
                                <th>FU Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in entity_top5 %}
                            <tr
                                class="{% if e.days_overdue is defined %}table-danger {% endif %}{% if e.entity_hmac %}quickview-row quickview-entity-row{% endif %}"
                                {% if e.entity_hmac %}
                                data-entity-id="{{ e.entity_hmac }}"
                                role="button"
                                tabindex="0"
                                title="í´ë¦­í•´ì„œ í¸ì§‘"
                                aria-label="{{ e.name }} ë¹„ì¦ˆë‹ˆìŠ¤ ì—”í‹°í‹° í¸ì§‘"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ e.name }}</td>
                                <td>
                                    <span class="badge
                                        {% if e.business_priority == '0-Critical' %}bg-danger
                                        {% elif e.business_priority == '1-High' %}bg-warning text-dark
                                        {% elif e.business_priority == '2-Medium' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.business_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if e.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif e.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif e.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.follow_up_priority or 'â€”' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ e.follow_up_date or 'â€”' }}
                                    {% if e.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ e.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ e.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-briefcase fs-4 d-block mb-1"></i>
                    Follow-up ëŒ€ìƒ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('business_opportunities_page') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°íšŒ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ì…ì‚¬ í›„ë³´ì -->
<div class="row g-4 mb-4">
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-person-badge"></i>
                <span class="fw-semibold">ì…ì‚¬ í›„ë³´ì</span>
                <span class="badge bg-primary ms-auto">{{ incoming|length }}ëª…</span>
            </div>
            <div class="card-body p-0">
                {% if incoming %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì†Œì†</th>
                                <th>ì…ì‚¬ ì˜ˆì •ì¼</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in incoming %}
                            <tr
                                class="{% if c.name_hmac %}quickview-row quickview-contact-row{% endif %}"
                                {% if c.name_hmac %}
                                data-contact-id="{{ c.name_hmac }}"
                                role="button"
                                tabindex="0"
                                title="í´ë¦­í•´ì„œ í¸ì§‘"
                                aria-label="{{ c.name }} ì—°ë½ì²˜ í¸ì§‘"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or 'â€”' }}</td>
                                <td class="small">{{ c.follow_up_date or 'â€”' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-person-x fs-4 d-block mb-1"></i>
                    ì…ì‚¬ í›„ë³´ìê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    ì „ì²´ ì—°ë½ì²˜ <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- íŒ¨ë°€ë¦¬ íŠ¸ë˜ì»¤ -->
<div class="row g-4 mb-4">
  {% for stat in family_stats %}
  <div class="col-12 col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-{% if loop.first %}emoji-smile{% else %}heart{% endif %}"></i>
        <span class="fw-semibold">{{ stat.name }}</span>
      </div>
      <div class="card-body">

        <!-- ë§ˆì§€ë§‰ ë‚ ì§œ -->
        <div class="mb-3 text-center">
          <div class="text-muted small mb-1">ë§ˆì§€ë§‰ìœ¼ë¡œ {{ stat.name }}</div>
          <div class="fs-5 fw-semibold" id="family-last-{{ loop.index }}">
            {% if stat.last_date %}
              {{ stat.last_date }}
              <span class="text-muted small ms-1">({{ stat.days_since_last }}ì¼ ì „)</span>
            {% else %}
              <span class="text-muted">ì•„ì§ ê¸°ë¡ ì—†ìŒ</span>
            {% endif %}
          </div>
        </div>

        <!-- í†µê³„ ë°°ì§€ -->
        <div class="d-flex gap-2 justify-content-center mb-3">
          <span class="badge bg-primary-subtle text-primary-emphasis">
            1ë…„ í‰ê·  {{ (stat.yearly_count / 12) | round(1) }}íšŒ/ì›”
          </span>
          <span class="badge bg-secondary-subtle text-secondary-emphasis">
            í•œë‹¬ {{ stat.monthly_count }}íšŒ
          </span>
        </div>

        <!-- ë‚ ì§œ ì„ íƒ + ê¸°ë¡ CTA -->
        <div class="d-flex gap-2">
          <input type="date" class="form-control form-control-sm"
                 id="family-date-{{ loop.index }}" value="{{ today_str_iso }}">
          <button class="btn btn-sm btn-primary text-nowrap"
                  onclick="familyToggle('{{ stat.name }}', {{ loop.index }}, event)">
            ê¸°ë¡í•˜ê¸°
          </button>
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Books I am reading -->
<div class="card">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-book-half"></i>
        <span class="fw-semibold">Books I am reading</span>
        <span class="badge bg-success ms-auto">{{ reading_books|length }}ê¶Œ</span>
    </div>
    <div class="card-body">
        {% if reading_books %}
        <div class="row g-3">
            {% for book in reading_books %}
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="d-flex align-items-start gap-2 p-2 border rounded">
                    <i class="bi bi-bookmark-fill text-success mt-1 flex-shrink-0"></i>
                    <div class="min-w-0">
                        <div class="fw-medium text-truncate">{{ book.title }}</div>
                        <div class="text-muted small">{{ book.author }}</div>
                        {% if book.added_at %}
                        <div class="text-muted" style="font-size: 0.75rem;">
                            ì¶”ê°€: {{ book.added_at.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3">
            <i class="bi bi-book fs-4 d-block mb-1"></i>
            í˜„ì¬ ì½ê³  ìˆëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        {% endif %}
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('book_reading') }}" class="btn btn-sm btn-outline-success">
            Reading ëª©ë¡ <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<!-- Edit Contact Modal (Unified with Contact List) -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì—°ë½ì²˜ í¸ì§‘</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" name="name_hmac" id="editNameHmac">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">ì´ë¦„</label>
                            <input type="text" class="form-control" name="name" id="editName" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Priority</label>
                            <select class="form-select" name="contact_priority" id="editCP">
                                <option value="">ì„ íƒ</option>
                                <option>1A-ì¸ìƒê´€ê³„</option>
                                <option>1M-Mentor, ì€ì¸</option>
                                <option>1F-Family</option>
                                <option>2A-ë¹„ì¦ˆë‹ˆìŠ¤ ìš°ì„ ìˆœìœ„</option>
                                <option>2C-ë¹„ì¦ˆë‹ˆìŠ¤</option>
                                <option>3A-ì¸ì  ìš°ì„ ìˆœìœ„</option>
                                <option>3C-ì¸ì  ë„¤íŠ¸ì›Œí‚¹</option>
                                <option>4A-Passive</option>
                                <option>5A-Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ì†Œì†</label>
                            <input type="text" class="form-control" name="employer" id="editEmployer">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ì§ê¸‰</label>
                            <input type="text" class="form-control" name="title" id="editTitle">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Priority</label>
                            <select class="form-select" name="follow_up_priority" id="editFU">
                                <option value="FU9">FU9 (None)</option>
                                <option value="FU5">FU5 (Low)</option>
                                <option value="FU3">FU3 (Medium)</option>
                                <option value="FU1">FU1 (High)</option>
                                <option value="FU0">FU0 (Critical)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" name="follow_up_date" id="editFUDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Contact</label>
                            <input type="date" class="form-control" name="last_contact" id="editLastContact">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Follow-up Note</label>
                            <input type="text" class="form-control" name="follow_up_note" id="editFUNote">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone" id="editPhone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">íƒœê·¸</label>
                            <select class="form-select" name="tag" id="editTag">
                                <option value="">ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred by</label>
                            <input type="text" class="form-control" name="referred_by" id="editReferredBy">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Key Value & Interest</label>
                            <input type="text" class="form-control" name="key_value_interest" id="editKVI">
                        </div>
                    </div>
                </form>
                <hr>
                <h6>Interaction Log</h6>
                <div id="interactionLogs" class="small text-muted">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteContactBtn">ì‚­ì œ</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="updateContactBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- View/Edit Entity Modal (Unified with Business Opportunities) -->
<div class="modal fade" id="viewEntityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEntityTitle">ì—”í‹°í‹°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="editEntityForm">
                            <input type="hidden" name="entity_hmac" id="editEntityHmac">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Business Priority</label>
                                    <select class="form-select" name="business_priority" id="editEntityBP">
                                        <option value="">ì„ íƒ</option>
                                        <option value="0-Critical">0-Critical</option>
                                        <option value="1-High">1-High</option>
                                        <option value="2-Medium">2-Medium</option>
                                        <option value="3-Low">3-Low</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Priority</label>
                                    <select class="form-select" name="follow_up_priority" id="editEntityFU">
                                        <option value="FU9">FU9 (None)</option>
                                        <option value="FU5">FU5 (Low)</option>
                                        <option value="FU3">FU3 (Medium)</option>
                                        <option value="FU1">FU1 (High)</option>
                                        <option value="FU0">FU0 (Critical)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Date</label>
                                    <input type="date" class="form-control" name="follow_up_date" id="editEntityFUDate">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Last Contact</label>
                                    <input type="date" class="form-control" name="last_contact" id="editEntityLastContact">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">íƒœê·¸</label>
                                    <select class="form-select" name="tag" id="editEntityTag">
                                        <option value="">ì„ íƒ</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Follow-up Note</label>
                                    <input type="text" class="form-control" name="follow_up_note" id="editEntityFUNote">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Key Value & Interest</label>
                                    <input type="text" class="form-control" name="key_value_interest" id="editEntityKVI">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Referred by</label>
                                    <input type="text" class="form-control" name="referred_by" id="editEntityReferredBy">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">ë‹´ë‹¹ì</label>
                                    <input type="text" class="form-control" name="assignee" id="editEntityAssignee">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Related Individuals</label>
                                    <div id="relatedIndividualsArea" class="border rounded p-2 bg-light" style="min-height:60px">
                                        <small class="text-muted">ë¡œë”© ì¤‘...</small>
                                    </div>
                                    <input type="hidden" name="related_individuals" id="editEntityRelated">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-semibold">Opportunities</h6>
                            <button class="btn btn-outline-primary btn-sm" id="addOppBtn">
                                <i class="bi bi-plus-lg"></i> ì¶”ê°€
                            </button>
                        </div>
                        <div id="opportunitiesList">
                            <p class="text-muted small">ë¡œë”© ì¤‘...</p>
                        </div>
                    </div>
                </div>
                <hr>
                <h6 class="fw-semibold">Interaction Log</h6>
                <div id="entityInteractionLogs" class="small text-muted">ë¡œë”© ì¤‘...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteEntityBtn">
                    <i class="bi bi-trash"></i> ì‚­ì œ
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="updateEntityBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<!-- Anki Review Modal -->
<div class="modal fade" id="ankiReviewModal" tabindex="-1" aria-labelledby="ankiModalTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width:560px">
    <div class="modal-content">

      <div class="modal-header border-0 pb-0">
        <span class="fw-semibold" id="ankiModalTitle">
          <i class="bi bi-lightning-charge-fill text-warning"></i> Daily Review
        </span>
        <span class="ms-auto me-3 text-muted" style="font-size:0.82rem" id="ankiModalRemaining"></span>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body pt-2">
        <!-- Progress -->
        <div class="progress mb-3" style="height:4px">
          <div class="progress-bar bg-warning" id="ankiModalProgress" style="width:0%;transition:width 0.3s"></div>
        </div>

        <!-- Review area -->
        <div id="ankiModalReview">
          <div id="ankiModalCard" class="anki-modal-card" onclick="ankiModalFlip()">
            <div id="ankiModalHighlightHeader" class="anki-highlight-header" style="display:none">
              <span class="anki-highlight-badge">ğŸ“– Book Highlight</span>
              <div id="ankiModalHighlightSource" class="anki-highlight-source"></div>
            </div>
            <div id="ankiModalFront" class="anki-modal-face"></div>
            <div id="ankiModalBack" class="anki-modal-face" style="display:none"></div>
          </div>
          <p class="text-center text-muted mt-2 mb-0" id="ankiModalHint" style="font-size:0.78rem">
            í´ë¦­í•˜ì—¬ ë’¤ì§‘ê¸°
          </p>
          <div id="ankiModalRating" class="d-flex justify-content-center gap-2 mt-3" style="display:none!important">
            <button class="anki-rate-btn anki-rate-again" onclick="ankiModalRate(1)">Again<br><small>&lt;1ì¼</small></button>
            <button class="anki-rate-btn anki-rate-hard"  onclick="ankiModalRate(2)">Hard<br><small>ì–´ë ¤ì› ì–´ìš”</small></button>
            <button class="anki-rate-btn anki-rate-good"  onclick="ankiModalRate(3)">Good<br><small>ì˜ ê¸°ì–µí•¨</small></button>
            <button class="anki-rate-btn anki-rate-easy"  onclick="ankiModalRate(4)">Easy<br><small>ì™„ë²½ ê¸°ì–µ</small></button>
            <button class="anki-rate-btn anki-rate-delete" onclick="ankiModalDelete()" title="ì¹´ë“œ ì‚­ì œ">
              <i class="bi bi-trash3"></i>
            </button>
          </div>
        </div>

        <!-- Done screen -->
        <div id="ankiModalDone" class="text-center py-5" style="display:none">
          <i class="bi bi-check-circle-fill text-success" style="font-size:3rem"></i>
          <h5 class="mt-3 mb-1">ì„¸ì…˜ ì™„ë£Œ!</h5>
          <p class="text-muted mb-0" id="ankiModalDoneMsg"></p>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add/Edit Opportunity Modal -->
<div class="modal fade" id="oppModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oppModalTitle">Opportunity ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="oppEntityHmac">
                <input type="hidden" id="oppId">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-control" id="oppTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Details</label>
                    <textarea class="form-control" id="oppDetails" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" id="saveOppBtn">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleHabit(btn) {
    const item = btn.closest('.habit-item');
    const habitName = item.dataset.habit;
    btn.disabled = true;

    fetch('/api/habits/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({habit_name: habitName})
    })
    .then(r => r.json())
    .then(data => {
        const done = data.action === 'done';
        btn.className = 'btn btn-sm habit-toggle-btn ' + (done ? 'btn-success' : 'btn-outline-primary');
        btn.innerHTML = done ? '<i class="bi bi-check-lg"></i> ì™„ë£Œ' : 'ê¸°ë¡í•˜ê¸°';
        item.querySelector('.streak-badge').textContent = 'ğŸ”¥ ' + data.streak + 'ì¼ ì—°ì†';
        item.querySelector('.total-badge').textContent = 'ì´ ' + data.total + 'ì¼';
        const bars = item.querySelectorAll('.habit-bar');
        data.days.forEach((day, i) => {
            bars[i].className = 'rounded-top habit-bar ' +
                (day.done ? 'bg-primary' : 'bg-secondary bg-opacity-25') +
                (day.is_today ? ' habit-bar-today' : '');
            bars[i].style.height = day.done ? '28px' : '8px';
        });
        btn.disabled = false;
    })
    .catch(() => { btn.disabled = false; });
}

function setBtnFeedback(btn, state, msg) {
    if (!btn._orig) btn._orig = {html: btn.innerHTML, cls: btn.className};
    clearTimeout(btn._timer);
    if (state === 'loading') {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>ì €ì¥ ì¤‘...';
    } else if (state === 'success') {
        btn.disabled = false;
        btn.className = btn._orig.cls.replace(/\bbtn-(primary|secondary|outline-\w+)\b/, 'btn-success');
        btn.innerHTML = 'âœ“ ' + (msg || 'ì €ì¥ë¨');
        btn._timer = setTimeout(() => {
            btn.className = btn._orig.cls; btn.innerHTML = btn._orig.html; btn._orig = null;
        }, 1800);
    } else if (state === 'error') {
        btn.disabled = false;
        btn.className = btn._orig.cls.replace(/\bbtn-(primary|secondary|outline-\w+)\b/, 'btn-danger');
        btn.innerHTML = msg || 'ì˜¤ë¥˜';
        btn._timer = setTimeout(() => {
            btn.className = btn._orig.cls; btn.innerHTML = btn._orig.html; btn._orig = null;
        }, 2500);
    }
}

(async function initDashboardEditableModal() {
    const contactQuickRows = document.querySelectorAll('.quickview-contact-row');
    const entityQuickRows = document.querySelectorAll('.quickview-entity-row');
    const editContactModalEl = document.getElementById('editContactModal');
    const viewEntityModalEl = document.getElementById('viewEntityModal');
    const oppModalEl = document.getElementById('oppModal');

    if (!contactQuickRows.length && !entityQuickRows.length) return;
    if (!editContactModalEl || !viewEntityModalEl || !oppModalEl || typeof bootstrap === 'undefined') return;

    const style = document.createElement('style');
    style.textContent = '.quickview-row{cursor:pointer;} .quickview-row:focus-visible{outline:2px solid var(--bs-primary);outline-offset:-2px;}';
    document.head.appendChild(style);

    const contactSeed = {{ (top5 + incoming)|tojson }};
    const entitySeed = {{ entity_top5|tojson }};
    const contactsById = new Map();
    const entitiesById = new Map();
    let currentEntityHmac = null;

    const editContactModal = bootstrap.Modal.getOrCreateInstance(editContactModalEl);
    const viewEntityModal = bootstrap.Modal.getOrCreateInstance(viewEntityModalEl);
    const oppModal = bootstrap.Modal.getOrCreateInstance(oppModalEl);

    function normalizeDateForInput(val) {
        if (!val) return '';
        if (/^\d{4}-\d{2}$/.test(val)) return `${val}-01`;
        if (/^\d{4}$/.test(val)) return `${val}-01-01`;
        return val;
    }

    function indexContacts(items) {
        (items || []).forEach((contact) => {
            if (contact && contact.name_hmac) contactsById.set(contact.name_hmac, contact);
        });
    }

    function indexEntities(items) {
        (items || []).forEach((entity) => {
            if (entity && entity.entity_hmac) entitiesById.set(entity.entity_hmac, entity);
        });
    }

    async function refreshContacts() {
        try {
            const res = await fetch('/api/contacts');
            const data = await res.json();
            if (data.error) return false;
            indexContacts(data.contacts || []);
            return true;
        } catch (_e) {
            return false;
        }
    }

    async function refreshEntities() {
        try {
            const res = await fetch('/api/entities');
            const data = await res.json();
            if (data.error) return false;
            indexEntities(data.entities || []);
            return true;
        } catch (_e) {
            return false;
        }
    }

    async function loadTags() {
        try {
            const res = await fetch('/api/tags');
            const data = await res.json();
            const tags = data.tags || [];
            ['editTag', 'editEntityTag'].forEach((id) => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const current = sel.value;
                sel.innerHTML = '<option value="">ì„ íƒ</option>' + tags.map((t) => `<option value="${t}">${t}</option>`).join('');
                sel.value = current;
            });
        } catch (_e) {
            // no-op
        }
    }

    function updateUrlState(modalType, id, mode) {
        const url = new URL(window.location.href);
        if (modalType && id) {
            url.searchParams.set('modal', modalType);
            url.searchParams.set('id', id);
        } else {
            url.searchParams.delete('modal');
            url.searchParams.delete('id');
        }

        if (mode === 'push') {
            window.history.pushState({}, '', url);
            return;
        }
        window.history.replaceState({}, '', url);
    }

    async function ensureContact(nameHmac) {
        if (contactsById.has(nameHmac)) return contactsById.get(nameHmac);
        const ok = await refreshContacts();
        if (!ok) return null;
        return contactsById.get(nameHmac) || null;
    }

    async function ensureEntity(entityHmac) {
        if (entitiesById.has(entityHmac)) return entitiesById.get(entityHmac);
        const ok = await refreshEntities();
        if (!ok) return null;
        return entitiesById.get(entityHmac) || null;
    }

    async function openContactEdit(nameHmac, historyMode) {
        const contact = await ensureContact(nameHmac);
        if (!contact) return false;

        document.getElementById('editNameHmac').value = nameHmac;
        document.getElementById('editName').value = contact.name || '';
        document.getElementById('editCP').value = contact.contact_priority || '';
        document.getElementById('editEmployer').value = contact.employer || '';
        document.getElementById('editTitle').value = contact.title || '';
        document.getElementById('editFU').value = contact.follow_up_priority || 'FU9';
        document.getElementById('editFUDate').value = normalizeDateForInput(contact.follow_up_date || '');
        document.getElementById('editLastContact').value = normalizeDateForInput(contact.last_contact || '');
        document.getElementById('editFUNote').value = contact.follow_up_note || '';
        document.getElementById('editEmail').value = contact.email || '';
        document.getElementById('editPhone').value = contact.phone || '';
        document.getElementById('editTag').value = contact.tag || '';
        document.getElementById('editReferredBy').value = contact.referred_by || '';
        document.getElementById('editKVI').value = contact.key_value_interest || '';

        const logsDiv = document.getElementById('interactionLogs');
        logsDiv.innerHTML = 'ë¡œë”© ì¤‘...';
        try {
            const res = await fetch(`/api/contacts/${nameHmac}/logs`);
            const data = await res.json();
            const logs = data.logs || [];
            if (!logs.length) {
                logsDiv.innerHTML = '<p class="text-muted">ê¸°ë¡ ì—†ìŒ</p>';
            } else {
                logsDiv.innerHTML = logs.map((l) => `
                    <div class="border-bottom py-2">
                        <strong>${l.date}</strong> â€” ${l.context}
                        ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                    </div>
                `).join('');
            }
        } catch (_e) {
            logsDiv.innerHTML = '<p class="text-danger">ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨</p>';
        }

        viewEntityModal.hide();
        editContactModal.show();
        if (historyMode) updateUrlState('contact', nameHmac, historyMode);
        return true;
    }

    async function loadSuggestedContacts(entityHmac, relatedRaw) {
        const area = document.getElementById('relatedIndividualsArea');
        area.innerHTML = '<small class="text-muted">ë¡œë”© ì¤‘...</small>';

        try {
            const res = await fetch(`/api/entities/${entityHmac}/suggested-contacts`);
            const data = await res.json();
            const relatedSet = new Set((relatedRaw || '').split(',').map((s) => s.trim()).filter(Boolean));

            function renderContact(c) {
                const isChecked = relatedSet.has(c.name_hmac);
                const badgeHtml = c.match_reason
                    ? `<span class="badge bg-info text-dark ms-1" style="font-size:0.7em">${c.match_reason}</span>`
                    : '';
                return `<div class="form-check">
                    <input class="form-check-input related-check" type="checkbox" value="${c.name_hmac}" id="rc_${c.name_hmac}" ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="rc_${c.name_hmac}">${c.display_name}${badgeHtml}</label>
                </div>`;
            }

            let html = '';
            if (data.suggested && data.suggested.length) {
                html += '<div class="mb-2"><small class="text-muted fw-semibold">ì¶”ì²œ (Employer ë§¤ì¹­)</small></div>';
                html += data.suggested.map(renderContact).join('');
            }
            if (data.others && data.others.length) {
                if (html) html += '<hr class="my-2">';
                html += '<details><summary class="small text-muted" style="cursor:pointer">ê¸°íƒ€ ì—°ë½ì²˜ ë”ë³´ê¸°</summary><div class="mt-1">';
                html += data.others.map(renderContact).join('');
                html += '</div></details>';
            }

            area.innerHTML = html || '<small class="text-muted">ì—°ë½ì²˜ ì—†ìŒ</small>';
            area.querySelectorAll('.related-check').forEach((cb) => {
                cb.addEventListener('change', updateRelatedHidden);
            });
        } catch (_e) {
            area.innerHTML = '<small class="text-danger">ë¡œë“œ ì‹¤íŒ¨</small>';
        }
    }

    function updateRelatedHidden() {
        const checked = Array.from(document.querySelectorAll('#relatedIndividualsArea .related-check:checked')).map((cb) => cb.value);
        document.getElementById('editEntityRelated').value = checked.join(', ');
    }

    async function loadOpportunities(entityHmac) {
        const listDiv = document.getElementById('opportunitiesList');
        listDiv.innerHTML = '<p class="text-muted small">ë¡œë”© ì¤‘...</p>';

        try {
            const res = await fetch(`/api/entities/${entityHmac}/opportunities`);
            const data = await res.json();
            const opps = data.opportunities || [];

            if (!opps.length) {
                listDiv.innerHTML = '<p class="text-muted small">ë“±ë¡ëœ Opportunityê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            listDiv.innerHTML = opps.map((o) => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="fw-semibold">${o.title}</div>
                        <div>
                            <button class="btn btn-link btn-sm p-0 me-2 text-secondary"
                                onclick="openEditOpp('${entityHmac}', '${o.opp_id}', ${JSON.stringify(o.title).replace(/"/g, '&quot;')}, ${JSON.stringify(o.details || '').replace(/"/g, '&quot;')})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-link btn-sm p-0 text-danger"
                                onclick="deleteOpp('${entityHmac}', '${o.opp_id}')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    ${o.details ? `<div class="text-muted small mt-1">${o.details}</div>` : ''}
                    <div class="text-muted" style="font-size:0.75em">${o.created_date || ''}</div>
                </div>
            `).join('');
        } catch (_e) {
            listDiv.innerHTML = '<p class="text-danger small">ë¡œë“œ ì‹¤íŒ¨</p>';
        }
    }

    async function loadEntityLogs(entityHmac) {
        const logsDiv = document.getElementById('entityInteractionLogs');
        logsDiv.innerHTML = 'ë¡œë”© ì¤‘...';
        try {
            const res = await fetch(`/api/entities/${entityHmac}/logs`);
            const data = await res.json();
            const logs = data.logs || [];
            if (!logs.length) {
                logsDiv.innerHTML = '<p class="text-muted">ê¸°ë¡ ì—†ìŒ</p>';
            } else {
                logsDiv.innerHTML = logs.map((l) => `
                    <div class="border-bottom py-2">
                        <strong>${l.date}</strong> â€” ${l.context}
                        ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                    </div>
                `).join('');
            }
        } catch (_e) {
            logsDiv.innerHTML = '<p class="text-danger">ë¡œê·¸ ë¡œë”© ì‹¤íŒ¨</p>';
        }
    }

    async function openEntityEdit(entityHmac, historyMode) {
        const entity = await ensureEntity(entityHmac);
        if (!entity) return false;

        currentEntityHmac = entityHmac;

        document.getElementById('viewEntityTitle').textContent = entity.name || 'ì—”í‹°í‹°';
        document.getElementById('editEntityHmac').value = entityHmac;
        document.getElementById('editEntityBP').value = entity.business_priority || '';
        document.getElementById('editEntityFU').value = entity.follow_up_priority || 'FU9';
        document.getElementById('editEntityFUDate').value = normalizeDateForInput(entity.follow_up_date || '');
        document.getElementById('editEntityLastContact').value = normalizeDateForInput(entity.last_contact || '');
        document.getElementById('editEntityFUNote').value = entity.follow_up_note || '';
        document.getElementById('editEntityKVI').value = entity.key_value_interest || '';
        document.getElementById('editEntityReferredBy').value = entity.referred_by || '';
        document.getElementById('editEntityAssignee').value = entity.assignee || '';
        document.getElementById('editEntityTag').value = entity.tag || '';
        document.getElementById('editEntityRelated').value = entity.related_individuals || '';

        await Promise.all([
            loadSuggestedContacts(entityHmac, entity.related_individuals || ''),
            loadOpportunities(entityHmac),
            loadEntityLogs(entityHmac),
        ]);

        editContactModal.hide();
        viewEntityModal.show();
        if (historyMode) updateUrlState('entity', entityHmac, historyMode);
        return true;
    }

    async function syncModalWithUrl() {
        const params = new URLSearchParams(window.location.search);
        const modalType = params.get('modal');
        const id = params.get('id');

        if (modalType === 'contact' && id) {
            if (!await openContactEdit(id, null)) {
                editContactModal.hide();
                viewEntityModal.hide();
                updateUrlState(null, null, 'replace');
            }
            return;
        }
        if (modalType === 'entity' && id) {
            if (!await openEntityEdit(id, null)) {
                editContactModal.hide();
                viewEntityModal.hide();
                updateUrlState(null, null, 'replace');
            }
            return;
        }

        editContactModal.hide();
        viewEntityModal.hide();
    }

    function bindQuickRows(rows, key, opener) {
        rows.forEach((row) => {
            const itemId = row.dataset[key];
            if (!itemId) return;

            row.addEventListener('click', async (event) => {
                if (event.target.closest('a, button, input, select, textarea')) return;
                await opener(itemId, 'push');
            });
            row.addEventListener('keydown', async (event) => {
                if (event.key !== 'Enter' && event.key !== ' ') return;
                event.preventDefault();
                await opener(itemId, 'push');
            });
        });
    }

    document.getElementById('updateContactBtn').addEventListener('click', async () => {
        const btn = document.getElementById('updateContactBtn');
        const nameHmac = document.getElementById('editNameHmac').value;
        const fields = ['contact_priority', 'employer', 'title', 'follow_up_priority', 'follow_up_date', 'follow_up_note', 'last_contact', 'email', 'phone', 'tag', 'referred_by', 'key_value_interest'];
        const form = document.getElementById('editContactForm');
        const formData = new FormData(form);
        const data = {};
        fields.forEach((f) => {
            const val = formData.get(f);
            if (val !== null) data[f] = val;
        });

        setBtnFeedback(btn, 'loading');
        try {
            const res = await fetch(`/api/contacts/${nameHmac}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.error) {
                setBtnFeedback(btn, 'error', result.errors ? result.errors[0] : result.error);
                return;
            }
            setBtnFeedback(btn, 'success', 'ì €ì¥ë¨');
            setTimeout(() => { editContactModal.hide(); refreshContacts(); }, 600);
        } catch (e) {
            setBtnFeedback(btn, 'error', 'ì˜¤ë¥˜');
        }
    });

    document.getElementById('deleteContactBtn').addEventListener('click', async () => {
        if (!confirm('íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const nameHmac = document.getElementById('editNameHmac').value;
        try {
            const res = await fetch(`/api/contacts/${nameHmac}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            editContactModal.hide();
            window.location.reload();
        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    });

    document.getElementById('updateEntityBtn').addEventListener('click', async () => {
        const btn = document.getElementById('updateEntityBtn');
        const entityHmac = document.getElementById('editEntityHmac').value;
        const fields = ['business_priority', 'follow_up_priority', 'follow_up_date', 'follow_up_note', 'last_contact', 'tag', 'referred_by', 'assignee', 'key_value_interest', 'related_individuals'];
        const form = document.getElementById('editEntityForm');
        const formData = new FormData(form);
        const data = {};
        fields.forEach((f) => {
            const val = formData.get(f);
            if (val !== null) data[f] = val;
        });

        setBtnFeedback(btn, 'loading');
        try {
            const res = await fetch(`/api/entities/${entityHmac}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.error) {
                setBtnFeedback(btn, 'error', result.error);
                return;
            }
            setBtnFeedback(btn, 'success', 'ì €ì¥ë¨');
            setTimeout(() => { viewEntityModal.hide(); refreshEntities(); }, 600);
        } catch (e) {
            setBtnFeedback(btn, 'error', 'ì˜¤ë¥˜');
        }
    });

    document.getElementById('deleteEntityBtn').addEventListener('click', async () => {
        if (!confirm('íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const entityHmac = document.getElementById('editEntityHmac').value;
        try {
            const res = await fetch(`/api/entities/${entityHmac}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            viewEntityModal.hide();
            window.location.reload();
        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    });

    document.getElementById('addOppBtn').addEventListener('click', () => {
        document.getElementById('oppModalTitle').textContent = 'Opportunity ì¶”ê°€';
        document.getElementById('oppEntityHmac').value = currentEntityHmac || '';
        document.getElementById('oppId').value = '';
        document.getElementById('oppTitle').value = '';
        document.getElementById('oppDetails').value = '';
        oppModal.show();
    });

    window.openEditOpp = function openEditOpp(entityHmac, oppId, title, details) {
        document.getElementById('oppModalTitle').textContent = 'Opportunity ìˆ˜ì •';
        document.getElementById('oppEntityHmac').value = entityHmac;
        document.getElementById('oppId').value = oppId;
        document.getElementById('oppTitle').value = title || '';
        document.getElementById('oppDetails').value = details || '';
        oppModal.show();
    };

    window.deleteOpp = async function deleteOpp(entityHmac, oppId) {
        if (!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        try {
            const res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            await loadOpportunities(entityHmac);
        } catch (e) {
            alert('ì˜¤ë¥˜: ' + e.message);
        }
    };

    document.getElementById('saveOppBtn').addEventListener('click', async (event) => {
        const btn = event.currentTarget;
        if (btn.disabled) return;

        const entityHmac = document.getElementById('oppEntityHmac').value;
        const oppId = document.getElementById('oppId').value;
        const title = document.getElementById('oppTitle').value.trim();
        const details = document.getElementById('oppDetails').value.trim();

        if (!title) {
            setBtnFeedback(btn, 'error', 'Title í•„ìˆ˜');
            return;
        }

        setBtnFeedback(btn, 'loading');
        try {
            let res;
            if (oppId) {
                res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, details}),
                });
            } else {
                res = await fetch(`/api/entities/${entityHmac}/opportunities`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, details}),
                });
            }
            const result = await res.json();
            if (result.error) {
                setBtnFeedback(btn, 'error', result.error);
                return;
            }
            setBtnFeedback(btn, 'success', 'ì €ì¥ë¨');
            setTimeout(() => { oppModal.hide(); loadOpportunities(entityHmac); }, 600);
        } catch (e) {
            setBtnFeedback(btn, 'error', 'ì˜¤ë¥˜');
        }
    });

    bindQuickRows(contactQuickRows, 'contactId', openContactEdit);
    bindQuickRows(entityQuickRows, 'entityId', openEntityEdit);

    editContactModalEl.addEventListener('hidden.bs.modal', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('modal') === 'contact') updateUrlState(null, null, 'replace');
    });
    viewEntityModalEl.addEventListener('hidden.bs.modal', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('modal') === 'entity') updateUrlState(null, null, 'replace');
    });

    window.addEventListener('popstate', () => {
        syncModalWithUrl();
    });

    indexContacts(contactSeed);
    indexEntities(entitySeed);
    await Promise.all([refreshContacts(), refreshEntities(), loadTags()]);
    await syncModalWithUrl();
})();

async function familyToggle(habitName, idx, event) {
    const dateVal = document.getElementById(`family-date-${idx}`).value;
    const btn = event.target;
    setBtnFeedback(btn, 'loading');
    try {
        const res = await fetch('/api/habits/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({habit_name: habitName, date: dateVal || undefined})
        });
        const data = await res.json();
        setBtnFeedback(btn, 'success', data.action === 'done' ? 'ì™„ë£Œ' : 'ì·¨ì†Œë¨');
        if (data.last_date) {
            document.getElementById(`family-last-${idx}`).innerHTML =
                `<strong>${data.last_date}</strong>`;
        }
    } catch(e) {
        setBtnFeedback(btn, 'error', 'ì˜¤ë¥˜');
    }
}

// --- Anki Review Modal ---
(function() {
    let _cards = [], _idx = 0, _reviewed = 0, _flipped = false;

    const modal = document.getElementById('ankiReviewModal');
    if (!modal) return;

    modal.addEventListener('show.bs.modal', async () => {
        _cards = []; _idx = 0; _reviewed = 0;
        document.getElementById('ankiModalDone').style.display = 'none';
        document.getElementById('ankiModalReview').style.display = '';
        document.getElementById('ankiModalProgress').style.width = '0%';

        try {
            const res = await fetch('/api/anki/due');
            _cards = await res.json();
        } catch(e) { _cards = []; }

        _ankiShow();
    });

    window.ankiModalFlip = function() {
        if (_flipped) return;
        _flipped = true;
        document.getElementById('ankiModalFront').style.display = 'none';
        document.getElementById('ankiModalBack').style.display = '';
        document.getElementById('ankiModalHint').style.display = 'none';
        document.getElementById('ankiModalRating').style.removeProperty('display');
    };

    window.ankiModalRate = async function(rating) {
        const card = _cards[_idx];
        document.querySelectorAll('.anki-rate-btn').forEach(b => b.disabled = true);
        try {
            await fetch(`/api/anki/cards/${card.id}/review`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating})
            });
        } catch(e) {}
        _reviewed++;
        _idx++;
        document.querySelectorAll('.anki-rate-btn').forEach(b => b.disabled = false);
        _ankiShow();
    };

    window.ankiModalDelete = async function() {
        if (!confirm('ì´ ì¹´ë“œë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        const card = _cards[_idx];
        try {
            await fetch(`/api/anki/cards/${card.id}`, { method: 'DELETE' });
        } catch(e) {}
        _cards.splice(_idx, 1);
        _ankiShow();
    };

    function _ankiShow() {
        if (_idx >= _cards.length) { _ankiDone(); return; }
        _flipped = false;
        const card = _cards[_idx];
        const total = _cards.length;
        const pct = Math.round((_idx / total) * 100);

        const isHighlight = card.card_type === 'highlight';
        const header = document.getElementById('ankiModalHighlightHeader');
        const srcEl  = document.getElementById('ankiModalHighlightSource');

        document.getElementById('ankiModalFront').textContent = card.front;
        document.getElementById('ankiModalBack').textContent  = card.back;

        if (isHighlight) {
            srcEl.textContent = card.front + (card.source_ref ? '  Â·  ' + card.source_ref : '');
            header.style.display = '';
            document.getElementById('ankiModalFront').style.display = 'none';
            document.getElementById('ankiModalBack').style.display  = '';
            document.getElementById('ankiModalHint').style.display  = 'none';
            document.getElementById('ankiModalCard').style.cursor   = 'default';
            document.getElementById('ankiModalCard').onclick        = null;
            document.getElementById('ankiModalRating').style.removeProperty('display');
            _flipped = true;
        } else {
            header.style.display = 'none';
            document.getElementById('ankiModalFront').style.display = '';
            document.getElementById('ankiModalBack').style.display  = 'none';
            document.getElementById('ankiModalHint').style.display  = '';
            document.getElementById('ankiModalCard').style.cursor   = 'pointer';
            document.getElementById('ankiModalCard').onclick        = ankiModalFlip;
            document.getElementById('ankiModalRating').style.display = 'none';
        }

        document.getElementById('ankiModalProgress').style.width = pct + '%';
        document.getElementById('ankiModalRemaining').textContent =
            (total - _idx) + ' / ' + total;
    }

    function _ankiDone() {
        document.getElementById('ankiModalProgress').style.width = '100%';
        document.getElementById('ankiModalRemaining').textContent = 'ì™„ë£Œ!';
        document.getElementById('ankiModalReview').style.display = 'none';
        document.getElementById('ankiModalDone').style.display = '';
        document.getElementById('ankiModalDoneMsg').textContent =
            `ì˜¤ëŠ˜ ${_reviewed}ê°œ ì¹´ë“œë¥¼ ë³µìŠµí–ˆìŠµë‹ˆë‹¤.`;

        setTimeout(() => {
            const m = bootstrap.Modal.getInstance(modal);
            if (m) m.hide();
            const strip = document.querySelector('.anki-strip');
            if (strip) {
                strip.classList.add('anki-strip--done');
                strip.style.borderLeftColor = '#22c55e';
                strip.innerHTML = `
                    <div>
                        <div class="anki-done-text">
                            <i class="bi bi-check-circle-fill"></i> All caught up for today
                        </div>
                        <div class="anki-done-sub">
                            ë‹¤ìŒ ë³µìŠµì€ ë‚´ì¼ â€” <a href="/anki" class="text-muted">ë± ë³´ê¸°</a>
                        </div>
                    </div>`;
            }
        }, 1500);
    }
})();

// --- Compliment Modal ---
document.getElementById('saveComplimentBtn').addEventListener('click', async function() {
    const recipient = document.getElementById('complimentRecipient').value.trim();
    const content = document.getElementById('complimentContent').value.trim();
    const given_at = document.getElementById('complimentDate').value;
    if (!recipient || !content) {
        alert('ì¹­ì°¬ë°›ì€ ì‚¬ëŒê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
    }
    const btn = this;
    btn.disabled = true;
    btn.textContent = 'ì €ì¥ ì¤‘...';
    try {
        const res = await fetch('/api/compliments', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recipient, content, given_at})
        });
        if (res.ok) {
            bootstrap.Modal.getInstance(document.getElementById('addComplimentModal')).hide();
            document.getElementById('complimentRecipient').value = '';
            document.getElementById('complimentContent').value = '';
            location.reload();
        } else {
            const err = await res.json();
            alert(err.error || 'ì €ì¥ ì‹¤íŒ¨');
        }
    } catch(e) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
        btn.disabled = false;
        btn.textContent = 'ì €ì¥';
    }
});
</script>
{% endblock %}
