{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}
{% block mobile_title %}Dashboard{% endblock %}

{% block content %}
<!-- ===== HABIT LOG ===== -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-lightning-charge-fill text-warning"></i>
        <span class="fw-semibold">Habit Log</span>
        <small class="text-muted ms-auto">{{ today_str }}</small>
      </div>
      <div class="card-body">
        {% for habit in habits_data %}
        <div class="habit-item" data-habit="{{ habit.name | e }}">
          <!-- ÏÉÅÎã®: Ïù¥Î¶Ñ + Î∞∞ÏßÄ + Î≤ÑÌäº -->
          <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
            <span class="fw-semibold flex-grow-1" style="font-size:0.95rem">{{ habit.name }}</span>
            <span class="badge bg-warning text-dark streak-badge">üî• {{ habit.streak }}Ïùº Ïó∞ÏÜç</span>
            <span class="badge bg-secondary total-badge">Ï¥ù {{ habit.total }}Ïùº</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">1ÎÖÑ ÌèâÍ∑† {{ habit.yearly_avg }}Í±¥</span>
            <span class="badge bg-light text-secondary border" style="font-size:0.72rem">ÌïúÎã¨ ÌèâÍ∑† {{ habit.monthly_avg }}Í±¥</span>
            <span class="badge bg-primary" style="font-size:0.72rem">Ïù¥Î≤àÏ£º {{ habit.weekly_count }}Í±¥</span>
            <button class="btn btn-sm habit-toggle-btn
              {% if habit.today_done %}btn-success{% else %}btn-outline-primary{% endif %}"
              onclick="toggleHabit(this)">
              {% if habit.today_done %}<i class="bi bi-check-lg"></i> ÏôÑÎ£å{% else %}Í∏∞Î°ùÌïòÍ∏∞{% endif %}
            </button>
          </div>
          <!-- ÌïòÎã®: 7Ïùº Î∞î Ï∞®Ìä∏ -->
          <div class="d-flex gap-1 align-items-end" style="height:48px">
            {% for day in habit.days %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
              <div class="rounded-top habit-bar
                {% if day.done %}bg-primary{% else %}bg-secondary bg-opacity-25{% endif %}
                {% if day.is_today %}habit-bar-today{% endif %}"
                style="width:100%;height:{% if day.done %}28px{% else %}8px{% endif %}"
                title="{{ day.date }} ({{ day.weekday }}){% if day.done %} ‚úì{% endif %}">
              </div>
              <small class="text-muted mt-1" style="font-size:9px">{{ day.weekday }}</small>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Ïó∞ÎùΩ Ï£ºÍ∞Ñ ÌôúÎèô ÌÜµÍ≥Ñ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-bar-chart-line"></i>
        <span class="fw-semibold">Ïó∞ÎùΩ ÌôúÎèô ¬∑ ÏµúÍ∑º 7Ïùº</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ÎÖÑ ÌèâÍ∑† {{ contact_yearly_avg }}Í±¥</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">ÌïúÎã¨ ÌèâÍ∑† {{ contact_monthly_avg }}Í±¥</span>
        <span class="badge bg-primary">Ïù¥Î≤à Ï£º {{ weekly_total }}Í±¥</span>
    </div>
    <div class="card-body">
        <!-- ÏöîÏïΩ ÏßÄÌëú -->
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary fs-6">Ï†ÑÏ≤¥ Ïó∞ÎùΩÏ≤ò {{ total_contacts }}Î™Ö</span>
            <span class="badge bg-danger fs-6">FU0 Í∏¥Í∏â {{ fu0_count }}Î™Ö</span>
            <span class="badge bg-warning text-dark fs-6">Í∏∞Ìïú Ï¥àÍ≥º {{ overdue_count }}Î™Ö</span>
        </div>
        <!-- CSS ÎßâÎåÄ Ï∞®Ìä∏ (Habit Log Ïä§ÌÉÄÏùº) -->
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in weekly_stats %}
            {% set bar_px = (s.count / max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}Í±¥">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Article Ï£ºÍ∞Ñ ÏùΩÍ∏∞ ÌÜµÍ≥Ñ -->
<div class="card mb-4">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-journal-text"></i>
        <span class="fw-semibold">Article ÌÜµÍ≥Ñ ¬∑ ÏµúÍ∑º 7Ïùº</span>
        <span class="badge bg-secondary ms-auto" style="font-size:0.72rem">1ÎÖÑ ÌèâÍ∑† {{ article_yearly_avg }}Í±¥</span>
        <span class="badge bg-secondary" style="font-size:0.72rem">ÌïúÎã¨ ÌèâÍ∑† {{ article_monthly_avg }}Í±¥</span>
        <span class="badge bg-primary">Ïù¥Î≤à Ï£º {{ article_weekly_total }}Í±¥</span>
    </div>
    <div class="card-body">
        <div class="d-flex gap-2 mb-3 flex-wrap">
            <span class="badge bg-secondary fs-6">Ïò§Îäò ÏùΩÏùå {{ article_today_count }}Í∞ú</span>
        </div>
        <div class="d-flex gap-1 align-items-end" style="height:56px">
            {% for s in article_weekly_stats %}
            {% set bar_px = (s.count / article_max_daily * 36)|int %}
            <div class="flex-fill d-flex flex-column align-items-center justify-content-end">
                <small class="fw-semibold mb-1" style="font-size:9px;min-height:1em">
                    {% if s.count > 0 %}{{ s.count }}{% endif %}
                </small>
                <div class="rounded-top habit-bar
                    {% if s.count == 0 %}bg-secondary bg-opacity-25
                    {% elif s.is_today %}bg-primary
                    {% else %}bg-primary bg-opacity-75{% endif %}
                    {% if s.is_today %}habit-bar-today{% endif %}"
                    style="width:100%;height:{{ bar_px if bar_px >= 4 else 4 }}px"
                    title="{{ s.label }} ({{ s.weekday }}): {{ s.count }}Í∞ú">
                </div>
                <small class="{% if s.is_today %}fw-bold text-primary{% else %}text-muted{% endif %} mt-1"
                       style="font-size:9px">{{ s.weekday }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('daily_news') }}" class="btn btn-sm btn-outline-primary">
            Í∏∞ÏÇ¨ Î≥¥Í∏∞ <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0 fw-semibold">Executive Dashboard</h4>
    <a href="/?fresh=1" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </a>
</div>

<div class="row g-4 mb-4">
    <!-- Ïó∞ÎùΩ Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-clipboard-check"></i>
                <span class="fw-semibold">Ïó∞ÎùΩ Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ top5|length }}Î™Ö</span>
            </div>
            <div class="card-body p-0">
                {% if top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÏÜåÏÜç</th>
                                <th>Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in top5 %}
                            <tr
                                class="{% if c.days_overdue is defined %}table-danger {% endif %}{% if c.name_hmac %}quickview-row quickview-contact-row{% endif %}"
                                {% if c.name_hmac %}
                                data-contact-id="{{ c.name_hmac }}"
                                role="button"
                                tabindex="0"
                                title="ÌÅ¥Î¶≠Ìï¥ÏÑú Ìé∏Ïßë"
                                aria-label="{{ c.name }} Ïó∞ÎùΩÏ≤ò Ìé∏Ïßë"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or '‚Äî' }}</td>
                                <td>
                                    <span class="badge
                                        {% if c.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif c.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif c.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ c.follow_up_priority or '‚Äî' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ c.follow_up_date or '‚Äî' }}
                                    {% if c.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ c.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ c.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-check-circle fs-4 d-block mb-1"></i>
                    Follow-up ÎåÄÍ∏∞ Ï§ëÏù∏ Ïó∞ÎùΩÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    Ï†ÑÏ≤¥ Ïó∞ÎùΩÏ≤ò <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- ÎπÑÏ¶àÎãàÏä§ Í∏∞Ìöå Top 5 -->
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-briefcase"></i>
                <span class="fw-semibold">ÎπÑÏ¶àÎãàÏä§ Í∏∞Ìöå Top 5</span>
                <span class="badge bg-secondary ms-auto">{{ entity_top5|length }}Í±¥</span>
            </div>
            <div class="card-body p-0">
                {% if entity_top5 %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>BP</th>
                                <th>FU Priority</th>
                                <th>Follow-up</th>
                                <th class="text-end">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for e in entity_top5 %}
                            <tr
                                class="{% if e.days_overdue is defined %}table-danger {% endif %}{% if e.entity_hmac %}quickview-row quickview-entity-row{% endif %}"
                                {% if e.entity_hmac %}
                                data-entity-id="{{ e.entity_hmac }}"
                                role="button"
                                tabindex="0"
                                title="ÌÅ¥Î¶≠Ìï¥ÏÑú Ìé∏Ïßë"
                                aria-label="{{ e.name }} ÎπÑÏ¶àÎãàÏä§ ÏóîÌã∞Ìã∞ Ìé∏Ïßë"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ e.name }}</td>
                                <td>
                                    <span class="badge
                                        {% if e.business_priority == '0-Critical' %}bg-danger
                                        {% elif e.business_priority == '1-High' %}bg-warning text-dark
                                        {% elif e.business_priority == '2-Medium' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.business_priority or '‚Äî' }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge
                                        {% if e.follow_up_priority == 'FU0' %}bg-danger
                                        {% elif e.follow_up_priority == 'FU1' %}bg-warning text-dark
                                        {% elif e.follow_up_priority == 'FU3' %}bg-info text-dark
                                        {% else %}bg-secondary{% endif %}">
                                        {{ e.follow_up_priority or '‚Äî' }}
                                    </span>
                                </td>
                                <td class="small">
                                    {{ e.follow_up_date or '‚Äî' }}
                                    {% if e.days_overdue is defined %}
                                    <span class="badge bg-danger ms-1">D+{{ e.days_overdue }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-semibold">{{ e.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-briefcase fs-4 d-block mb-1"></i>
                    Follow-up ÎåÄÏÉÅ ÎπÑÏ¶àÎãàÏä§ Í∏∞ÌöåÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('business_opportunities_page') }}" class="btn btn-sm btn-outline-primary">
                    Ï†ÑÏ≤¥ ÎπÑÏ¶àÎãàÏä§ Í∏∞Ìöå <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ÏûÖÏÇ¨ ÌõÑÎ≥¥Ïûê -->
<div class="row g-4 mb-4">
    <div class="col-12 col-md-6">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <i class="bi bi-person-badge"></i>
                <span class="fw-semibold">ÏûÖÏÇ¨ ÌõÑÎ≥¥Ïûê</span>
                <span class="badge bg-primary ms-auto">{{ incoming|length }}Î™Ö</span>
            </div>
            <div class="card-body p-0">
                {% if incoming %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>ÏÜåÏÜç</th>
                                <th>ÏûÖÏÇ¨ ÏòàÏ†ïÏùº</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in incoming %}
                            <tr
                                class="{% if c.name_hmac %}quickview-row quickview-contact-row{% endif %}"
                                {% if c.name_hmac %}
                                data-contact-id="{{ c.name_hmac }}"
                                role="button"
                                tabindex="0"
                                title="ÌÅ¥Î¶≠Ìï¥ÏÑú Ìé∏Ïßë"
                                aria-label="{{ c.name }} Ïó∞ÎùΩÏ≤ò Ìé∏Ïßë"
                                {% endif %}
                            >
                                <td class="fw-medium">{{ c.name }}</td>
                                <td class="text-muted small">{{ c.employer or '‚Äî' }}</td>
                                <td class="small">{{ c.follow_up_date or '‚Äî' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-person-x fs-4 d-block mb-1"></i>
                    ÏûÖÏÇ¨ ÌõÑÎ≥¥ÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
                {% endif %}
            </div>
            <div class="card-footer text-end">
                <a href="{{ url_for('contact_list') }}" class="btn btn-sm btn-outline-primary">
                    Ï†ÑÏ≤¥ Ïó∞ÎùΩÏ≤ò <i class="bi bi-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Ìå®Î∞ÄÎ¶¨ Ìä∏ÎûòÏª§ -->
<div class="row g-4 mb-4">
  {% for stat in family_stats %}
  <div class="col-12 col-md-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-{% if loop.first %}emoji-smile{% else %}heart{% endif %}"></i>
        <span class="fw-semibold">{{ stat.name }}</span>
      </div>
      <div class="card-body">

        <!-- ÎßàÏßÄÎßâ ÎÇ†Ïßú -->
        <div class="mb-3 text-center">
          <div class="text-muted small mb-1">ÎßàÏßÄÎßâÏúºÎ°ú {{ stat.name }}</div>
          <div class="fs-5 fw-semibold" id="family-last-{{ loop.index }}">
            {% if stat.last_date %}
              {{ stat.last_date }}
              <span class="text-muted small ms-1">({{ stat.days_since_last }}Ïùº Ï†Ñ)</span>
            {% else %}
              <span class="text-muted">ÏïÑÏßÅ Í∏∞Î°ù ÏóÜÏùå</span>
            {% endif %}
          </div>
        </div>

        <!-- ÌÜµÍ≥Ñ Î∞∞ÏßÄ -->
        <div class="d-flex gap-2 justify-content-center mb-3">
          <span class="badge bg-primary-subtle text-primary-emphasis">
            1ÎÖÑ ÌèâÍ∑† {{ (stat.yearly_count / 12) | round(1) }}Ìöå/Ïõî
          </span>
          <span class="badge bg-secondary-subtle text-secondary-emphasis">
            ÌïúÎã¨ {{ stat.monthly_count }}Ìöå
          </span>
        </div>

        <!-- ÎÇ†Ïßú ÏÑ†ÌÉù + Í∏∞Î°ù CTA -->
        <div class="d-flex gap-2">
          <input type="date" class="form-control form-control-sm"
                 id="family-date-{{ loop.index }}" value="{{ today_str_iso }}">
          <button class="btn btn-sm btn-primary text-nowrap"
                  onclick="familyToggle('{{ stat.name }}', {{ loop.index }}, event)">
            Í∏∞Î°ùÌïòÍ∏∞
          </button>
        </div>
        <div id="family-msg-{{ loop.index }}" class="text-center small mt-2" style="min-height:1.2em"></div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Books I am reading -->
<div class="card">
    <div class="card-header d-flex align-items-center gap-2">
        <i class="bi bi-book-half"></i>
        <span class="fw-semibold">Books I am reading</span>
        <span class="badge bg-success ms-auto">{{ reading_books|length }}Í∂å</span>
    </div>
    <div class="card-body">
        {% if reading_books %}
        <div class="row g-3">
            {% for book in reading_books %}
            <div class="col-12 col-sm-6 col-lg-4">
                <div class="d-flex align-items-start gap-2 p-2 border rounded">
                    <i class="bi bi-bookmark-fill text-success mt-1 flex-shrink-0"></i>
                    <div class="min-w-0">
                        <div class="fw-medium text-truncate">{{ book.title }}</div>
                        <div class="text-muted small">{{ book.author }}</div>
                        {% if book.added_at %}
                        <div class="text-muted" style="font-size: 0.75rem;">
                            Ï∂îÍ∞Ä: {{ book.added_at.strftime('%Y-%m-%d') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center text-muted py-3">
            <i class="bi bi-book fs-4 d-block mb-1"></i>
            ÌòÑÏû¨ ÏùΩÍ≥† ÏûàÎäî Ï±ÖÏù¥ ÏóÜÏäµÎãàÎã§.
        </div>
        {% endif %}
    </div>
    <div class="card-footer text-end">
        <a href="{{ url_for('book_reading') }}" class="btn btn-sm btn-outline-success">
            Reading Î™©Î°ù <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<!-- Edit Contact Modal (Unified with Contact List) -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ïó∞ÎùΩÏ≤ò Ìé∏Ïßë</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" name="name_hmac" id="editNameHmac">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Ïù¥Î¶Ñ</label>
                            <input type="text" class="form-control" name="name" id="editName" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Priority</label>
                            <select class="form-select" name="contact_priority" id="editCP">
                                <option value="">ÏÑ†ÌÉù</option>
                                <option>1A-Ïù∏ÏÉùÍ¥ÄÍ≥Ñ</option>
                                <option>1M-Mentor, ÏùÄÏù∏</option>
                                <option>1F-Family</option>
                                <option>2A-ÎπÑÏ¶àÎãàÏä§ Ïö∞ÏÑ†ÏàúÏúÑ</option>
                                <option>2C-ÎπÑÏ¶àÎãàÏä§</option>
                                <option>3A-Ïù∏Ï†Å Ïö∞ÏÑ†ÏàúÏúÑ</option>
                                <option>3C-Ïù∏Ï†Å ÎÑ§Ìä∏ÏõåÌÇπ</option>
                                <option>4A-Passive</option>
                                <option>5A-Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ÏÜåÏÜç</label>
                            <input type="text" class="form-control" name="employer" id="editEmployer">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ÏßÅÍ∏â</label>
                            <input type="text" class="form-control" name="title" id="editTitle">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Priority</label>
                            <select class="form-select" name="follow_up_priority" id="editFU">
                                <option value="FU9">FU9 (None)</option>
                                <option value="FU5">FU5 (Low)</option>
                                <option value="FU3">FU3 (Medium)</option>
                                <option value="FU1">FU1 (High)</option>
                                <option value="FU0">FU0 (Critical)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" name="follow_up_date" id="editFUDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Contact</label>
                            <input type="date" class="form-control" name="last_contact" id="editLastContact">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Follow-up Note</label>
                            <input type="text" class="form-control" name="follow_up_note" id="editFUNote">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone" id="editPhone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ÌÉúÍ∑∏</label>
                            <select class="form-select" name="tag" id="editTag">
                                <option value="">ÏÑ†ÌÉù</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred by</label>
                            <input type="text" class="form-control" name="referred_by" id="editReferredBy">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Key Value & Interest</label>
                            <input type="text" class="form-control" name="key_value_interest" id="editKVI">
                        </div>
                    </div>
                </form>
                <hr>
                <h6>Interaction Log</h6>
                <div id="interactionLogs" class="small text-muted">Î°úÎî© Ï§ë...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteContactBtn">ÏÇ≠Ï†ú</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" id="updateContactBtn">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
</div>

<!-- View/Edit Entity Modal (Unified with Business Opportunities) -->
<div class="modal fade" id="viewEntityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEntityTitle">ÏóîÌã∞Ìã∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="editEntityForm">
                            <input type="hidden" name="entity_hmac" id="editEntityHmac">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Business Priority</label>
                                    <select class="form-select" name="business_priority" id="editEntityBP">
                                        <option value="">ÏÑ†ÌÉù</option>
                                        <option value="0-Critical">0-Critical</option>
                                        <option value="1-High">1-High</option>
                                        <option value="2-Medium">2-Medium</option>
                                        <option value="3-Low">3-Low</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Priority</label>
                                    <select class="form-select" name="follow_up_priority" id="editEntityFU">
                                        <option value="FU9">FU9 (None)</option>
                                        <option value="FU5">FU5 (Low)</option>
                                        <option value="FU3">FU3 (Medium)</option>
                                        <option value="FU1">FU1 (High)</option>
                                        <option value="FU0">FU0 (Critical)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Date</label>
                                    <input type="date" class="form-control" name="follow_up_date" id="editEntityFUDate">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Last Contact</label>
                                    <input type="date" class="form-control" name="last_contact" id="editEntityLastContact">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">ÌÉúÍ∑∏</label>
                                    <select class="form-select" name="tag" id="editEntityTag">
                                        <option value="">ÏÑ†ÌÉù</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Follow-up Note</label>
                                    <input type="text" class="form-control" name="follow_up_note" id="editEntityFUNote">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Key Value & Interest</label>
                                    <input type="text" class="form-control" name="key_value_interest" id="editEntityKVI">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Referred by</label>
                                    <input type="text" class="form-control" name="referred_by" id="editEntityReferredBy">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Îã¥ÎãπÏûê</label>
                                    <input type="text" class="form-control" name="assignee" id="editEntityAssignee">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Related Individuals</label>
                                    <div id="relatedIndividualsArea" class="border rounded p-2 bg-light" style="min-height:60px">
                                        <small class="text-muted">Î°úÎî© Ï§ë...</small>
                                    </div>
                                    <input type="hidden" name="related_individuals" id="editEntityRelated">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-semibold">Opportunities</h6>
                            <button class="btn btn-outline-primary btn-sm" id="addOppBtn">
                                <i class="bi bi-plus-lg"></i> Ï∂îÍ∞Ä
                            </button>
                        </div>
                        <div id="opportunitiesList">
                            <p class="text-muted small">Î°úÎî© Ï§ë...</p>
                        </div>
                    </div>
                </div>
                <hr>
                <h6 class="fw-semibold">Interaction Log</h6>
                <div id="entityInteractionLogs" class="small text-muted">Î°úÎî© Ï§ë...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteEntityBtn">
                    <i class="bi bi-trash"></i> ÏÇ≠Ï†ú
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" id="updateEntityBtn">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Opportunity Modal -->
<div class="modal fade" id="oppModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oppModalTitle">Opportunity Ï∂îÍ∞Ä</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="oppEntityHmac">
                <input type="hidden" id="oppId">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-control" id="oppTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Details</label>
                    <textarea class="form-control" id="oppDetails" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ï∑®ÏÜå</button>
                <button type="button" class="btn btn-primary" id="saveOppBtn">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleHabit(btn) {
    const item = btn.closest('.habit-item');
    const habitName = item.dataset.habit;
    btn.disabled = true;

    fetch('/api/habits/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({habit_name: habitName})
    })
    .then(r => r.json())
    .then(data => {
        const done = data.action === 'done';
        btn.className = 'btn btn-sm habit-toggle-btn ' + (done ? 'btn-success' : 'btn-outline-primary');
        btn.innerHTML = done ? '<i class="bi bi-check-lg"></i> ÏôÑÎ£å' : 'Í∏∞Î°ùÌïòÍ∏∞';
        item.querySelector('.streak-badge').textContent = 'üî• ' + data.streak + 'Ïùº Ïó∞ÏÜç';
        item.querySelector('.total-badge').textContent = 'Ï¥ù ' + data.total + 'Ïùº';
        const bars = item.querySelectorAll('.habit-bar');
        data.days.forEach((day, i) => {
            bars[i].className = 'rounded-top habit-bar ' +
                (day.done ? 'bg-primary' : 'bg-secondary bg-opacity-25') +
                (day.is_today ? ' habit-bar-today' : '');
            bars[i].style.height = day.done ? '28px' : '8px';
        });
        btn.disabled = false;
    })
    .catch(() => { btn.disabled = false; });
}

(async function initDashboardEditableModal() {
    const contactQuickRows = document.querySelectorAll('.quickview-contact-row');
    const entityQuickRows = document.querySelectorAll('.quickview-entity-row');
    const editContactModalEl = document.getElementById('editContactModal');
    const viewEntityModalEl = document.getElementById('viewEntityModal');
    const oppModalEl = document.getElementById('oppModal');

    if (!contactQuickRows.length && !entityQuickRows.length) return;
    if (!editContactModalEl || !viewEntityModalEl || !oppModalEl || typeof bootstrap === 'undefined') return;

    const style = document.createElement('style');
    style.textContent = '.quickview-row{cursor:pointer;} .quickview-row:focus-visible{outline:2px solid var(--bs-primary);outline-offset:-2px;}';
    document.head.appendChild(style);

    const contactSeed = {{ (top5 + incoming)|tojson }};
    const entitySeed = {{ entity_top5|tojson }};
    const contactsById = new Map();
    const entitiesById = new Map();
    let currentEntityHmac = null;

    const editContactModal = bootstrap.Modal.getOrCreateInstance(editContactModalEl);
    const viewEntityModal = bootstrap.Modal.getOrCreateInstance(viewEntityModalEl);
    const oppModal = bootstrap.Modal.getOrCreateInstance(oppModalEl);

    function normalizeDateForInput(val) {
        if (!val) return '';
        if (/^\d{4}-\d{2}$/.test(val)) return `${val}-01`;
        if (/^\d{4}$/.test(val)) return `${val}-01-01`;
        return val;
    }

    function indexContacts(items) {
        (items || []).forEach((contact) => {
            if (contact && contact.name_hmac) contactsById.set(contact.name_hmac, contact);
        });
    }

    function indexEntities(items) {
        (items || []).forEach((entity) => {
            if (entity && entity.entity_hmac) entitiesById.set(entity.entity_hmac, entity);
        });
    }

    async function refreshContacts() {
        try {
            const res = await fetch('/api/contacts');
            const data = await res.json();
            if (data.error) return false;
            indexContacts(data.contacts || []);
            return true;
        } catch (_e) {
            return false;
        }
    }

    async function refreshEntities() {
        try {
            const res = await fetch('/api/entities');
            const data = await res.json();
            if (data.error) return false;
            indexEntities(data.entities || []);
            return true;
        } catch (_e) {
            return false;
        }
    }

    async function loadTags() {
        try {
            const res = await fetch('/api/tags');
            const data = await res.json();
            const tags = data.tags || [];
            ['editTag', 'editEntityTag'].forEach((id) => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const current = sel.value;
                sel.innerHTML = '<option value="">ÏÑ†ÌÉù</option>' + tags.map((t) => `<option value="${t}">${t}</option>`).join('');
                sel.value = current;
            });
        } catch (_e) {
            // no-op
        }
    }

    function updateUrlState(modalType, id, mode) {
        const url = new URL(window.location.href);
        if (modalType && id) {
            url.searchParams.set('modal', modalType);
            url.searchParams.set('id', id);
        } else {
            url.searchParams.delete('modal');
            url.searchParams.delete('id');
        }

        if (mode === 'push') {
            window.history.pushState({}, '', url);
            return;
        }
        window.history.replaceState({}, '', url);
    }

    async function ensureContact(nameHmac) {
        if (contactsById.has(nameHmac)) return contactsById.get(nameHmac);
        const ok = await refreshContacts();
        if (!ok) return null;
        return contactsById.get(nameHmac) || null;
    }

    async function ensureEntity(entityHmac) {
        if (entitiesById.has(entityHmac)) return entitiesById.get(entityHmac);
        const ok = await refreshEntities();
        if (!ok) return null;
        return entitiesById.get(entityHmac) || null;
    }

    async function openContactEdit(nameHmac, historyMode) {
        const contact = await ensureContact(nameHmac);
        if (!contact) return false;

        document.getElementById('editNameHmac').value = nameHmac;
        document.getElementById('editName').value = contact.name || '';
        document.getElementById('editCP').value = contact.contact_priority || '';
        document.getElementById('editEmployer').value = contact.employer || '';
        document.getElementById('editTitle').value = contact.title || '';
        document.getElementById('editFU').value = contact.follow_up_priority || 'FU9';
        document.getElementById('editFUDate').value = normalizeDateForInput(contact.follow_up_date || '');
        document.getElementById('editLastContact').value = normalizeDateForInput(contact.last_contact || '');
        document.getElementById('editFUNote').value = contact.follow_up_note || '';
        document.getElementById('editEmail').value = contact.email || '';
        document.getElementById('editPhone').value = contact.phone || '';
        document.getElementById('editTag').value = contact.tag || '';
        document.getElementById('editReferredBy').value = contact.referred_by || '';
        document.getElementById('editKVI').value = contact.key_value_interest || '';

        const logsDiv = document.getElementById('interactionLogs');
        logsDiv.innerHTML = 'Î°úÎî© Ï§ë...';
        try {
            const res = await fetch(`/api/contacts/${nameHmac}/logs`);
            const data = await res.json();
            const logs = data.logs || [];
            if (!logs.length) {
                logsDiv.innerHTML = '<p class="text-muted">Í∏∞Î°ù ÏóÜÏùå</p>';
            } else {
                logsDiv.innerHTML = logs.map((l) => `
                    <div class="border-bottom py-2">
                        <strong>${l.date}</strong> ‚Äî ${l.context}
                        ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                    </div>
                `).join('');
            }
        } catch (_e) {
            logsDiv.innerHTML = '<p class="text-danger">Î°úÍ∑∏ Î°úÎî© Ïã§Ìå®</p>';
        }

        viewEntityModal.hide();
        editContactModal.show();
        if (historyMode) updateUrlState('contact', nameHmac, historyMode);
        return true;
    }

    async function loadSuggestedContacts(entityHmac, relatedRaw) {
        const area = document.getElementById('relatedIndividualsArea');
        area.innerHTML = '<small class="text-muted">Î°úÎî© Ï§ë...</small>';

        try {
            const res = await fetch(`/api/entities/${entityHmac}/suggested-contacts`);
            const data = await res.json();
            const relatedSet = new Set((relatedRaw || '').split(',').map((s) => s.trim()).filter(Boolean));

            function renderContact(c) {
                const isChecked = relatedSet.has(c.name_hmac);
                const badgeHtml = c.match_reason
                    ? `<span class="badge bg-info text-dark ms-1" style="font-size:0.7em">${c.match_reason}</span>`
                    : '';
                return `<div class="form-check">
                    <input class="form-check-input related-check" type="checkbox" value="${c.name_hmac}" id="rc_${c.name_hmac}" ${isChecked ? 'checked' : ''}>
                    <label class="form-check-label" for="rc_${c.name_hmac}">${c.display_name}${badgeHtml}</label>
                </div>`;
            }

            let html = '';
            if (data.suggested && data.suggested.length) {
                html += '<div class="mb-2"><small class="text-muted fw-semibold">Ï∂îÏ≤ú (Employer Îß§Ïπ≠)</small></div>';
                html += data.suggested.map(renderContact).join('');
            }
            if (data.others && data.others.length) {
                if (html) html += '<hr class="my-2">';
                html += '<details><summary class="small text-muted" style="cursor:pointer">Í∏∞ÌÉÄ Ïó∞ÎùΩÏ≤ò ÎçîÎ≥¥Í∏∞</summary><div class="mt-1">';
                html += data.others.map(renderContact).join('');
                html += '</div></details>';
            }

            area.innerHTML = html || '<small class="text-muted">Ïó∞ÎùΩÏ≤ò ÏóÜÏùå</small>';
            area.querySelectorAll('.related-check').forEach((cb) => {
                cb.addEventListener('change', updateRelatedHidden);
            });
        } catch (_e) {
            area.innerHTML = '<small class="text-danger">Î°úÎìú Ïã§Ìå®</small>';
        }
    }

    function updateRelatedHidden() {
        const checked = Array.from(document.querySelectorAll('#relatedIndividualsArea .related-check:checked')).map((cb) => cb.value);
        document.getElementById('editEntityRelated').value = checked.join(', ');
    }

    async function loadOpportunities(entityHmac) {
        const listDiv = document.getElementById('opportunitiesList');
        listDiv.innerHTML = '<p class="text-muted small">Î°úÎî© Ï§ë...</p>';

        try {
            const res = await fetch(`/api/entities/${entityHmac}/opportunities`);
            const data = await res.json();
            const opps = data.opportunities || [];

            if (!opps.length) {
                listDiv.innerHTML = '<p class="text-muted small">Îì±Î°ùÎêú OpportunityÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            listDiv.innerHTML = opps.map((o) => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="fw-semibold">${o.title}</div>
                        <div>
                            <button class="btn btn-link btn-sm p-0 me-2 text-secondary"
                                onclick="openEditOpp('${entityHmac}', '${o.opp_id}', ${JSON.stringify(o.title).replace(/"/g, '&quot;')}, ${JSON.stringify(o.details || '').replace(/"/g, '&quot;')})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-link btn-sm p-0 text-danger"
                                onclick="deleteOpp('${entityHmac}', '${o.opp_id}')">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                    ${o.details ? `<div class="text-muted small mt-1">${o.details}</div>` : ''}
                    <div class="text-muted" style="font-size:0.75em">${o.created_date || ''}</div>
                </div>
            `).join('');
        } catch (_e) {
            listDiv.innerHTML = '<p class="text-danger small">Î°úÎìú Ïã§Ìå®</p>';
        }
    }

    async function loadEntityLogs(entityHmac) {
        const logsDiv = document.getElementById('entityInteractionLogs');
        logsDiv.innerHTML = 'Î°úÎî© Ï§ë...';
        try {
            const res = await fetch(`/api/entities/${entityHmac}/logs`);
            const data = await res.json();
            const logs = data.logs || [];
            if (!logs.length) {
                logsDiv.innerHTML = '<p class="text-muted">Í∏∞Î°ù ÏóÜÏùå</p>';
            } else {
                logsDiv.innerHTML = logs.map((l) => `
                    <div class="border-bottom py-2">
                        <strong>${l.date}</strong> ‚Äî ${l.context}
                        ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                    </div>
                `).join('');
            }
        } catch (_e) {
            logsDiv.innerHTML = '<p class="text-danger">Î°úÍ∑∏ Î°úÎî© Ïã§Ìå®</p>';
        }
    }

    async function openEntityEdit(entityHmac, historyMode) {
        const entity = await ensureEntity(entityHmac);
        if (!entity) return false;

        currentEntityHmac = entityHmac;

        document.getElementById('viewEntityTitle').textContent = entity.name || 'ÏóîÌã∞Ìã∞';
        document.getElementById('editEntityHmac').value = entityHmac;
        document.getElementById('editEntityBP').value = entity.business_priority || '';
        document.getElementById('editEntityFU').value = entity.follow_up_priority || 'FU9';
        document.getElementById('editEntityFUDate').value = normalizeDateForInput(entity.follow_up_date || '');
        document.getElementById('editEntityLastContact').value = normalizeDateForInput(entity.last_contact || '');
        document.getElementById('editEntityFUNote').value = entity.follow_up_note || '';
        document.getElementById('editEntityKVI').value = entity.key_value_interest || '';
        document.getElementById('editEntityReferredBy').value = entity.referred_by || '';
        document.getElementById('editEntityAssignee').value = entity.assignee || '';
        document.getElementById('editEntityTag').value = entity.tag || '';
        document.getElementById('editEntityRelated').value = entity.related_individuals || '';

        await Promise.all([
            loadSuggestedContacts(entityHmac, entity.related_individuals || ''),
            loadOpportunities(entityHmac),
            loadEntityLogs(entityHmac),
        ]);

        editContactModal.hide();
        viewEntityModal.show();
        if (historyMode) updateUrlState('entity', entityHmac, historyMode);
        return true;
    }

    async function syncModalWithUrl() {
        const params = new URLSearchParams(window.location.search);
        const modalType = params.get('modal');
        const id = params.get('id');

        if (modalType === 'contact' && id) {
            if (!await openContactEdit(id, null)) {
                editContactModal.hide();
                viewEntityModal.hide();
                updateUrlState(null, null, 'replace');
            }
            return;
        }
        if (modalType === 'entity' && id) {
            if (!await openEntityEdit(id, null)) {
                editContactModal.hide();
                viewEntityModal.hide();
                updateUrlState(null, null, 'replace');
            }
            return;
        }

        editContactModal.hide();
        viewEntityModal.hide();
    }

    function bindQuickRows(rows, key, opener) {
        rows.forEach((row) => {
            const itemId = row.dataset[key];
            if (!itemId) return;

            row.addEventListener('click', async (event) => {
                if (event.target.closest('a, button, input, select, textarea')) return;
                await opener(itemId, 'push');
            });
            row.addEventListener('keydown', async (event) => {
                if (event.key !== 'Enter' && event.key !== ' ') return;
                event.preventDefault();
                await opener(itemId, 'push');
            });
        });
    }

    document.getElementById('updateContactBtn').addEventListener('click', async () => {
        const nameHmac = document.getElementById('editNameHmac').value;
        const fields = ['contact_priority', 'employer', 'title', 'follow_up_priority', 'follow_up_date', 'follow_up_note', 'last_contact', 'email', 'phone', 'tag', 'referred_by', 'key_value_interest'];
        const form = document.getElementById('editContactForm');
        const formData = new FormData(form);
        const data = {};
        fields.forEach((f) => {
            const val = formData.get(f);
            if (val !== null) data[f] = val;
        });

        try {
            const res = await fetch(`/api/contacts/${nameHmac}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.error) {
                alert(result.errors ? result.errors.join('\n') : result.error);
                return;
            }
            editContactModal.hide();
            await refreshContacts();
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        }
    });

    document.getElementById('deleteContactBtn').addEventListener('click', async () => {
        if (!confirm('Ìú¥ÏßÄÌÜµÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        const nameHmac = document.getElementById('editNameHmac').value;
        try {
            const res = await fetch(`/api/contacts/${nameHmac}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            editContactModal.hide();
            window.location.reload();
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        }
    });

    document.getElementById('updateEntityBtn').addEventListener('click', async () => {
        const entityHmac = document.getElementById('editEntityHmac').value;
        const fields = ['business_priority', 'follow_up_priority', 'follow_up_date', 'follow_up_note', 'last_contact', 'tag', 'referred_by', 'assignee', 'key_value_interest', 'related_individuals'];
        const form = document.getElementById('editEntityForm');
        const formData = new FormData(form);
        const data = {};
        fields.forEach((f) => {
            const val = formData.get(f);
            if (val !== null) data[f] = val;
        });

        try {
            const res = await fetch(`/api/entities/${entityHmac}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data),
            });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            viewEntityModal.hide();
            await refreshEntities();
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        }
    });

    document.getElementById('deleteEntityBtn').addEventListener('click', async () => {
        if (!confirm('Ìú¥ÏßÄÌÜµÏúºÎ°ú Ïù¥ÎèôÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        const entityHmac = document.getElementById('editEntityHmac').value;
        try {
            const res = await fetch(`/api/entities/${entityHmac}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            viewEntityModal.hide();
            window.location.reload();
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        }
    });

    document.getElementById('addOppBtn').addEventListener('click', () => {
        document.getElementById('oppModalTitle').textContent = 'Opportunity Ï∂îÍ∞Ä';
        document.getElementById('oppEntityHmac').value = currentEntityHmac || '';
        document.getElementById('oppId').value = '';
        document.getElementById('oppTitle').value = '';
        document.getElementById('oppDetails').value = '';
        oppModal.show();
    });

    window.openEditOpp = function openEditOpp(entityHmac, oppId, title, details) {
        document.getElementById('oppModalTitle').textContent = 'Opportunity ÏàòÏ†ï';
        document.getElementById('oppEntityHmac').value = entityHmac;
        document.getElementById('oppId').value = oppId;
        document.getElementById('oppTitle').value = title || '';
        document.getElementById('oppDetails').value = details || '';
        oppModal.show();
    };

    window.deleteOpp = async function deleteOpp(entityHmac, oppId) {
        if (!confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        try {
            const res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, { method: 'DELETE' });
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            await loadOpportunities(entityHmac);
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        }
    };

    document.getElementById('saveOppBtn').addEventListener('click', async (event) => {
        const btn = event.currentTarget;
        if (btn.disabled) return;

        const entityHmac = document.getElementById('oppEntityHmac').value;
        const oppId = document.getElementById('oppId').value;
        const title = document.getElementById('oppTitle').value.trim();
        const details = document.getElementById('oppDetails').value.trim();

        if (!title) {
            alert('TitleÏùÄ ÌïÑÏàòÏûÖÎãàÎã§.');
            return;
        }

        btn.disabled = true;
        try {
            let res;
            if (oppId) {
                res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, details}),
                });
            } else {
                res = await fetch(`/api/entities/${entityHmac}/opportunities`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({title, details}),
                });
            }
            const result = await res.json();
            if (result.error) {
                alert(result.error);
                return;
            }
            oppModal.hide();
            await loadOpportunities(entityHmac);
        } catch (e) {
            alert('Ïò§Î•ò: ' + e.message);
        } finally {
            btn.disabled = false;
        }
    });

    bindQuickRows(contactQuickRows, 'contactId', openContactEdit);
    bindQuickRows(entityQuickRows, 'entityId', openEntityEdit);

    editContactModalEl.addEventListener('hidden.bs.modal', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('modal') === 'contact') updateUrlState(null, null, 'replace');
    });
    viewEntityModalEl.addEventListener('hidden.bs.modal', () => {
        const params = new URLSearchParams(window.location.search);
        if (params.get('modal') === 'entity') updateUrlState(null, null, 'replace');
    });

    window.addEventListener('popstate', () => {
        syncModalWithUrl();
    });

    indexContacts(contactSeed);
    indexEntities(entitySeed);
    await Promise.all([refreshContacts(), refreshEntities(), loadTags()]);
    await syncModalWithUrl();
})();

async function familyToggle(habitName, idx, event) {
    const dateVal = document.getElementById(`family-date-${idx}`).value;
    const btn = event.target;
    btn.disabled = true;
    try {
        const res = await fetch('/api/habits/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({habit_name: habitName, date: dateVal || undefined})
        });
        const data = await res.json();
        const msg = document.getElementById(`family-msg-${idx}`);
        if (data.action === 'done') {
            msg.textContent = `‚úì ${dateVal} Í∏∞Î°ù ÏôÑÎ£å`;
            msg.className = 'text-success text-center small mt-2';
        } else {
            msg.textContent = `${dateVal} Í∏∞Î°ù Ï∑®ÏÜå`;
            msg.className = 'text-muted text-center small mt-2';
        }
        if (data.last_date) {
            document.getElementById(`family-last-${idx}`).innerHTML =
                `<strong>${data.last_date}</strong>`;
        }
    } catch(e) {
        document.getElementById(`family-msg-${idx}`).textContent = 'Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.';
    } finally {
        btn.disabled = false;
    }
}
</script>
{% endblock %}
