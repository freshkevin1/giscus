{% extends "base.html" %}
{% block title %}Business Opportunities{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-briefcase"></i> Business Opportunities</h4>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEntityModal">
        <i class="bi bi-plus-lg"></i> 엔티티 추가
    </button>
</div>

<!-- Filter tabs -->
<ul class="nav nav-pills mb-3" id="entityFilterTabs">
    <li class="nav-item">
        <a class="nav-link active" href="#" data-filter="all">전체</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="overdue">Overdue</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="high">Critical/High</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="deleted">
            <i class="bi bi-trash"></i> 휴지통
            <span class="badge bg-secondary" id="deletedEntityCount" style="display:none">0</span>
        </a>
    </li>
</ul>

<!-- Entity table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="entityTable">
                <thead class="table-light">
                    <tr>
                        <th class="sortable" data-key="score" data-type="number" style="cursor:pointer">Score <i class="bi bi-chevron-down sort-icon"></i></th>
                        <th class="sortable" data-key="name" data-type="string" style="cursor:pointer">Name <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="business_priority" data-type="string" style="cursor:pointer">BP <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="follow_up_priority" data-type="string" style="cursor:pointer">FU <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="follow_up_date" data-type="date" style="cursor:pointer">FU Date <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="last_contact" data-type="date" style="cursor:pointer">Last Contact <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th>태그</th>
                        <th>#</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="entityBody">
                    <tr><td colspan="9" class="text-center text-muted py-4">로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Entity Modal -->
<div class="modal fade" id="addEntityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">엔티티 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addEntityForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">이름 *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Business Priority</label>
                            <select class="form-select" name="business_priority">
                                <option value="">선택</option>
                                <option value="0-Critical">0-Critical</option>
                                <option value="1-High">1-High</option>
                                <option value="2-Medium">2-Medium</option>
                                <option value="3-Low">3-Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Priority</label>
                            <select class="form-select" name="follow_up_priority">
                                <option value="FU9">FU9 (None)</option>
                                <option value="FU5">FU5 (Low)</option>
                                <option value="FU3">FU3 (Medium)</option>
                                <option value="FU1">FU1 (High)</option>
                                <option value="FU0">FU0 (Critical)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" name="follow_up_date">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Contact</label>
                            <input type="date" class="form-control" name="last_contact">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Follow-up Note</label>
                            <input type="text" class="form-control" name="follow_up_note">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">태그</label>
                            <select class="form-select" name="tag" id="addEntityTagSelect">
                                <option value="">선택</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred by</label>
                            <input type="text" class="form-control" name="referred_by">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Key Value & Interest</label>
                            <input type="text" class="form-control" name="key_value_interest">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveEntityBtn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- View/Edit Entity Modal -->
<div class="modal fade" id="viewEntityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewEntityTitle">엔티티</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left: Entity edit form -->
                    <div class="col-md-6">
                        <form id="editEntityForm">
                            <input type="hidden" name="entity_hmac" id="editEntityHmac">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Business Priority</label>
                                    <select class="form-select" name="business_priority" id="editEntityBP">
                                        <option value="">선택</option>
                                        <option value="0-Critical">0-Critical</option>
                                        <option value="1-High">1-High</option>
                                        <option value="2-Medium">2-Medium</option>
                                        <option value="3-Low">3-Low</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Priority</label>
                                    <select class="form-select" name="follow_up_priority" id="editEntityFU">
                                        <option value="FU9">FU9 (None)</option>
                                        <option value="FU5">FU5 (Low)</option>
                                        <option value="FU3">FU3 (Medium)</option>
                                        <option value="FU1">FU1 (High)</option>
                                        <option value="FU0">FU0 (Critical)</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Follow-up Date</label>
                                    <input type="date" class="form-control" name="follow_up_date" id="editEntityFUDate">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">Last Contact</label>
                                    <input type="date" class="form-control" name="last_contact" id="editEntityLastContact">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">태그</label>
                                    <select class="form-select" name="tag" id="editEntityTag">
                                        <option value="">선택</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Follow-up Note</label>
                                    <input type="text" class="form-control" name="follow_up_note" id="editEntityFUNote">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Key Value & Interest</label>
                                    <input type="text" class="form-control" name="key_value_interest" id="editEntityKVI">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Referred by</label>
                                    <input type="text" class="form-control" name="referred_by" id="editEntityReferredBy">
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Related Individuals</label>
                                    <div id="relatedIndividualsArea" class="border rounded p-2 bg-light" style="min-height:60px">
                                        <small class="text-muted">로딩 중...</small>
                                    </div>
                                    <input type="hidden" name="related_individuals" id="editEntityRelated">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Right: Opportunities -->
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-semibold">Opportunities</h6>
                            <button class="btn btn-outline-primary btn-sm" id="addOppBtn">
                                <i class="bi bi-plus-lg"></i> 추가
                            </button>
                        </div>
                        <div id="opportunitiesList">
                            <p class="text-muted small">로딩 중...</p>
                        </div>
                    </div>
                </div>

                <!-- Interaction Logs -->
                <hr>
                <h6 class="fw-semibold">Interaction Log</h6>
                <div id="entityInteractionLogs" class="small text-muted">로딩 중...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteEntityBtn">
                    <i class="bi bi-trash"></i> 삭제
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="updateEntityBtn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Opportunity Modal -->
<div class="modal fade" id="oppModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="oppModalTitle">Opportunity 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="oppEntityHmac">
                <input type="hidden" id="oppId">
                <div class="mb-3">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-control" id="oppTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label">Details</label>
                    <textarea class="form-control" id="oppDetails" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveOppBtn">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allEntities = [];
let deletedEntities = [];
let currentEntityFilter = 'all';
let entitySortKey = 'score';
let entitySortAsc = false;
let currentEntityHmac = null;

function normalizeDateForInput(val) {
    if (!val) return '';
    if (/^\d{4}-\d{2}$/.test(val)) return val + '-01';
    if (/^\d{4}$/.test(val)) return val + '-01-01';
    return val;
}

function isEntityOverdue(entity) {
    if (!entity.follow_up_date) return false;
    return new Date(entity.follow_up_date) < new Date();
}

function getScoreBadgeClass(score) {
    if (score >= 60) return 'bg-danger';
    if (score >= 40) return 'bg-warning text-dark';
    if (score >= 20) return 'bg-info text-dark';
    return 'bg-secondary';
}

function getBPBadgeClass(bp) {
    const map = {
        '0-Critical': 'bp-critical',
        '1-High': 'bp-high',
        '2-Medium': 'bp-medium',
        '3-Low': 'bp-low',
    };
    return map[bp] || 'badge bg-secondary';
}

function sortEntities(entities) {
    const th = document.querySelector(`#entityTable thead .sortable[data-key="${entitySortKey}"]`);
    const type = th ? th.dataset.type : 'string';
    return [...entities].sort((a, b) => {
        let aVal = a[entitySortKey] ?? '';
        let bVal = b[entitySortKey] ?? '';
        let cmp = 0;
        if (type === 'number') {
            cmp = (Number(aVal) || 0) - (Number(bVal) || 0);
        } else if (type === 'date') {
            const aTime = aVal ? new Date(aVal).getTime() : 0;
            const bTime = bVal ? new Date(bVal).getTime() : 0;
            cmp = aTime - bTime;
        } else {
            cmp = String(aVal).localeCompare(String(bVal), 'ko');
        }
        return entitySortAsc ? cmp : -cmp;
    });
}

async function loadEntities() {
    try {
        const res = await fetch('/api/entities');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        allEntities = data.entities;
        renderEntities();
    } catch (e) {
        document.getElementById('entityBody').innerHTML =
            `<tr><td colspan="9" class="text-center text-danger">${e.message}</td></tr>`;
    }
}

async function loadDeletedEntities() {
    try {
        const res = await fetch('/api/entities/deleted');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        deletedEntities = data.entities || [];
        const badge = document.getElementById('deletedEntityCount');
        if (deletedEntities.length > 0) {
            badge.textContent = deletedEntities.length;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
        if (currentEntityFilter === 'deleted') renderEntities();
    } catch (e) {
        console.error('Failed to load deleted entities:', e);
    }
}

async function loadEntityTags() {
    try {
        const res = await fetch('/api/tags');
        const data = await res.json();
        const tags = data.tags || [];
        ['addEntityTagSelect', 'editEntityTag'].forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">선택</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');
            sel.value = current;
        });
    } catch (e) {
        console.error('Failed to load tags:', e);
    }
}

function renderEntities() {
    const thead = document.querySelector('#entityTable thead');
    const tbody = document.getElementById('entityBody');

    if (currentEntityFilter === 'deleted') {
        thead.innerHTML = `<tr>
            <th>Name</th><th>BP</th><th>삭제일</th><th>삭제자</th><th>액션</th>
        </tr>`;
        renderDeletedEntities();
        return;
    }

    thead.innerHTML = `<tr>
        <th class="sortable" data-key="score" data-type="number" style="cursor:pointer">Score <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th class="sortable" data-key="name" data-type="string" style="cursor:pointer">Name <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th class="sortable" data-key="business_priority" data-type="string" style="cursor:pointer">BP <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th class="sortable" data-key="follow_up_priority" data-type="string" style="cursor:pointer">FU <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th class="sortable" data-key="follow_up_date" data-type="date" style="cursor:pointer">FU Date <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th class="sortable" data-key="last_contact" data-type="date" style="cursor:pointer">Last Contact <i class="bi bi-chevron-expand sort-icon"></i></th>
        <th>태그</th><th>#</th><th></th>
    </tr>`;

    let filtered = allEntities;
    if (currentEntityFilter === 'overdue') {
        filtered = allEntities.filter(e => isEntityOverdue(e));
    } else if (currentEntityFilter === 'high') {
        filtered = allEntities.filter(e =>
            e.business_priority === '0-Critical' || e.business_priority === '1-High'
        );
    }

    filtered = sortEntities(filtered);

    // Update sort icons and bind clicks
    document.querySelectorAll('#entityTable thead .sortable .sort-icon').forEach(icon => {
        const th = icon.closest('th');
        if (th.dataset.key === entitySortKey) {
            icon.className = entitySortAsc ? 'bi bi-chevron-up sort-icon' : 'bi bi-chevron-down sort-icon';
        } else {
            icon.className = 'bi bi-chevron-expand sort-icon';
        }
    });
    document.querySelectorAll('#entityTable thead .sortable').forEach(th => {
        th.onclick = () => {
            const key = th.dataset.key;
            if (entitySortKey === key) {
                entitySortAsc = !entitySortAsc;
            } else {
                entitySortKey = key;
                entitySortAsc = th.dataset.type === 'number' ? false : true;
            }
            renderEntities();
        };
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4">엔티티가 없습니다.</td></tr>';
        return;
    }

    // We'll load opportunity counts asynchronously — start with placeholder
    tbody.innerHTML = filtered.map(e => {
        const overdueClass = isEntityOverdue(e) ? 'table-warning overdue-row' : '';
        const bpClass = getBPBadgeClass(e.business_priority);
        return `<tr class="${overdueClass}" style="cursor:pointer" onclick="openEntityView('${e.entity_hmac}')">
            <td><span class="badge ${getScoreBadgeClass(e.score)} score-badge">${e.score}</span></td>
            <td class="fw-semibold">${e.name}</td>
            <td>${e.business_priority ? `<span class="badge ${bpClass}">${e.business_priority}</span>` : '-'}</td>
            <td><small>${e.follow_up_priority || '-'}</small></td>
            <td class="${isEntityOverdue(e) ? 'text-danger fw-bold' : ''}">${e.follow_up_date || '-'}</td>
            <td>${e.last_contact || '-'}</td>
            <td>${e.tag ? `<span class="badge bg-light text-dark">${e.tag}</span>` : ''}</td>
            <td class="opp-count" data-hmac="${e.entity_hmac}"><span class="text-muted">-</span></td>
            <td><i class="bi bi-chevron-right text-muted"></i></td>
        </tr>`;
    }).join('');
}

function renderDeletedEntities() {
    const tbody = document.getElementById('entityBody');
    if (deletedEntities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">휴지통이 비어 있습니다.</td></tr>';
        return;
    }
    tbody.innerHTML = deletedEntities.map(e => `<tr>
        <td class="fw-semibold">${e.name}</td>
        <td>${e.business_priority ? `<span class="badge ${getBPBadgeClass(e.business_priority)}">${e.business_priority}</span>` : '-'}</td>
        <td class="small">${e.deleted_date || '-'}</td>
        <td><span class="badge ${e.deleted_by === 'AI' ? 'bg-info' : 'bg-secondary'}">${e.deleted_by || '-'}</span></td>
        <td>
            <button class="btn btn-outline-success btn-sm me-1" onclick="restoreEntity('${e.entity_hmac}')">
                <i class="bi bi-arrow-counterclockwise"></i> 복원
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="permanentDeleteEntity('${e.entity_hmac}')">
                <i class="bi bi-x-lg"></i> 영구삭제
            </button>
        </td>
    </tr>`).join('');
}

// Filter tabs
document.getElementById('entityFilterTabs').addEventListener('click', e => {
    if (e.target.dataset.filter) {
        e.preventDefault();
        document.querySelectorAll('#entityFilterTabs .nav-link').forEach(n => n.classList.remove('active'));
        e.target.classList.add('active');
        currentEntityFilter = e.target.dataset.filter;
        renderEntities();
    }
});

// Add entity
document.getElementById('saveEntityBtn').addEventListener('click', async () => {
    const form = document.getElementById('addEntityForm');
    const data = {};
    new FormData(form).forEach((v, k) => { if (v) data[k] = v; });

    if (!data.name) { alert('이름은 필수입니다.'); return; }

    try {
        const res = await fetch('/api/entities', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        bootstrap.Modal.getInstance(document.getElementById('addEntityModal')).hide();
        form.reset();
        loadEntities();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Open View modal
async function openEntityView(entityHmac) {
    const entity = allEntities.find(e => e.entity_hmac === entityHmac);
    if (!entity) return;

    currentEntityHmac = entityHmac;

    document.getElementById('viewEntityTitle').textContent = entity.name;
    document.getElementById('editEntityHmac').value = entityHmac;
    document.getElementById('editEntityBP').value = entity.business_priority || '';
    document.getElementById('editEntityFU').value = entity.follow_up_priority || 'FU9';
    document.getElementById('editEntityFUDate').value = normalizeDateForInput(entity.follow_up_date || '');
    document.getElementById('editEntityLastContact').value = normalizeDateForInput(entity.last_contact || '');
    document.getElementById('editEntityFUNote').value = entity.follow_up_note || '';
    document.getElementById('editEntityKVI').value = entity.key_value_interest || '';
    document.getElementById('editEntityReferredBy').value = entity.referred_by || '';
    document.getElementById('editEntityTag').value = entity.tag || '';
    document.getElementById('editEntityRelated').value = entity.related_individuals || '';

    // Load suggested contacts for Related Individuals
    loadSuggestedContacts(entityHmac, entity.related_individuals || '');

    // Load opportunities
    loadOpportunities(entityHmac);

    // Load interaction logs
    loadEntityLogs(entityHmac);

    new bootstrap.Modal(document.getElementById('viewEntityModal')).show();
}

async function loadSuggestedContacts(entityHmac, relatedRaw) {
    const area = document.getElementById('relatedIndividualsArea');
    area.innerHTML = '<small class="text-muted">로딩 중...</small>';

    try {
        const res = await fetch(`/api/entities/${entityHmac}/suggested-contacts`);
        const data = await res.json();

        const relatedSet = new Set(relatedRaw.split(',').map(s => s.trim()).filter(Boolean));

        function renderContact(c) {
            const isChecked = relatedSet.has(c.name_hmac);
            const badgeHtml = c.match_reason
                ? `<span class="badge bg-info text-dark ms-1" style="font-size:0.7em">${c.match_reason}</span>`
                : '';
            return `<div class="form-check">
                <input class="form-check-input related-check" type="checkbox"
                    value="${c.name_hmac}" id="rc_${c.name_hmac}"
                    ${isChecked ? 'checked' : ''}>
                <label class="form-check-label" for="rc_${c.name_hmac}">
                    ${c.display_name}${badgeHtml}
                </label>
            </div>`;
        }

        let html = '';
        if (data.suggested && data.suggested.length > 0) {
            html += '<div class="mb-2"><small class="text-muted fw-semibold">추천 (Employer 매칭)</small></div>';
            html += data.suggested.map(renderContact).join('');
        }
        if (data.others && data.others.length > 0) {
            if (data.suggested && data.suggested.length > 0) {
                html += '<hr class="my-2">';
            }
            html += '<details><summary class="small text-muted" style="cursor:pointer">기타 연락처 더보기</summary><div class="mt-1">';
            html += data.others.map(renderContact).join('');
            html += '</div></details>';
        }

        area.innerHTML = html || '<small class="text-muted">연락처 없음</small>';

        // Bind change events to update hidden input
        area.querySelectorAll('.related-check').forEach(cb => {
            cb.addEventListener('change', updateRelatedHidden);
        });
    } catch (e) {
        area.innerHTML = '<small class="text-danger">로드 실패</small>';
    }
}

function updateRelatedHidden() {
    const checked = Array.from(
        document.querySelectorAll('#relatedIndividualsArea .related-check:checked')
    ).map(cb => cb.value);
    document.getElementById('editEntityRelated').value = checked.join(', ');
}

async function loadOpportunities(entityHmac) {
    const listDiv = document.getElementById('opportunitiesList');
    listDiv.innerHTML = '<p class="text-muted small">로딩 중...</p>';

    try {
        const res = await fetch(`/api/entities/${entityHmac}/opportunities`);
        const data = await res.json();
        const opps = data.opportunities || [];

        // Update opp count badge in main table
        const cell = document.querySelector(`#entityBody .opp-count[data-hmac="${entityHmac}"]`);
        if (cell) cell.innerHTML = opps.length > 0
            ? `<span class="badge bg-primary">${opps.length}</span>`
            : '<span class="text-muted">0</span>';

        if (opps.length === 0) {
            listDiv.innerHTML = '<p class="text-muted small">등록된 Opportunity가 없습니다.</p>';
            return;
        }

        listDiv.innerHTML = opps.map(o => `
            <div class="border rounded p-2 mb-2">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="fw-semibold">${o.title}</div>
                    <div>
                        <button class="btn btn-link btn-sm p-0 me-2 text-secondary"
                            onclick="openEditOpp('${entityHmac}', '${o.opp_id}', ${JSON.stringify(o.title).replace(/"/g, '&quot;')}, ${JSON.stringify(o.details || '').replace(/"/g, '&quot;')})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-link btn-sm p-0 text-danger"
                            onclick="deleteOpp('${entityHmac}', '${o.opp_id}')">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                ${o.details ? `<div class="text-muted small mt-1">${o.details}</div>` : ''}
                <div class="text-muted" style="font-size:0.75em">${o.created_date || ''}</div>
            </div>
        `).join('');
    } catch (e) {
        listDiv.innerHTML = '<p class="text-danger small">로드 실패</p>';
    }
}

async function loadEntityLogs(entityHmac) {
    const logsDiv = document.getElementById('entityInteractionLogs');
    logsDiv.innerHTML = '로딩 중...';
    try {
        const res = await fetch(`/api/entities/${entityHmac}/logs`);
        const data = await res.json();
        const logs = data.logs || [];
        if (logs.length === 0) {
            logsDiv.innerHTML = '<p class="text-muted">기록 없음</p>';
        } else {
            logsDiv.innerHTML = logs.map(l =>
                `<div class="border-bottom py-2">
                    <strong>${l.date}</strong> — ${l.context}
                    ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                </div>`
            ).join('');
        }
    } catch (e) {
        logsDiv.innerHTML = '<p class="text-danger">로그 로딩 실패</p>';
    }
}

// Update entity
document.getElementById('updateEntityBtn').addEventListener('click', async () => {
    const entityHmac = document.getElementById('editEntityHmac').value;
    const form = document.getElementById('editEntityForm');
    const formData = new FormData(form);
    const data = {};
    const fields = ['business_priority', 'follow_up_priority', 'follow_up_date',
                    'follow_up_note', 'last_contact', 'tag', 'referred_by',
                    'key_value_interest', 'related_individuals'];
    fields.forEach(f => {
        const val = formData.get(f);
        if (val !== null) data[f] = val;
    });

    try {
        const res = await fetch(`/api/entities/${entityHmac}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        bootstrap.Modal.getInstance(document.getElementById('viewEntityModal')).hide();
        loadEntities();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Delete entity
document.getElementById('deleteEntityBtn').addEventListener('click', async () => {
    if (!confirm('휴지통으로 이동하시겠습니까?')) return;
    const entityHmac = document.getElementById('editEntityHmac').value;
    try {
        const res = await fetch(`/api/entities/${entityHmac}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        bootstrap.Modal.getInstance(document.getElementById('viewEntityModal')).hide();
        loadEntities();
        loadDeletedEntities();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

async function restoreEntity(entityHmac) {
    if (!confirm('복원하시겠습니까?')) return;
    try {
        const res = await fetch(`/api/entities/${entityHmac}/restore`, { method: 'POST' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        loadEntities();
        loadDeletedEntities();
    } catch (e) {
        alert('오류: ' + e.message);
    }
}

async function permanentDeleteEntity(entityHmac) {
    if (!confirm('영구 삭제하시겠습니까? 되돌릴 수 없습니다.')) return;
    try {
        const res = await fetch(`/api/entities/${entityHmac}/permanent`, { method: 'DELETE' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        loadDeletedEntities();
    } catch (e) {
        alert('오류: ' + e.message);
    }
}

// Add Opportunity button
document.getElementById('addOppBtn').addEventListener('click', () => {
    document.getElementById('oppModalTitle').textContent = 'Opportunity 추가';
    document.getElementById('oppEntityHmac').value = currentEntityHmac;
    document.getElementById('oppId').value = '';
    document.getElementById('oppTitle').value = '';
    document.getElementById('oppDetails').value = '';
    new bootstrap.Modal(document.getElementById('oppModal')).show();
});

function openEditOpp(entityHmac, oppId, title, details) {
    document.getElementById('oppModalTitle').textContent = 'Opportunity 수정';
    document.getElementById('oppEntityHmac').value = entityHmac;
    document.getElementById('oppId').value = oppId;
    document.getElementById('oppTitle').value = title;
    document.getElementById('oppDetails').value = details;
    new bootstrap.Modal(document.getElementById('oppModal')).show();
}

// Save Opportunity
document.getElementById('saveOppBtn').addEventListener('click', async () => {
    const entityHmac = document.getElementById('oppEntityHmac').value;
    const oppId = document.getElementById('oppId').value;
    const title = document.getElementById('oppTitle').value.trim();
    const details = document.getElementById('oppDetails').value.trim();

    if (!title) { alert('Title은 필수입니다.'); return; }

    try {
        let res;
        if (oppId) {
            res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, details}),
            });
        } else {
            res = await fetch(`/api/entities/${entityHmac}/opportunities`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, details}),
            });
        }
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        bootstrap.Modal.getInstance(document.getElementById('oppModal')).hide();
        loadOpportunities(entityHmac);
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

async function deleteOpp(entityHmac, oppId) {
    if (!confirm('삭제하시겠습니까?')) return;
    try {
        const res = await fetch(`/api/entities/${entityHmac}/opportunities/${oppId}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        loadOpportunities(entityHmac);
    } catch (e) {
        alert('오류: ' + e.message);
    }
}

// Init
loadEntities();
loadEntityTags();
loadDeletedEntities();
</script>
{% endblock %}
