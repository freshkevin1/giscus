<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <script>
    (function(){
      var t = localStorage.getItem('theme') ||
        (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      document.documentElement.setAttribute('data-bs-theme', t);
    })();
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#1a1d23">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="vapid-public-key" content="{{ vapid_public_key }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/icon-192.png') }}">
    <title>{% block title %}Executive Dashboard{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Fraunces:opsz,wght@9..144,600&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <!-- Mobile top bar -->
    <nav class="navbar d-md-none mobile-topbar">
        <div class="container-fluid">
            <button class="btn btn-link text-white p-0" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
                <i class="bi bi-list" style="font-size:1.5rem"></i>
            </button>
            <span class="navbar-brand text-white mb-0">{% block mobile_title %}Dashboard{% endblock %}</span>
            <button id="themeToggleMobile" class="btn btn-link text-white p-0" style="width:40px">
                <i class="bi bi-moon-fill" id="themeIconMobile"></i>
            </button>
        </div>
    </nav>

    <!-- Offcanvas sidebar (mobile) -->
    <div class="offcanvas offcanvas-start d-md-none" id="sidebarOffcanvas"
         style="width:250px; background-color:#1a1d23">
        <div class="offcanvas-header">
            <a href="{{ url_for('index') }}" class="sidebar-brand">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body p-0 d-flex flex-column">
            {% include "_sidebar_nav.html" %}
        </div>
    </div>

    <div class="d-flex vh-100">
        <!-- Desktop sidebar -->
        <nav id="sidebar" class="sidebar d-none d-md-flex flex-column p-3">
            <a href="{{ url_for('index') }}" class="sidebar-brand mb-4">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            {% include "_sidebar_nav.html" %}
            <div class="mt-auto pt-3 border-top border-secondary">
                <button id="themeToggle" class="btn btn-sm w-100 text-start text-secondary"
                        style="background:transparent; border:none;">
                    <i class="bi bi-moon-fill" id="themeIcon"></i>
                    <span id="themeLabel" class="ms-2">다크 모드</span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content flex-grow-1">
            <div class="container-fluid p-4">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endfor %}
                {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function () {
        const tokenEl = document.querySelector('meta[name="csrf-token"]');
        if (!tokenEl) return;
        const csrfToken = tokenEl.content;
        const safeMethods = new Set(["GET", "HEAD", "OPTIONS", "TRACE"]);

        const originalFetch = window.fetch.bind(window);
        window.fetch = function (input, init) {
            const options = init ? { ...init } : {};
            const method = (options.method || "GET").toUpperCase();

            if (!safeMethods.has(method)) {
                const headers = new Headers(options.headers || {});
                if (!headers.has("X-CSRFToken")) {
                    headers.set("X-CSRFToken", csrfToken);
                }
                options.headers = headers;
            }

            return originalFetch(input, options);
        };

        document.querySelectorAll("form").forEach((form) => {
            const method = (form.getAttribute("method") || "GET").toUpperCase();
            if (safeMethods.has(method)) return;
            if (form.querySelector('input[name="csrf_token"]')) return;

            const tokenInput = document.createElement("input");
            tokenInput.type = "hidden";
            tokenInput.name = "csrf_token";
            tokenInput.value = csrfToken;
            form.appendChild(tokenInput);
        });
    })();
    </script>
    <script>
    (function(){
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-bs-theme', theme);
            var isDark = theme === 'dark';
            var icon = isDark ? 'bi-sun-fill' : 'bi-moon-fill';
            var label = isDark ? '라이트 모드' : '다크 모드';
            document.querySelector('meta[name="theme-color"]').content = '#1a1d23';
            document.getElementById('themeIcon').className = 'bi ' + icon;
            document.getElementById('themeLabel').textContent = label;
            document.getElementById('themeIconMobile').className = 'bi ' + icon;
        }

        function toggle() {
            var cur = document.documentElement.getAttribute('data-bs-theme');
            var next = cur === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', next);
            applyTheme(next);
        }

        document.getElementById('themeToggle').addEventListener('click', toggle);
        document.getElementById('themeToggleMobile').addEventListener('click', toggle);

        applyTheme(document.documentElement.getAttribute('data-bs-theme') || 'light');
    })();
    </script>
    {% block scripts %}{% endblock %}
    <script>
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('/sw.js').then(function(reg) {
            window._swReg = reg;
            reg.pushManager.getSubscription().then(function(sub) {
                _updateBellUI(!!sub);
            });
        });
    }

    function urlBase64ToUint8Array(b64) {
        const pad = '='.repeat((4 - b64.length % 4) % 4);
        const raw = atob((b64 + pad).replace(/-/g, '+').replace(/_/g, '/'));
        return Uint8Array.from(raw, c => c.charCodeAt(0));
    }

    function _updateBellUI(active) {
        document.querySelectorAll('.push-bell-btn').forEach(function(btn) {
            btn.querySelector('i').className = active
                ? 'bi bi-bell-fill text-warning'
                : 'bi bi-bell text-secondary';
            btn.title = active ? '알림 켜짐 (클릭하여 끄기)' : '알림 끄짐 (클릭하여 켜기)';
        });
    }

    window._togglePushNotification = function() {
        if (!window._swReg) return;
        window._swReg.pushManager.getSubscription().then(function(sub) {
            if (sub) {
                sub.unsubscribe().then(function() {
                    fetch('/api/push/unsubscribe', {
                        method: 'DELETE',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ endpoint: sub.endpoint })
                    });
                    _updateBellUI(false);
                });
            } else {
                var key = document.querySelector('meta[name="vapid-public-key"]').content;
                if (!key) return;
                Notification.requestPermission().then(function(permission) {
                    if (permission !== 'granted') return;
                    window._swReg.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(key)
                    }).then(function(newSub) {
                        fetch('/api/push/subscribe', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(newSub.toJSON())
                        });
                        _updateBellUI(true);
                    }).catch(function(e) {
                        console.error('Push subscribe failed:', e);
                    });
                });
            }
        });
    };
    </script>
</body>
</html>
