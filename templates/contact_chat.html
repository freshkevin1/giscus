{% extends "base.html" %}
{% block title %}AI Chat - Contact List{% endblock %}
{% block mobile_title %}AI Chat{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0"><i class="bi bi-chat-dots"></i> AI Chat</h4>
    <button class="btn btn-outline-secondary btn-sm" id="clearChatBtn">
        <i class="bi bi-trash"></i> 대화 초기화
    </button>
</div>

<!-- Suggestion chips -->
<div class="mb-3" id="suggestionChips">
    <button class="btn btn-outline-primary btn-sm me-1 suggestion-chip" data-msg="어제 김민수 부장님 만남">Quick Log 예시</button>
    <button class="btn btn-outline-primary btn-sm me-1 suggestion-chip" data-msg="삼성전자에 아는 사람 있어?">검색 예시</button>
    <button class="btn btn-outline-primary btn-sm me-1 suggestion-chip" data-msg="오늘 연락할 사람 추천해줘">우선순위 추천</button>
</div>

<!-- Chat area -->
<div class="card chat-card">
    <div class="card-body p-0">
        <div id="chatMessages" class="chat-messages p-3">
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-dots" style="font-size:2rem"></i>
                <p class="mt-2">연락처 관리 AI 비서입니다.<br>만남 기록, 연락처 검색, 정보 업데이트를 도와드립니다.</p>
            </div>
        </div>
    </div>
    <div class="card-footer p-3">
        <form id="chatForm" class="d-flex gap-2">
            <input type="text" class="form-control" id="chatInput"
                   placeholder="메시지를 입력하세요..." autocomplete="off">
            <button type="submit" class="btn btn-primary" id="sendBtn">
                <i class="bi bi-send"></i>
            </button>
        </form>
    </div>
</div>

<!-- Confirm Action Modal -->
<div class="modal fade" id="confirmActionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">액션 확인</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmActionBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="confirmActionBtn">실행</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let pendingAction = null;

// Load chat history
async function loadHistory() {
    try {
        const res = await fetch('/api/chat/history');
        const data = await res.json();
        const messages = data.messages || [];
        if (messages.length === 0) return;

        const container = document.getElementById('chatMessages');
        container.innerHTML = '';
        messages.forEach(m => {
            appendMessage(m.role, m.content);
        });
        scrollToBottom();
    } catch (e) {
        console.error('Failed to load history:', e);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatMessage(text) {
    let html = escapeHtml(text);
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\n/g, '<br>');
    return html;
}

function appendMessage(role, content) {
    const container = document.getElementById('chatMessages');
    const welcome = container.querySelector('.text-center.text-muted');
    if (welcome) welcome.remove();

    const wrapper = document.createElement('div');
    wrapper.className = `chat-bubble-wrapper ${role === 'user' ? 'user-msg' : 'assistant-msg'}`;

    const bubble = document.createElement('div');
    bubble.className = `chat-bubble ${role === 'user' ? 'bubble-user' : 'bubble-assistant'}`;
    bubble.innerHTML = formatMessage(content);

    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
}

function appendTypingIndicator() {
    const container = document.getElementById('chatMessages');
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-bubble-wrapper assistant-msg';
    wrapper.id = 'typingIndicator';

    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble bubble-assistant';
    bubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';

    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
    scrollToBottom();
}

function removeTypingIndicator() {
    const el = document.getElementById('typingIndicator');
    if (el) el.remove();
}

function appendActionResult(actions, type) {
    const container = document.getElementById('chatMessages');
    actions.forEach(a => {
        const div = document.createElement('div');
        div.className = 'action-result mx-3 mb-2';

        if (type === 'executed') {
            if (a.type === 'update') {
                const fields = Object.entries(a.fields || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
                div.innerHTML = `<div class="alert alert-success py-2 small mb-0">
                    <i class="bi bi-check-circle"></i> <strong>${a.name}</strong> 업데이트 완료: ${fields}
                </div>`;
            } else if (a.type === 'add') {
                div.innerHTML = `<div class="alert alert-success py-2 small mb-0">
                    <i class="bi bi-plus-circle"></i> <strong>${a.name}</strong> 연락처 추가 완료
                </div>`;
            } else if (a.type === 'delete') {
                div.innerHTML = `<div class="alert alert-warning py-2 small mb-0">
                    <i class="bi bi-trash"></i> <strong>${a.name}</strong> 휴지통으로 이동 완료
                </div>`;
            } else if (a.type === 'search') {
                const results = (a.results || []).map(r => {
                    const display = r.employer ? `${r.name}(${r.employer})` : r.name;
                    return `${display} - ${r.contact_priority || ''} ${r.title || ''}`;
                }).join('<br>');
                div.innerHTML = `<div class="alert alert-info py-2 small mb-0">
                    <i class="bi bi-search"></i> 검색 결과:<br>${results || '결과 없음'}
                </div>`;
            }
        } else if (type === 'pending') {
            const fields = Object.entries(a.fields || {}).map(([k, v]) => `${k}: ${v}`).join(', ');
            let reason = a.reason || '확인이 필요합니다';

            let candidatesHtml = '';
            if (a.candidates && a.candidates.length > 1) {
                candidatesHtml = '<div class="mt-2">' +
                    a.candidates.map(c =>
                        `<button class="btn btn-outline-primary btn-sm me-1 mb-1 candidate-btn"
                                 data-hmac="${c.name_hmac}">${c.name}(${c.employer || '미상'})</button>`
                    ).join('') + '</div>';
            }

            div.innerHTML = `<div class="alert alert-warning py-2 small mb-0">
                <i class="bi bi-question-circle"></i> <strong>${a.name}</strong>: ${reason}
                <br><small>${fields}</small>
                ${candidatesHtml}
                ${!a.candidates ? `<br><button class="btn btn-primary btn-sm mt-1 confirm-pending-btn">확인 후 실행</button>` : ''}
            </div>`;
        }

        container.appendChild(div);
    });
}

function scrollToBottom() {
    const container = document.getElementById('chatMessages');
    container.scrollTop = container.scrollHeight;
}

// Send message
document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    appendMessage('user', message);
    input.value = '';
    scrollToBottom();

    appendTypingIndicator();
    document.getElementById('sendBtn').disabled = true;

    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message}),
        });
        const data = await res.json();
        removeTypingIndicator();

        if (data.error) {
            appendMessage('assistant', `오류가 발생했습니다: ${data.error}`);
        } else {
            appendMessage('assistant', data.message);

            if (data.executed_actions && data.executed_actions.length > 0) {
                appendActionResult(data.executed_actions, 'executed');
            }
            if (data.pending_actions && data.pending_actions.length > 0) {
                appendActionResult(data.pending_actions, 'pending');
            }
        }
    } catch (err) {
        removeTypingIndicator();
        appendMessage('assistant', `오류: ${err.message}`);
    }

    document.getElementById('sendBtn').disabled = false;
    scrollToBottom();
});

// Suggestion chips
document.getElementById('suggestionChips').addEventListener('click', (e) => {
    const chip = e.target.closest('.suggestion-chip');
    if (!chip) return;
    document.getElementById('chatInput').value = chip.dataset.msg;
    document.getElementById('chatInput').focus();
});

// Handle confirm/candidate button clicks (event delegation)
document.getElementById('chatMessages').addEventListener('click', async (e) => {
    const candidateBtn = e.target.closest('.candidate-btn');
    if (candidateBtn) {
        const hmac = candidateBtn.dataset.hmac;
        const alertDiv = candidateBtn.closest('.alert');
        if (pendingAction) {
            try {
                const res = await fetch('/api/chat/confirm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: pendingAction, selected_hmac: hmac}),
                });
                const data = await res.json();
                if (data.success) {
                    alertDiv.className = 'alert alert-success py-2 small mb-0';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> 업데이트 완료';
                } else {
                    alertDiv.innerHTML += `<br><small class="text-danger">${data.error}</small>`;
                }
            } catch (err) {
                alertDiv.innerHTML += `<br><small class="text-danger">오류: ${err.message}</small>`;
            }
        }
        return;
    }

    const confirmBtn = e.target.closest('.confirm-pending-btn');
    if (confirmBtn) {
        const alertDiv = confirmBtn.closest('.alert');
        if (pendingAction) {
            try {
                const res = await fetch('/api/chat/confirm', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: pendingAction}),
                });
                const data = await res.json();
                if (data.success) {
                    alertDiv.className = 'alert alert-success py-2 small mb-0';
                    alertDiv.innerHTML = '<i class="bi bi-check-circle"></i> 실행 완료';
                } else {
                    alertDiv.innerHTML += `<br><small class="text-danger">${data.error}</small>`;
                }
            } catch (err) {
                alertDiv.innerHTML += `<br><small class="text-danger">오류: ${err.message}</small>`;
            }
        }
    }
});

// Track pending actions from chat responses
const originalFetch = window.fetch;
window.fetch = async function(...args) {
    const response = await originalFetch.apply(this, args);
    const cloned = response.clone();
    if (args[0] === '/api/chat' && args[1]?.method === 'POST') {
        try {
            const data = await cloned.json();
            if (data.pending_actions && data.pending_actions.length > 0) {
                pendingAction = data.pending_actions[data.pending_actions.length - 1];
            }
        } catch (e) {}
    }
    return response;
};

// Clear chat
document.getElementById('clearChatBtn').addEventListener('click', async () => {
    if (!confirm('대화 기록을 모두 삭제하시겠습니까?')) return;
    try {
        await fetch('/api/chat/clear', {method: 'POST'});
        document.getElementById('chatMessages').innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-dots" style="font-size:2rem"></i>
                <p class="mt-2">연락처 관리 AI 비서입니다.<br>만남 기록, 연락처 검색, 정보 업데이트를 도와드립니다.</p>
            </div>`;
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Init
loadHistory();
</script>
{% endblock %}
