{% extends "base.html" %}
{% block title %}로봇 & AI 신문 - Dashboard{% endblock %}
{% block mobile_title %}로봇 & AI 신문{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-robot"></i> 로봇 & AI 신문</h2>
    <div class="d-flex gap-2 flex-shrink-0">
        <button id="btn-read-all" class="btn btn-outline-success btn-sm">
            <i class="bi bi-check-all"></i><span class="d-none d-sm-inline"> 모두 읽음</span>
        </button>
        <button id="btn-scrape" class="btn btn-primary btn-sm">
            <i class="bi bi-arrow-clockwise"></i><span class="d-none d-sm-inline"> 스크래핑</span>
        </button>
    </div>
</div>

{% set source_map = {'irobot': '로봇신문', 'robotreport': 'Robot Report', 'wsj_ai': 'WSJ', 'nyt_tech': 'NYT'} %}
{% set ns = namespace(irobot=0, robotreport=0, wsj_ai=0, nyt_tech=0) %}
{% for a in articles %}
    {% if a.source == 'irobot' %}{% set ns.irobot = ns.irobot + 1 %}
    {% elif a.source == 'robotreport' %}{% set ns.robotreport = ns.robotreport + 1 %}
    {% elif a.source == 'wsj_ai' %}{% set ns.wsj_ai = ns.wsj_ai + 1 %}
    {% elif a.source == 'nyt_tech' %}{% set ns.nyt_tech = ns.nyt_tech + 1 %}
    {% endif %}
{% endfor %}
<p class="text-muted mb-3">총 <span id="article-count">{{ articles|length }}</span>개 기사
    (로봇신문 {{ ns.irobot }} · Robot Report {{ ns.robotreport }} · WSJ {{ ns.wsj_ai }} · NYT {{ ns.nyt_tech }})</p>

{% if articles %}
<div class="list-group" id="article-list">
    {% for article in articles %}
    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
         id="article-{{ article.id }}">
        <div class="me-3 flex-grow-1">
            <span class="badge bg-info me-1">{{ source_map.get(article.source, article.source) }}</span>
            {% if article.section %}
            <span class="badge bg-secondary me-1">{{ article.section }}</span>
            {% endif %}
            <a href="{{ article.url }}" target="_blank" class="article-link">
                {{ article.title }}
            </a>
            <small class="text-muted d-block mt-1">
                {{ article.scraped_at.strftime('%Y-%m-%d %H:%M') }}
            </small>
        </div>
        <button class="btn btn-sm btn-outline-success flex-shrink-0 btn-read"
                data-id="{{ article.id }}">
            <i class="bi bi-check-lg"></i><span class="d-none d-sm-inline"> 읽음</span>
        </button>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
    <p class="mt-2">기사가 없습니다. 스크래핑을 실행해 주세요.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Mark as read (delete article)
document.querySelectorAll('.btn-read').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.preventDefault();
        const id = this.dataset.id;
        const row = document.getElementById('article-' + id);

        try {
            const resp = await fetch('/api/articles/' + id + '/read', {method: 'POST'});
            if (resp.ok) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    const count = document.querySelectorAll('#article-list .list-group-item').length;
                    document.getElementById('article-count').textContent = count;
                }, 300);
            }
        } catch (err) {
            console.error('Failed to mark as read:', err);
        }
    });
});

// Manual scrape — call all 4 sources sequentially
document.getElementById('btn-scrape').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 스크래핑 중...';

    const sources = ['irobot', 'robotreport', 'wsj_ai', 'nyt_tech'];
    let totalNew = 0;

    try {
        for (const src of sources) {
            const resp = await fetch('/api/scrape/' + src, {method: 'POST'});
            const data = await resp.json();
            totalNew += data.new_articles;
        }
        btn.innerHTML = '<i class="bi bi-check-lg"></i> 완료 (' + totalNew + '개 추가)';
        setTimeout(() => location.reload(), 1500);
    } catch (err) {
        btn.innerHTML = '<i class="bi bi-x-lg"></i> 실패';
        btn.classList.replace('btn-primary', 'btn-danger');
    }
});

// Mark all as read — clear all 4 sources
document.getElementById('btn-read-all').addEventListener('click', async function() {
    if (!confirm('모든 기사를 읽음 처리하시겠습니까?')) return;
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 처리 중...';

    const sources = ['irobot', 'robotreport', 'wsj_ai', 'nyt_tech'];
    let totalCleared = 0;

    try {
        for (const src of sources) {
            const resp = await fetch('/api/articles/read-all/' + src, {method: 'POST'});
            const data = await resp.json();
            totalCleared += data.cleared;
        }
        btn.innerHTML = '<i class="bi bi-check-all"></i> 완료 (' + totalCleared + '개)';
        setTimeout(() => location.reload(), 1000);
    } catch (err) {
        btn.innerHTML = '<i class="bi bi-x-lg"></i> 실패';
        btn.classList.replace('btn-outline-success', 'btn-danger');
    }
});
</script>
{% endblock %}
