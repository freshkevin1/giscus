{% extends "base.html" %}
{% block title %}Books I am reading - Dashboard{% endblock %}
{% block mobile_title %}Reading{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-book-half"></i> Books I am reading</h2>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
        <i class="bi bi-plus-lg"></i> Add Book
    </button>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
  {% endif %}
{% endwith %}

{% if books %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3" id="reading-cards">
    {% for book in books %}
    <div class="col" id="card-{{ book.id }}">
        <div class="card h-100 shadow-sm">
            <div class="card-body">
                <h5 class="card-title">{{ book.title }}</h5>
                <p class="card-text text-muted mb-1"><i class="bi bi-person"></i> {{ book.author }}</p>
                {% if book.publisher %}<p class="card-text text-muted small mb-1"><i class="bi bi-building"></i> {{ book.publisher }}</p>{% endif %}
                {% if book.added_at %}
                <p class="card-text text-muted small">
                    <i class="bi bi-calendar-plus"></i>
                    Added {{ book.added_at.strftime('%Y/%m/%d') }}
                </p>
                {% endif %}
            </div>
            <div class="card-footer d-flex gap-2">
                <button class="btn btn-success btn-sm flex-grow-1 btn-complete"
                        data-book-id="{{ book.id }}"
                        data-book-title="{{ book.title | e }}">
                    <i class="bi bi-check2-circle"></i> Library 등록
                </button>
                <button class="btn btn-outline-danger btn-sm btn-delete"
                        data-book-id="{{ book.id }}">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center text-muted py-5" id="empty-state">
    <i class="bi bi-book" style="font-size: 3rem;"></i>
    <p class="mt-2">현재 읽고 있는 책이 없습니다. Add Book으로 추가해 보세요.</p>
</div>
{% endif %}

<!-- Complete (Library 등록) Modal -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check2-circle"></i> Library 등록</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3" id="complete-book-title-display"></p>

                <div class="mb-3">
                    <label class="form-label fw-semibold">별점 <span class="text-danger">*</span></label>
                    <div id="complete-rating-stars" class="d-flex gap-1" style="font-size: 1.6rem;">
                        {% for i in range(1, 6) %}
                        <i class="bi bi-star complete-star" data-value="{{ i }}"
                           style="cursor: pointer; color: #ffc107;"></i>
                        {% endfor %}
                    </div>
                    <input type="hidden" id="complete-rating" value="0">
                    <div id="complete-rating-error" class="text-danger small mt-1" style="display:none;">별점을 선택해 주세요.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-semibold">완독일</label>
                    <input type="date" id="complete-date" class="form-control">
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="complete-hof">
                    <label class="form-check-label" for="complete-hof">
                        <i class="bi bi-trophy-fill text-warning"></i> Hall of Fame 등록
                    </label>
                </div>

                <div id="complete-error-msg" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" id="complete-submit-btn">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Book Modal (3-phase wizard) -->
<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Phase 1: Search -->
                <div id="phase-search">
                    <div class="input-group mb-3">
                        <input type="text" id="book-search-input" class="form-control"
                               placeholder="제목, 저자, 또는 ISBN으로 검색..." autofocus>
                        <button class="btn btn-primary" type="button" id="book-search-btn">
                            <i class="bi bi-search"></i> 검색
                        </button>
                    </div>
                    <div class="text-center">
                        <a href="#" id="manual-entry-link" class="text-muted small">직접 입력하기</a>
                    </div>
                </div>

                <!-- Phase 2: Results -->
                <div id="phase-results" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-search">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted" id="results-query"></span>
                    </div>
                    <div id="search-results" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="no-results" style="display:none;" class="text-center py-4">
                        <p class="text-muted">검색 결과가 없습니다.</p>
                        <button class="btn btn-outline-primary btn-sm" id="manual-entry-btn">직접 입력하기</button>
                    </div>
                </div>

                <!-- Phase 3: Confirm & Save -->
                <div id="phase-confirm" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-results">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted">책 정보 확인</span>
                    </div>
                    <form action="{{ url_for('book_add') }}" method="post">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Title</label>
                                    <input type="text" name="title" id="confirm-title" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Author</label>
                                    <input type="text" name="author" id="confirm-author" class="form-control" required>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Publisher</label>
                                        <input type="text" name="publisher" id="confirm-publisher" class="form-control" readonly>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Year</label>
                                        <input type="number" name="year_published" id="confirm-year" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <img id="confirm-thumbnail" src="" alt="" class="img-fluid rounded shadow-sm" style="max-height: 180px; display:none;">
                            </div>
                        </div>
                        <input type="hidden" name="isbn" id="confirm-isbn">
                        <input type="hidden" name="isbn13" id="confirm-isbn13">
                        <input type="hidden" name="average_rating" id="confirm-avg-rating">
                        <input type="hidden" name="shelf" value="reading">
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i> 저장</button>
                        </div>
                    </form>
                </div>

                <!-- Loading spinner -->
                <div id="search-loading" style="display:none;" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">검색 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// === Complete (Library 등록) Modal ===
(function() {
    let currentBookId = null;

    const completeModal = new bootstrap.Modal(document.getElementById('completeModal'));
    const ratingInput = document.getElementById('complete-rating');
    const ratingError = document.getElementById('complete-rating-error');
    const errorMsg = document.getElementById('complete-error-msg');

    // Open modal on "Library 등록" click
    document.querySelectorAll('.btn-complete').forEach(btn => {
        btn.addEventListener('click', function() {
            currentBookId = this.dataset.bookId;
            document.getElementById('complete-book-title-display').textContent = this.dataset.bookTitle;

            // Reset form
            setCompleteRating(0);
            ratingError.style.display = 'none';
            errorMsg.style.display = 'none';
            document.getElementById('complete-hof').checked = false;

            // Default date to today
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('complete-date').value = `${yyyy}-${mm}-${dd}`;

            completeModal.show();
        });
    });

    // Star rating clicks
    document.querySelectorAll('.complete-star').forEach(star => {
        star.addEventListener('click', function() {
            const val = parseInt(this.dataset.value);
            const current = parseInt(ratingInput.value);
            setCompleteRating(val === current ? 0 : val);
        });
    });

    function setCompleteRating(val) {
        ratingInput.value = val;
        document.querySelectorAll('.complete-star').forEach((s, idx) => {
            s.className = `bi bi-star${idx < val ? '-fill' : ''} complete-star`;
        });
    }

    // Submit
    document.getElementById('complete-submit-btn').addEventListener('click', async function() {
        const rating = parseInt(ratingInput.value);
        ratingError.style.display = 'none';
        errorMsg.style.display = 'none';

        if (!rating || rating < 1) {
            ratingError.style.display = '';
            return;
        }

        const payload = {
            my_rating: rating,
            date_read: document.getElementById('complete-date').value,
            hall_of_fame: document.getElementById('complete-hof').checked,
        };

        try {
            const resp = await fetch(`/api/books/${currentBookId}/complete`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'ok') {
                completeModal.hide();
                const card = document.getElementById(`card-${currentBookId}`);
                if (card) card.remove();

                // Show empty state if no cards left
                const remaining = document.querySelectorAll('#reading-cards .col');
                if (remaining.length === 0) {
                    const container = document.getElementById('reading-cards');
                    if (container) container.remove();
                    const emptyEl = document.getElementById('empty-state');
                    if (!emptyEl) {
                        const div = document.createElement('div');
                        div.className = 'text-center text-muted py-5';
                        div.innerHTML = '<i class="bi bi-book" style="font-size: 3rem;"></i><p class="mt-2">현재 읽고 있는 책이 없습니다. Add Book으로 추가해 보세요.</p>';
                        document.querySelector('.container-fluid, main, [role="main"]')?.appendChild(div)
                            || document.body.appendChild(div);
                    }
                }
            } else {
                errorMsg.textContent = data.message || '저장에 실패했습니다.';
                errorMsg.style.display = '';
            }
        } catch (e) {
            errorMsg.textContent = '서버 오류가 발생했습니다.';
            errorMsg.style.display = '';
        }
    });
})();

// === Delete ===
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('이 책을 삭제하시겠습니까?')) return;
        const bookId = this.dataset.bookId;
        const resp = await fetch(`/api/books/${bookId}/delete`, {method: 'POST'});
        if (resp.ok) {
            const card = document.getElementById(`card-${bookId}`);
            if (card) card.remove();
        }
    });
});

// === Add Book Wizard ===
(function() {
    const phaseSearch = document.getElementById('phase-search');
    const phaseResults = document.getElementById('phase-results');
    const phaseConfirm = document.getElementById('phase-confirm');
    const loading = document.getElementById('search-loading');

    function showPhase(phase) {
        phaseSearch.style.display = phase === 'search' ? '' : 'none';
        phaseResults.style.display = phase === 'results' ? '' : 'none';
        phaseConfirm.style.display = phase === 'confirm' ? '' : 'none';
        loading.style.display = phase === 'loading' ? '' : 'none';
    }

    document.getElementById('addBookModal').addEventListener('show.bs.modal', function() {
        showPhase('search');
        document.getElementById('book-search-input').value = '';
        resetConfirmForm();
    });

    document.getElementById('book-search-btn').addEventListener('click', doSearch);
    document.getElementById('book-search-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
    });

    async function doSearch() {
        const q = document.getElementById('book-search-input').value.trim();
        if (!q) return;
        showPhase('loading');
        try {
            const resp = await fetch(`/api/books/search?q=${encodeURIComponent(q)}`);
            const data = await resp.json();
            renderResults(q, data.results || []);
        } catch {
            renderResults(q, []);
        }
    }

    function renderResults(query, results) {
        document.getElementById('results-query').textContent = `"${query}" 검색 결과 (${results.length}건)`;
        const container = document.getElementById('search-results');
        const noResults = document.getElementById('no-results');
        container.innerHTML = '';

        if (results.length === 0) {
            container.style.display = 'none';
            noResults.style.display = '';
            showPhase('results');
            return;
        }

        container.style.display = '';
        noResults.style.display = 'none';

        results.forEach(book => {
            const div = document.createElement('div');
            div.className = 'card mb-2 book-result-card';
            div.style.cursor = 'pointer';
            div.innerHTML = `
                <div class="card-body p-2 d-flex align-items-center">
                    <div style="width: 45px; min-width: 45px; height: 65px; margin-right: 12px;" class="d-flex align-items-center justify-content-center">
                        ${book.thumbnail
                            ? `<img src="${book.thumbnail}" style="max-height: 65px; max-width: 45px; border-radius: 3px;" alt="">`
                            : `<i class="bi bi-book text-muted" style="font-size: 1.5rem;"></i>`}
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="fw-bold text-truncate">${escapeHtml(book.title)}</div>
                        <small class="text-muted">${escapeHtml(book.author || 'Unknown')}</small>
                        ${book.publisher ? `<small class="text-muted"> · ${escapeHtml(book.publisher)}</small>` : ''}
                        ${book.year_published ? `<small class="text-muted"> · ${book.year_published}</small>` : ''}
                    </div>
                </div>
            `;
            div.addEventListener('click', () => selectBook(book));
            container.appendChild(div);
        });

        showPhase('results');
    }

    function selectBook(book) {
        document.getElementById('confirm-title').value = book.title || '';
        document.getElementById('confirm-title').readOnly = true;
        document.getElementById('confirm-author').value = book.author || '';
        document.getElementById('confirm-author').readOnly = true;
        document.getElementById('confirm-publisher').value = book.publisher || '';
        document.getElementById('confirm-year').value = book.year_published || '';
        document.getElementById('confirm-isbn').value = book.isbn || '';
        document.getElementById('confirm-isbn13').value = book.isbn13 || '';
        document.getElementById('confirm-avg-rating').value = book.average_rating || 0;

        const thumb = document.getElementById('confirm-thumbnail');
        if (book.thumbnail) {
            thumb.src = book.thumbnail;
            thumb.style.display = '';
        } else {
            thumb.style.display = 'none';
        }

        showPhase('confirm');
    }

    function openManualEntry() {
        resetConfirmForm();
        document.getElementById('confirm-title').readOnly = false;
        document.getElementById('confirm-author').readOnly = false;
        document.getElementById('confirm-publisher').readOnly = false;
        document.getElementById('confirm-year').readOnly = false;
        showPhase('confirm');
    }

    document.getElementById('manual-entry-link').addEventListener('click', function(e) {
        e.preventDefault();
        openManualEntry();
    });
    document.getElementById('manual-entry-btn').addEventListener('click', openManualEntry);

    document.getElementById('back-to-search').addEventListener('click', () => showPhase('search'));
    document.getElementById('back-to-results').addEventListener('click', () => showPhase('results'));

    function resetConfirmForm() {
        ['confirm-title', 'confirm-author', 'confirm-publisher', 'confirm-isbn', 'confirm-isbn13'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });
        const yearEl = document.getElementById('confirm-year');
        if (yearEl) yearEl.value = '';
        const avgEl = document.getElementById('confirm-avg-rating');
        if (avgEl) avgEl.value = '0';
        const thumb = document.getElementById('confirm-thumbnail');
        if (thumb) thumb.style.display = 'none';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}
