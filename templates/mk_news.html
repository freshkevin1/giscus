{% extends "base.html" %}
{% block title %}매일경제 - Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-newspaper"></i> 매일경제 오늘의 신문</h2>
    <button id="btn-scrape" class="btn btn-primary">
        <i class="bi bi-arrow-clockwise"></i> 스크래핑 실행
    </button>
</div>

<p class="text-muted mb-3">총 <span id="article-count">{{ articles|length }}</span>개 기사</p>

{% if articles %}
<div class="list-group" id="article-list">
    {% for article in articles %}
    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
         id="article-{{ article.id }}">
        <div class="me-3 flex-grow-1">
            {% if article.section %}
            <span class="badge bg-secondary me-1">{{ article.section }}</span>
            {% endif %}
            <a href="{{ article.url }}" target="_blank" class="article-link">
                {{ article.title }}
            </a>
            <small class="text-muted d-block mt-1">
                {{ article.scraped_at.strftime('%Y-%m-%d %H:%M') }}
            </small>
        </div>
        <button class="btn btn-sm btn-outline-success flex-shrink-0 btn-read"
                data-id="{{ article.id }}">
            <i class="bi bi-check-lg"></i> 읽음
        </button>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
    <p class="mt-2">기사가 없습니다. 스크래핑을 실행해 주세요.</p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Mark as read (delete article)
document.querySelectorAll('.btn-read').forEach(btn => {
    btn.addEventListener('click', async function(e) {
        e.preventDefault();
        const id = this.dataset.id;
        const row = document.getElementById('article-' + id);

        try {
            const resp = await fetch('/api/articles/' + id + '/read', {method: 'POST'});
            if (resp.ok) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    const count = document.querySelectorAll('#article-list .list-group-item').length;
                    document.getElementById('article-count').textContent = count;
                }, 300);
            }
        } catch (err) {
            console.error('Failed to mark as read:', err);
        }
    });
});

// Manual scrape
document.getElementById('btn-scrape').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 스크래핑 중...';

    try {
        const resp = await fetch('/api/scrape', {method: 'POST'});
        const data = await resp.json();
        btn.innerHTML = '<i class="bi bi-check-lg"></i> 완료 (' + data.new_articles + '개 추가)';
        setTimeout(() => location.reload(), 1500);
    } catch (err) {
        btn.innerHTML = '<i class="bi bi-x-lg"></i> 실패';
        btn.classList.replace('btn-primary', 'btn-danger');
    }
});
</script>
{% endblock %}
