{% extends "base.html" %}
{% block title %}Contact List - Dashboard{% endblock %}
{% block mobile_title %}Contact List{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0"><i class="bi bi-people"></i> Contact List</h4>
    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addContactModal">
        <i class="bi bi-plus-lg"></i> 연락처 추가
    </button>
</div>

<!-- Filter tabs -->
<ul class="nav nav-pills mb-3" id="filterTabs">
    <li class="nav-item">
        <a class="nav-link active" href="#" data-filter="all">전체</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="overdue">Overdue</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="high">High Priority</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="#" data-filter="deleted">
            <i class="bi bi-trash"></i> 휴지통 <span class="badge bg-secondary" id="deletedCount" style="display:none">0</span>
        </a>
    </li>
</ul>

<!-- Search -->
<div class="input-group mb-3">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" id="contact-search" class="form-control"
           placeholder="이름, 소속, 태그, 이메일로 검색...">
</div>

<!-- Mobile sort selector (visible only on mobile) -->
<div id="mobileSortBar" class="d-flex gap-2 mb-3 d-md-none">
    <select id="mobileSortKey" class="form-select form-select-sm">
        <option value="score">Score</option>
        <option value="name">이름</option>
        <option value="employer">소속</option>
        <option value="contact_priority">Contact Priority</option>
        <option value="follow_up_priority">FU Priority</option>
        <option value="follow_up_date">FU Date</option>
        <option value="last_contact">Last Contact</option>
    </select>
    <button id="mobileSortDir" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-sort-down"></i>
    </button>
</div>

<!-- Contact table -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="contactTable">
                <thead class="table-light">
                    <tr>
                        <th class="sortable" data-key="score" data-type="number" style="cursor:pointer">Score <i class="bi bi-chevron-down sort-icon"></i></th>
                        <th class="sortable" data-key="name" data-type="string" style="cursor:pointer">이름 <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="employer" data-type="string" style="cursor:pointer">소속/직급 <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="contact_priority" data-type="string" style="cursor:pointer">Contact Priority <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="follow_up_priority" data-type="string" style="cursor:pointer">FU Priority <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="follow_up_date" data-type="date" style="cursor:pointer">FU Date <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th class="sortable" data-key="last_contact" data-type="date" style="cursor:pointer">Last Contact <i class="bi bi-chevron-expand sort-icon"></i></th>
                        <th>태그</th>
                        <th>전화</th>
                        <th>이메일</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="contactBody">
                    <tr><td colspan="11" class="text-center text-muted py-4">로딩 중...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Mobile card view -->
<div id="contactCards" class="contact-cards"></div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">연락처 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addContactForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">이름 *</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Priority</label>
                            <select class="form-select" name="contact_priority">
                                <option value="">선택</option>
                                <option>1A-인생관계</option>
                                <option>1M-Mentor, 은인</option>
                                <option>1F-Family</option>
                                <option>2A-비즈니스 우선순위</option>
                                <option>2C-비즈니스</option>
                                <option>3A-인적 우선순위</option>
                                <option>3C-인적 네트워킹</option>
                                <option>4A-Passive</option>
                                <option>5A-Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">소속</label>
                            <input type="text" class="form-control" name="employer">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">직급</label>
                            <input type="text" class="form-control" name="title">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Priority</label>
                            <select class="form-select" name="follow_up_priority">
                                <option value="FU9">FU9 (None)</option>
                                <option value="FU5">FU5 (Low)</option>
                                <option value="FU3">FU3 (Medium)</option>
                                <option value="FU1">FU1 (High)</option>
                                <option value="FU0">FU0 (Critical)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" name="follow_up_date">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Contact</label>
                            <input type="date" class="form-control" name="last_contact">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Follow-up Note</label>
                            <input type="text" class="form-control" name="follow_up_note">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">태그</label>
                            <select class="form-select" name="tag" id="addTagSelect">
                                <option value="">선택</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred by</label>
                            <input type="text" class="form-control" name="referred_by">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Key Value & Interest</label>
                            <input type="text" class="form-control" name="key_value_interest">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="saveContactBtn">저장</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Contact Modal -->
<div class="modal fade" id="editContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">연락처 편집</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editContactForm">
                    <input type="hidden" name="name_hmac" id="editNameHmac">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">이름</label>
                            <input type="text" class="form-control" name="name" id="editName" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Contact Priority</label>
                            <select class="form-select" name="contact_priority" id="editCP">
                                <option value="">선택</option>
                                <option>1A-인생관계</option>
                                <option>1M-Mentor, 은인</option>
                                <option>1F-Family</option>
                                <option>2A-비즈니스 우선순위</option>
                                <option>2C-비즈니스</option>
                                <option>3A-인적 우선순위</option>
                                <option>3C-인적 네트워킹</option>
                                <option>4A-Passive</option>
                                <option>5A-Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">소속</label>
                            <input type="text" class="form-control" name="employer" id="editEmployer">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">직급</label>
                            <input type="text" class="form-control" name="title" id="editTitle">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Priority</label>
                            <select class="form-select" name="follow_up_priority" id="editFU">
                                <option value="FU9">FU9 (None)</option>
                                <option value="FU5">FU5 (Low)</option>
                                <option value="FU3">FU3 (Medium)</option>
                                <option value="FU1">FU1 (High)</option>
                                <option value="FU0">FU0 (Critical)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" class="form-control" name="follow_up_date" id="editFUDate">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Last Contact</label>
                            <input type="date" class="form-control" name="last_contact" id="editLastContact">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Follow-up Note</label>
                            <input type="text" class="form-control" name="follow_up_note" id="editFUNote">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" id="editEmail">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" name="phone" id="editPhone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">태그</label>
                            <select class="form-select" name="tag" id="editTag">
                                <option value="">선택</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred by</label>
                            <input type="text" class="form-control" name="referred_by" id="editReferredBy">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Key Value & Interest</label>
                            <input type="text" class="form-control" name="key_value_interest" id="editKVI">
                        </div>
                    </div>
                </form>
                <!-- Interaction Logs -->
                <hr>
                <h6>Interaction Log</h6>
                <div id="interactionLogs" class="small text-muted">로딩 중...</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="deleteContactBtn">삭제</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="updateContactBtn">저장</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allContacts = [];
let deletedContacts = [];
let currentFilter = 'all';
let sortKey = 'score';
let sortAsc = false;
let searchQuery = '';

function sortContacts(contacts) {
    const th = document.querySelector(`#contactTable thead .sortable[data-key="${sortKey}"]`);
    const type = th ? th.dataset.type : 'string';
    return [...contacts].sort((a, b) => {
        let aVal = a[sortKey] ?? '';
        let bVal = b[sortKey] ?? '';
        let cmp = 0;
        if (type === 'number') {
            cmp = (Number(aVal) || 0) - (Number(bVal) || 0);
        } else if (type === 'date') {
            const aTime = aVal ? new Date(aVal).getTime() : 0;
            const bTime = bVal ? new Date(bVal).getTime() : 0;
            cmp = aTime - bTime;
        } else {
            cmp = String(aVal).localeCompare(String(bVal), 'ko');
        }
        return sortAsc ? cmp : -cmp;
    });
}

const NORMAL_HEADERS = `<tr>
    <th class="sortable" data-key="score" data-type="number" style="cursor:pointer">Score <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="name" data-type="string" style="cursor:pointer">이름 <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="employer" data-type="string" style="cursor:pointer">소속/직급 <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="contact_priority" data-type="string" style="cursor:pointer">Contact Priority <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="follow_up_priority" data-type="string" style="cursor:pointer">FU Priority <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="follow_up_date" data-type="date" style="cursor:pointer">FU Date <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th class="sortable" data-key="last_contact" data-type="date" style="cursor:pointer">Last Contact <i class="bi bi-chevron-expand sort-icon"></i></th>
    <th>태그</th><th>전화</th><th>이메일</th><th></th>
</tr>`;
const DELETED_HEADERS_HTML = `<tr>
    <th>이름</th><th>소속</th><th>Contact Priority</th>
    <th>삭제일</th><th>삭제자</th><th>액션</th>
</tr>`;

const FU_LABELS = {
    'FU0': 'FU0 (Critical)',
    'FU1': 'FU1 (High)',
    'FU3': 'FU3 (Medium)',
    'FU5': 'FU5 (Low)',
    'FU9': 'FU9 (None)',
};

function formatFU(val) {
    if (!val) return '-';
    return FU_LABELS[val] || val;
}

// Load contacts
async function loadContacts() {
    try {
        const res = await fetch('/api/contacts');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        allContacts = data.contacts;
        renderContacts();
    } catch (e) {
        document.getElementById('contactBody').innerHTML =
            `<tr><td colspan="11" class="text-center text-danger">${e.message}</td></tr>`;
    }
}

function getScoreBadgeClass(score) {
    if (score >= 60) return 'bg-danger';
    if (score >= 40) return 'bg-warning text-dark';
    if (score >= 20) return 'bg-info text-dark';
    return 'bg-secondary';
}

function isOverdue(contact) {
    if (!contact.follow_up_date) return false;
    return new Date(contact.follow_up_date) < new Date();
}

function copyEmail(email, el) {
    navigator.clipboard.writeText(email).then(() => {
        const orig = el.innerHTML;
        el.innerHTML = '<i class="bi bi-check-lg text-success"></i> 복사됨!';
        setTimeout(() => { el.innerHTML = orig; }, 1500);
    }).catch(() => {
        alert('복사 실패: ' + email);
    });
}

function renderContacts() {
    const thead = document.querySelector('#contactTable thead');
    const tbody = document.getElementById('contactBody');

    if (currentFilter === 'deleted') {
        thead.innerHTML = DELETED_HEADERS_HTML;
        renderDeletedContacts();
        return;
    }

    thead.innerHTML = NORMAL_HEADERS;

    let filtered = allContacts;

    // 검색 필터 적용
    if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(c =>
            (c.name || '').toLowerCase().includes(q) ||
            (c.employer || '').toLowerCase().includes(q) ||
            (c.tag || '').toLowerCase().includes(q) ||
            (c.email || '').toLowerCase().includes(q)
        );
    }

    if (currentFilter === 'overdue') {
        filtered = allContacts.filter(c => isOverdue(c));
    } else if (currentFilter === 'high') {
        filtered = allContacts.filter(c =>
            c.contact_priority && (c.contact_priority.startsWith('1') || c.contact_priority.startsWith('2A'))
        );
    }

    // Apply sorting
    filtered = sortContacts(filtered);

    // Update sort icons
    document.querySelectorAll('#contactTable thead .sortable .sort-icon').forEach(icon => {
        const th = icon.closest('th');
        if (th.dataset.key === sortKey) {
            icon.className = sortAsc ? 'bi bi-chevron-up sort-icon' : 'bi bi-chevron-down sort-icon';
        } else {
            icon.className = 'bi bi-chevron-expand sort-icon';
        }
    });

    // Bind header click events
    document.querySelectorAll('#contactTable thead .sortable').forEach(th => {
        th.onclick = () => {
            const key = th.dataset.key;
            if (sortKey === key) {
                sortAsc = !sortAsc;
            } else {
                sortKey = key;
                sortAsc = th.dataset.type === 'number' ? false : true;
            }
            document.getElementById('mobileSortKey').value = sortKey;
            updateMobileSortIcon();
            renderContacts();
        };
    });

    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-4">연락처가 없습니다.</td></tr>';
        return;
    }

    tbody.innerHTML = filtered.map(c => {
        const displayName = c.employer ? `${c.name}(${c.employer})` : c.name;
        const overdueClass = isOverdue(c) ? 'table-warning overdue-row' : '';
        return `<tr class="${overdueClass}" style="cursor:pointer" onclick="openEdit('${c.name_hmac}')">
            <td><span class="badge ${getScoreBadgeClass(c.score)} score-badge">${c.score}</span></td>
            <td class="fw-semibold">${displayName}</td>
            <td class="text-muted small">${c.employer || ''} ${c.title || ''}</td>
            <td><small>${c.contact_priority || '-'}</small></td>
            <td><small>${formatFU(c.follow_up_priority)}</small></td>
            <td class="${isOverdue(c) ? 'text-danger fw-bold' : ''}">${c.follow_up_date || '-'}</td>
            <td>${c.last_contact || '-'}</td>
            <td>${c.tag ? `<span class="badge bg-light text-dark">${c.tag}</span>` : ''}</td>
            <td>${c.phone ? `<a href="tel:${c.phone}" onclick="event.stopPropagation()" class="text-decoration-none">${c.phone}</a>` : '-'}</td>
            <td>${c.email ? `<span class="email-copy" onclick="event.stopPropagation(); copyEmail('${c.email}', this)" style="cursor:pointer" title="클릭하여 복사"><i class="bi bi-clipboard"></i> ${c.email}</span>` : '-'}</td>
            <td><i class="bi bi-chevron-right text-muted"></i></td>
        </tr>`;
    }).join('');

    // Render mobile cards
    const cardsContainer = document.getElementById('contactCards');
    if (cardsContainer) {
        cardsContainer.innerHTML = filtered.map(c => {
            const overdueCard = isOverdue(c) ? 'overdue-card' : '';
            return `<div class="contact-card ${overdueCard}" onclick="openEdit('${c.name_hmac}')">
                <div class="contact-card-header">
                    <span class="contact-card-name">${c.name}</span>
                    <span class="badge ${getScoreBadgeClass(c.score)} score-badge">${c.score}</span>
                </div>
                <div class="contact-card-meta">
                    ${c.employer ? `<span><i class="bi bi-building"></i> ${c.employer}</span>` : ''}
                    ${c.contact_priority ? `<span><i class="bi bi-flag"></i> ${c.contact_priority}</span>` : ''}
                    ${c.follow_up_date ? `<span class="${isOverdue(c)?'text-danger fw-bold':''}"><i class="bi bi-calendar"></i> ${c.follow_up_date}</span>` : ''}
                    ${c.tag ? `<span class="badge bg-light text-dark">${c.tag}</span>` : ''}
                </div>
                <div class="contact-card-actions">
                    ${c.phone ? `<a href="tel:${c.phone}" onclick="event.stopPropagation()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-telephone"></i></a>` : ''}
                    ${c.email ? `<a href="mailto:${c.email}" onclick="event.stopPropagation()" class="btn btn-sm btn-outline-secondary"><i class="bi bi-envelope"></i></a>` : ''}
                    <span class="ms-auto"><i class="bi bi-chevron-right text-muted"></i></span>
                </div>
            </div>`;
        }).join('');
    }
}

function renderDeletedContacts() {
    const tbody = document.getElementById('contactBody');
    if (deletedContacts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">휴지통이 비어 있습니다.</td></tr>';
        // Clear mobile cards too
        const cardsContainer = document.getElementById('contactCards');
        if (cardsContainer) cardsContainer.innerHTML = '<div class="text-center text-muted py-4">휴지통이 비어 있습니다.</div>';
        return;
    }

    tbody.innerHTML = deletedContacts.map(c => {
        const displayName = c.employer ? `${c.name}(${c.employer})` : c.name;
        return `<tr>
            <td class="fw-semibold">${displayName}</td>
            <td class="text-muted small">${c.employer || '-'}</td>
            <td><small>${c.contact_priority || '-'}</small></td>
            <td class="small">${c.deleted_date || '-'}</td>
            <td><span class="badge ${c.deleted_by === 'AI' ? 'bg-info' : 'bg-secondary'}">${c.deleted_by || '-'}</span></td>
            <td>
                <button class="btn btn-outline-success btn-sm me-1" onclick="restoreContact('${c.name_hmac}')">
                    <i class="bi bi-arrow-counterclockwise"></i> 복원
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="permanentDelete('${c.name_hmac}')">
                    <i class="bi bi-x-lg"></i> 영구삭제
                </button>
            </td>
        </tr>`;
    }).join('');

    // Render mobile cards for deleted contacts
    const cardsContainer = document.getElementById('contactCards');
    if (cardsContainer) {
        cardsContainer.innerHTML = deletedContacts.map(c => {
            return `<div class="contact-card">
                <div class="contact-card-header">
                    <span class="contact-card-name">${c.name}</span>
                    <span class="badge ${c.deleted_by === 'AI' ? 'bg-info' : 'bg-secondary'}">${c.deleted_by || '-'}</span>
                </div>
                <div class="contact-card-meta">
                    ${c.employer ? `<span><i class="bi bi-building"></i> ${c.employer}</span>` : ''}
                    ${c.deleted_date ? `<span><i class="bi bi-calendar-x"></i> ${c.deleted_date}</span>` : ''}
                </div>
                <div class="contact-card-actions">
                    <button class="btn btn-sm btn-outline-success" onclick="restoreContact('${c.name_hmac}')">
                        <i class="bi bi-arrow-counterclockwise"></i> 복원
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="permanentDelete('${c.name_hmac}')">
                        <i class="bi bi-x-lg"></i> 영구삭제
                    </button>
                </div>
            </div>`;
        }).join('');
    }
}

// Filter tabs
document.getElementById('filterTabs').addEventListener('click', e => {
    if (e.target.dataset.filter) {
        e.preventDefault();
        document.querySelectorAll('#filterTabs .nav-link').forEach(n => n.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        renderContacts();
    }
});

// Load tags for dropdowns
async function loadTags() {
    try {
        const res = await fetch('/api/tags');
        const data = await res.json();
        const tags = data.tags || [];
        ['addTagSelect', 'editTag'].forEach(id => {
            const sel = document.getElementById(id);
            const current = sel.value;
            sel.innerHTML = '<option value="">선택</option>' +
                tags.map(t => `<option value="${t}">${t}</option>`).join('');
            sel.value = current;
        });
    } catch (e) {
        console.error('Failed to load tags:', e);
    }
}

// Add contact
document.getElementById('saveContactBtn').addEventListener('click', async () => {
    const form = document.getElementById('addContactForm');
    const data = {};
    new FormData(form).forEach((v, k) => { if (v) data[k] = v; });

    if (!data.name) {
        alert('이름은 필수입니다.');
        return;
    }

    try {
        const res = await fetch('/api/contacts', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (result.error) {
            alert(result.errors ? result.errors.join('\n') : result.error);
            return;
        }
        bootstrap.Modal.getInstance(document.getElementById('addContactModal')).hide();
        form.reset();
        loadContacts();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Normalize YYYY-MM or YYYY values so <input type="date"> can display them
function normalizeDateForInput(val) {
    if (!val) return '';
    if (/^\d{4}-\d{2}$/.test(val)) return val + '-01';   // YYYY-MM → YYYY-MM-01
    if (/^\d{4}$/.test(val)) return val + '-01-01';       // YYYY → YYYY-01-01
    return val;  // YYYY-MM-DD is returned as-is
}

// Open edit modal
async function openEdit(nameHmac) {
    const contact = allContacts.find(c => c.name_hmac === nameHmac);
    if (!contact) return;

    document.getElementById('editNameHmac').value = nameHmac;
    document.getElementById('editName').value = contact.name;
    document.getElementById('editCP').value = contact.contact_priority || '';
    document.getElementById('editEmployer').value = contact.employer || '';
    document.getElementById('editTitle').value = contact.title || '';
    document.getElementById('editFU').value = contact.follow_up_priority || 'FU9';
    document.getElementById('editFUDate').value = normalizeDateForInput(contact.follow_up_date || '');
    document.getElementById('editLastContact').value = normalizeDateForInput(contact.last_contact || '');
    document.getElementById('editFUNote').value = contact.follow_up_note || '';
    document.getElementById('editEmail').value = contact.email || '';
    document.getElementById('editPhone').value = contact.phone || '';
    document.getElementById('editTag').value = contact.tag || '';
    document.getElementById('editReferredBy').value = contact.referred_by || '';
    document.getElementById('editKVI').value = contact.key_value_interest || '';

    // Load interaction logs
    const logsDiv = document.getElementById('interactionLogs');
    logsDiv.innerHTML = '로딩 중...';
    try {
        const res = await fetch(`/api/contacts/${nameHmac}/logs`);
        const data = await res.json();
        const logs = data.logs || [];
        if (logs.length === 0) {
            logsDiv.innerHTML = '<p class="text-muted">기록 없음</p>';
        } else {
            logsDiv.innerHTML = logs.map(l =>
                `<div class="border-bottom py-2">
                    <strong>${l.date}</strong> — ${l.context}
                    ${l.key_value_extracted ? `<br><small class="text-primary">Key: ${l.key_value_extracted}</small>` : ''}
                </div>`
            ).join('');
        }
    } catch (e) {
        logsDiv.innerHTML = '<p class="text-danger">로그 로딩 실패</p>';
    }

    bootstrap.Modal.getOrCreateInstance(document.getElementById('editContactModal')).show();
}

// Update contact
document.getElementById('updateContactBtn').addEventListener('click', async () => {
    const nameHmac = document.getElementById('editNameHmac').value;
    const data = {};
    const fields = ['contact_priority', 'employer', 'title', 'follow_up_priority',
                     'follow_up_date', 'follow_up_note', 'last_contact', 'email',
                     'phone', 'tag', 'referred_by', 'key_value_interest'];

    const form = document.getElementById('editContactForm');
    const formData = new FormData(form);
    fields.forEach(f => {
        const val = formData.get(f);
        if (val !== null) data[f] = val;
    });

    try {
        const res = await fetch(`/api/contacts/${nameHmac}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        const result = await res.json();
        if (result.error) {
            alert(result.errors ? result.errors.join('\n') : result.error);
            return;
        }
        bootstrap.Modal.getInstance(document.getElementById('editContactModal')).hide();
        loadContacts();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Delete contact
document.getElementById('deleteContactBtn').addEventListener('click', async () => {
    if (!confirm('휴지통으로 이동하시겠습니까?')) return;
    const nameHmac = document.getElementById('editNameHmac').value;
    try {
        const res = await fetch(`/api/contacts/${nameHmac}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.error) {
            alert(result.error);
            return;
        }
        bootstrap.Modal.getInstance(document.getElementById('editContactModal')).hide();
        loadContacts();
        loadDeletedContacts();
    } catch (e) {
        alert('오류: ' + e.message);
    }
});

// Load deleted contacts
async function loadDeletedContacts() {
    try {
        const res = await fetch('/api/contacts/deleted');
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        deletedContacts = data.contacts || [];
        const badge = document.getElementById('deletedCount');
        if (deletedContacts.length > 0) {
            badge.textContent = deletedContacts.length;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
        if (currentFilter === 'deleted') renderContacts();
    } catch (e) {
        console.error('Failed to load deleted contacts:', e);
    }
}

async function restoreContact(nameHmac) {
    if (!confirm('이 연락처를 복원하시겠습니까?')) return;
    try {
        const res = await fetch(`/api/contacts/${nameHmac}/restore`, { method: 'POST' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        loadContacts();
        loadDeletedContacts();
    } catch (e) {
        alert('오류: ' + e.message);
    }
}

async function permanentDelete(nameHmac) {
    if (!confirm('영구 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return;
    try {
        const res = await fetch(`/api/contacts/${nameHmac}/permanent`, { method: 'DELETE' });
        const result = await res.json();
        if (result.error) { alert(result.error); return; }
        loadDeletedContacts();
    } catch (e) {
        alert('오류: ' + e.message);
    }
}

// Search
document.getElementById('contact-search').addEventListener('input', function() {
    searchQuery = this.value.toLowerCase();
    renderContacts();
});

// Mobile sort controls
document.getElementById('mobileSortKey').addEventListener('change', function() {
    sortKey = this.value;
    const th = document.querySelector(`#contactTable thead .sortable[data-key="${sortKey}"]`);
    const type = th ? th.dataset.type : 'string';
    sortAsc = type === 'number' ? false : true;
    updateMobileSortIcon();
    renderContacts();
});

document.getElementById('mobileSortDir').addEventListener('click', function() {
    sortAsc = !sortAsc;
    updateMobileSortIcon();
    renderContacts();
});

function updateMobileSortIcon() {
    const icon = document.querySelector('#mobileSortDir i');
    icon.className = sortAsc ? 'bi bi-sort-up' : 'bi bi-sort-down';
}

// Init
document.getElementById('mobileSortKey').value = sortKey;
loadContacts();
loadTags();
loadDeletedContacts();
</script>
{% endblock %}
