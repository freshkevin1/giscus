{% extends "base.html" %}
{% block title %}Library - Dashboard{% endblock %}
{% block mobile_title %}Library{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2><i class="bi bi-bookshelf"></i> Library</h2>
    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
        <i class="bi bi-plus-lg"></i> Add Book
    </button>
</div>

<!-- Search -->
<div class="input-group mb-3">
    <span class="input-group-text"><i class="bi bi-search"></i></span>
    <input type="text" id="search-input" class="form-control" placeholder="Search by title or author...">
</div>

{% if books %}
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle" id="book-table">
        <thead class="table-light">
            <tr>
                <th class="sortable" data-col="0" data-type="string" style="width: 35%; cursor: pointer;">
                    Title <i class="bi bi-chevron-expand text-muted sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th class="sortable" data-col="1" data-type="string" style="width: 18%; cursor: pointer;">
                    Author <i class="bi bi-chevron-expand text-muted sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th class="sortable" data-col="2" data-type="number" style="width: 13%; cursor: pointer;">
                    My Rating <i class="bi bi-chevron-expand text-muted sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th class="sortable" data-col="3" data-type="date" style="width: 12%; cursor: pointer;">
                    Date Read <i class="bi bi-chevron-down sort-icon" style="font-size: 0.75rem;"></i>
                </th>
                <th style="width: 7%;"></th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr class="book-row" data-title="{{ book.title|lower }}" data-author="{{ book.author|lower }}">
                <td data-sort="{{ book.title|lower }}">
                    <strong>{{ book.title }}</strong>
                    {% if book.year_published %}<br><small class="text-muted">{{ book.year_published }}</small>{% endif %}
                </td>
                <td data-sort="{{ book.author|lower }}">{{ book.author }}</td>
                <td data-sort="{{ book.my_rating }}">
                    <div class="star-rating" data-book-id="{{ book.id }}" data-rating="{{ book.my_rating }}">
                        {% for i in range(1, 6) %}
                        <i class="bi bi-star{% if i <= book.my_rating %}-fill{% endif %} star-icon"
                           data-value="{{ i }}" style="cursor: pointer; color: #ffc107; font-size: 1.1rem;"></i>
                        {% endfor %}
                    </div>
                </td>
                <td data-sort="{{ book.date_read or '' }}">
                    {% if book.date_read and '/' in book.date_read %}
                        {{ book.date_read.split('/')[1] }}/{{ book.date_read.split('/')[0] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-hall-of-fame {% if book.hall_of_fame %}btn-warning{% else %}btn-outline-secondary{% endif %}" data-book-id="{{ book.id }}" data-hof="{{ book.hall_of_fame|int }}" title="Hall of Fame">
                        <i class="bi bi-trophy{% if book.hall_of_fame %}-fill{% endif %}"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete" data-book-id="{{ book.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-journal-richtext" style="font-size: 3rem;"></i>
    <p class="mt-2">No books yet. Add books manually to get started.</p>
</div>
{% endif %}

<!-- Add Book Modal (3-phase wizard) -->
<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <div class="d-flex flex-column">
                    <h5 class="modal-title">Add Book</h5>
                    <div class="d-flex gap-1 mt-1" id="wizard-steps">
                        <span class="wizard-step active" data-step="1">1 검색</span>
                        <span class="wizard-step-sep">›</span>
                        <span class="wizard-step" data-step="2">2 선택</span>
                        <span class="wizard-step-sep">›</span>
                        <span class="wizard-step" data-step="3">3 저장</span>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Phase 1: Search -->
                <div id="phase-search">
                    <div class="input-group mb-3">
                        <input type="text" id="book-search-input" class="form-control"
                               placeholder="제목, 저자, 또는 ISBN으로 검색..." autofocus>
                        <button class="btn btn-primary" type="button" id="book-search-btn">
                            <i class="bi bi-search"></i> 검색
                        </button>
                    </div>
                    <div class="text-center">
                        <a href="#" id="manual-entry-link" class="text-muted small">직접 입력하기</a>
                    </div>
                </div>

                <!-- Phase 2: Results -->
                <div id="phase-results" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-search">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted" id="results-query"></span>
                    </div>
                    <div id="search-results" style="max-height: 400px; overflow-y: auto;"></div>
                    <div id="no-results" style="display:none;" class="text-center py-4">
                        <p class="text-muted">검색 결과가 없습니다.</p>
                        <button class="btn btn-outline-primary btn-sm" id="manual-entry-btn">직접 입력하기</button>
                    </div>
                </div>

                <!-- Phase 3: Confirm & Save -->
                <div id="phase-confirm" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="back-to-results">
                            <i class="bi bi-arrow-left"></i>
                        </button>
                        <span class="text-muted">책 정보 확인</span>
                    </div>
                    <form action="{{ url_for('book_add') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Title</label>
                                    <input type="text" name="title" id="confirm-title" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Author</label>
                                    <input type="text" name="author" id="confirm-author" class="form-control" required>
                                </div>
                                <div class="row">
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Publisher</label>
                                        <input type="text" name="publisher" id="confirm-publisher" class="form-control" readonly>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <label class="form-label">Year</label>
                                        <input type="number" name="year_published" id="confirm-year" class="form-control" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <img id="confirm-thumbnail" src="" alt="" class="img-fluid rounded shadow-sm" style="max-height: 180px; display:none;">
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Date Read</label>
                                <input type="date" name="date_read" id="confirm-date" class="form-control">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">My Rating</label>
                                <div class="add-star-rating mt-1" id="confirm-rating-stars">
                                    {% for i in range(1, 6) %}
                                    <i class="bi bi-star star-add-icon" data-value="{{ i }}"
                                       style="cursor: pointer; color: #ffc107; font-size: 1.4rem;"></i>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="my_rating" id="confirm-rating" value="0">
                            </div>
                        </div>
                        <input type="hidden" name="isbn" id="confirm-isbn">
                        <input type="hidden" name="isbn13" id="confirm-isbn13">
                        <input type="hidden" name="average_rating" id="confirm-avg-rating">
                        <input type="hidden" name="shelf" value="read">
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary"><i class="bi bi-plus-lg"></i> 저장</button>
                        </div>
                    </form>
                </div>

                <!-- Loading spinner -->
                <div id="search-loading" style="display:none;" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="text-muted mt-2">검색 중...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Column sorting
(function() {
    const table = document.getElementById('book-table');
    if (!table) return;
    const headers = table.querySelectorAll('th.sortable');
    let currentCol = 3;
    let ascending = false;

    headers.forEach(th => {
        th.addEventListener('click', function() {
            const col = parseInt(this.dataset.col);
            const type = this.dataset.type;

            if (currentCol === col) {
                ascending = !ascending;
            } else {
                ascending = true;
                currentCol = col;
            }

            // Update icons
            headers.forEach(h => {
                h.querySelector('.sort-icon').className = 'bi bi-chevron-expand text-muted sort-icon';
            });
            this.querySelector('.sort-icon').className =
                `bi bi-chevron-${ascending ? 'up' : 'down'} sort-icon`;

            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const aVal = a.children[col].dataset.sort;
                const bVal = b.children[col].dataset.sort;
                let cmp = 0;

                if (type === 'number') {
                    cmp = (parseFloat(aVal) || 0) - (parseFloat(bVal) || 0);
                } else if (type === 'date') {
                    // YYYY/MM/DD format — empty strings sort last
                    const aDate = aVal || (ascending ? '\uffff' : '');
                    const bDate = bVal || (ascending ? '\uffff' : '');
                    cmp = aDate.localeCompare(bDate);
                } else {
                    cmp = aVal.localeCompare(bVal);
                }

                return ascending ? cmp : -cmp;
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });
})();

// Star rating click handler
document.querySelectorAll('.star-rating').forEach(container => {
    container.querySelectorAll('.star-icon').forEach(star => {
        star.addEventListener('click', async function() {
            const bookId = this.parentElement.dataset.bookId;
            const value = parseInt(this.dataset.value);
            const currentRating = parseInt(this.parentElement.dataset.rating);
            const newRating = (value === currentRating) ? 0 : value;

            const resp = await fetch(`/api/books/${bookId}/rate`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({rating: newRating})
            });
            if (resp.ok) {
                this.parentElement.dataset.rating = newRating;
                // Update data-sort on the td for sorting
                this.closest('td').dataset.sort = newRating;
                this.parentElement.querySelectorAll('.star-icon').forEach((s, idx) => {
                    s.className = `bi bi-star${idx < newRating ? '-fill' : ''} star-icon`;
                });
            }
        });
    });
});

// Hall of Fame toggle
document.querySelectorAll('.btn-hall-of-fame').forEach(btn => {
    btn.addEventListener('click', async function() {
        const bookId = this.dataset.bookId;
        const current = this.dataset.hof === '1';
        const resp = await fetch(`/api/books/${bookId}/hall-of-fame`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({hall_of_fame: !current})
        });
        if (resp.ok) {
            const data = await resp.json();
            this.dataset.hof = data.hall_of_fame ? '1' : '0';
            const icon = this.querySelector('i');
            if (data.hall_of_fame) {
                icon.className = 'bi bi-trophy-fill';
                this.className = 'btn btn-sm btn-hall-of-fame btn-warning';
            } else {
                icon.className = 'bi bi-trophy';
                this.className = 'btn btn-sm btn-hall-of-fame btn-outline-secondary';
            }
        }
    });
});

// Delete book
document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', async function() {
        if (!confirm('Delete this book?')) return;
        const bookId = this.dataset.bookId;
        const resp = await fetch(`/api/books/${bookId}/delete`, {method: 'POST'});
        if (resp.ok) {
            this.closest('tr').remove();
        }
    });
});

// Search filter
document.getElementById('search-input').addEventListener('input', function() {
    const q = this.value.toLowerCase();
    document.querySelectorAll('.book-row').forEach(row => {
        const match = row.dataset.title.includes(q) || row.dataset.author.includes(q);
        row.style.display = match ? '' : 'none';
    });
});

// === Add Book Wizard ===
(function() {
    const phaseSearch = document.getElementById('phase-search');
    const phaseResults = document.getElementById('phase-results');
    const phaseConfirm = document.getElementById('phase-confirm');
    const loading = document.getElementById('search-loading');

    const phaseStep = {search: 1, loading: 1, results: 2, confirm: 3};
    function showPhase(phase) {
        phaseSearch.style.display = phase === 'search' ? '' : 'none';
        phaseResults.style.display = phase === 'results' ? '' : 'none';
        phaseConfirm.style.display = phase === 'confirm' ? '' : 'none';
        loading.style.display = phase === 'loading' ? '' : 'none';
        const step = phaseStep[phase] || 1;
        document.querySelectorAll('.wizard-step').forEach(el => {
            el.classList.toggle('active', parseInt(el.dataset.step) === step);
        });
    }

    // Reset on modal open
    document.getElementById('addBookModal').addEventListener('show.bs.modal', function() {
        showPhase('search');
        document.getElementById('book-search-input').value = '';
        resetConfirmForm();
    });

    // Phase 1: Search
    document.getElementById('book-search-btn').addEventListener('click', doSearch);
    document.getElementById('book-search-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); doSearch(); }
    });

    async function doSearch() {
        const q = document.getElementById('book-search-input').value.trim();
        if (!q) return;
        showPhase('loading');

        try {
            const resp = await fetch(`/api/books/search?q=${encodeURIComponent(q)}`);
            const data = await resp.json();
            renderResults(q, data.results || []);
        } catch {
            renderResults(q, []);
        }
    }

    function renderResults(query, results) {
        document.getElementById('results-query').textContent = `"${query}" 검색 결과 (${results.length}건)`;
        const container = document.getElementById('search-results');
        const noResults = document.getElementById('no-results');
        container.innerHTML = '';

        if (results.length === 0) {
            container.style.display = 'none';
            noResults.style.display = '';
            showPhase('results');
            return;
        }

        container.style.display = '';
        noResults.style.display = 'none';

        results.forEach(book => {
            const div = document.createElement('div');
            div.className = 'card mb-2 book-result-card';
            div.style.cursor = 'pointer';
            div.innerHTML = `
                <div class="card-body p-2 d-flex align-items-center">
                    <div style="width: 45px; min-width: 45px; height: 65px; margin-right: 12px;" class="d-flex align-items-center justify-content-center">
                        ${book.thumbnail
                            ? `<img src="${book.thumbnail}" style="max-height: 65px; max-width: 45px; border-radius: 3px;" alt="">`
                            : `<i class="bi bi-book text-muted" style="font-size: 1.5rem;"></i>`}
                    </div>
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="fw-bold text-truncate">${escapeHtml(book.title)}</div>
                        <small class="text-muted">${escapeHtml(book.author || 'Unknown')}</small>
                        ${book.publisher ? `<small class="text-muted"> · ${escapeHtml(book.publisher)}</small>` : ''}
                        ${book.year_published ? `<small class="text-muted"> · ${book.year_published}</small>` : ''}
                    </div>
                </div>
            `;
            div.addEventListener('click', () => selectBook(book));
            container.appendChild(div);
        });

        showPhase('results');
    }

    // Phase 2 → Phase 3: Select a book
    function selectBook(book) {
        document.getElementById('confirm-title').value = book.title || '';
        document.getElementById('confirm-title').readOnly = true;
        document.getElementById('confirm-author').value = book.author || '';
        document.getElementById('confirm-author').readOnly = true;
        document.getElementById('confirm-publisher').value = book.publisher || '';
        document.getElementById('confirm-year').value = book.year_published || '';
        document.getElementById('confirm-isbn').value = book.isbn || '';
        document.getElementById('confirm-isbn13').value = book.isbn13 || '';
        document.getElementById('confirm-avg-rating').value = book.average_rating || 0;

        const thumb = document.getElementById('confirm-thumbnail');
        if (book.thumbnail) {
            thumb.src = book.thumbnail;
            thumb.style.display = '';
        } else {
            thumb.style.display = 'none';
        }

        document.getElementById('confirm-date').value = '';
        setAddRating(0);
        showPhase('confirm');
    }

    // Manual entry
    function openManualEntry() {
        resetConfirmForm();
        document.getElementById('confirm-title').readOnly = false;
        document.getElementById('confirm-author').readOnly = false;
        document.getElementById('confirm-publisher').readOnly = false;
        document.getElementById('confirm-year').readOnly = false;
        showPhase('confirm');
    }

    document.getElementById('manual-entry-link').addEventListener('click', function(e) {
        e.preventDefault();
        openManualEntry();
    });
    document.getElementById('manual-entry-btn').addEventListener('click', openManualEntry);

    // Back buttons
    document.getElementById('back-to-search').addEventListener('click', () => showPhase('search'));
    document.getElementById('back-to-results').addEventListener('click', () => showPhase('results'));

    // Star rating in confirm form
    const ratingStars = document.querySelectorAll('.star-add-icon');
    ratingStars.forEach(star => {
        star.addEventListener('click', function() {
            const val = parseInt(this.dataset.value);
            const current = parseInt(document.getElementById('confirm-rating').value);
            setAddRating(val === current ? 0 : val);
        });
    });

    function setAddRating(val) {
        document.getElementById('confirm-rating').value = val;
        ratingStars.forEach((s, idx) => {
            s.className = `bi bi-star${idx < val ? '-fill' : ''} star-add-icon`;
        });
    }

    function resetConfirmForm() {
        ['confirm-title', 'confirm-author', 'confirm-publisher', 'confirm-isbn', 'confirm-isbn13'].forEach(id => {
            document.getElementById(id).value = '';
        });
        document.getElementById('confirm-year').value = '';
        document.getElementById('confirm-avg-rating').value = '0';
        document.getElementById('confirm-date').value = '';
        document.getElementById('confirm-thumbnail').style.display = 'none';
        setAddRating(0);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
})();
</script>
{% endblock %}
